<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ä¿¡å·é‡ # ä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ˜¯ä¸€ç§ç”¨äºå®ç°å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ä¹‹é—´åŒæ­¥å’Œäº’æ–¥çš„æœºåˆ¶ã€‚
ä¿¡å·é‡å¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªæ•´å‹æ•°ï¼ŒåŒ…å«ä¸¤ç§æ“ä½œï¼šPï¼ˆProberenï¼Œæµ‹è¯•ï¼‰æ“ä½œå’Œ Vï¼ˆVerhogenï¼Œå¢åŠ ï¼‰æ“ä½œã€‚å…¶ä¸­ï¼ŒP æ“ä½œä¼šå°è¯•è·å–ä¸€ä¸ªä¿¡å·é‡ï¼Œå¦‚æœä¿¡å·é‡çš„å€¼å¤§äº 0ï¼Œåˆ™å°†ä¿¡å·é‡çš„å€¼å‡ 1 å¹¶ ç»§ç»­æ‰§è¡Œã€‚å¦åˆ™ï¼Œå½“å‰è¿›ç¨‹æˆ–çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰å…¶ä»–è¿›ç¨‹æˆ–çº¿ç¨‹é‡Šæ”¾è¿™ä¸ªä¿¡å·é‡ä¸ºæ­¢ã€‚V æ“ä½œåˆ™æ˜¯é‡Šæ”¾ä¸€ä¸ªä¿¡å·é‡ï¼Œå°†ä¿¡å·é‡çš„å€¼åŠ  1ã€‚
P æ“ä½œå’Œ V æ“ä½œå¯ä»¥çœ‹åšæ˜¯å¯¹èµ„æºçš„è·å–å’Œé‡Šæ”¾ã€‚
Go çš„ WaitGroup å’Œ Metux éƒ½æ˜¯é€šè¿‡ä¿¡å·é‡æ¥æ§åˆ¶ goroutine çš„é˜»å¡å’Œå”¤é†’ï¼Œä¾‹å¦‚ Mutex ç»“æ„ä½“ä¸­çš„ semaï¼š
type Mutex struct { state int32 sema uint32 } Metux æœ¬è´¨ä¸Šå°±æ˜¯åŸºäºä¿¡å·é‡ï¼ˆsemaï¼‰+ åŸå­æ“ä½œæ¥å®ç°å¹¶å‘æ§åˆ¶çš„ã€‚
Go æ“ä½œä¿¡å·é‡çš„æ–¹æ³•ï¼š
// src/sync/runtime.go // é˜»å¡ç­‰å¾…ç›´åˆ° s å¤§äº 0ï¼Œç„¶åç«‹åˆ»å°† s å‡å» 1 func runtime_Semacquire(s *uint32) // ç±»ä¼¼äº runtime_Semacquire // å¦‚æœ lifo ä¸º trueï¼Œwaiter å°†ä¼šè¢«æ’å…¥åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œå¦åˆ™æ’å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ // skipframes æ˜¯è·Ÿè¸ªè¿‡ç¨‹ä¸­è¦çœç•¥çš„å¸§æ•°ï¼Œä»è¿™é‡Œå¼€å§‹è®¡ç®— func runtime_SemacquireMutex(s *uint32, lifo bool, skipframes int) // å°† s å¢åŠ  1ï¼Œç„¶åé€šçŸ¥é˜»å¡åœ¨ runtime_Semacquire çš„ goroutine // å¦‚æœ handoff ä¸º trueï¼Œä¼ é€’ä¿¡å·åˆ°é˜Ÿåˆ—å¤´éƒ¨çš„ waiter // skipframes æ˜¯è·Ÿè¸ªè¿‡ç¨‹ä¸­è¦çœç•¥çš„å¸§æ•°ï¼Œä»è¿™é‡Œå¼€å§‹è®¡ç®— func runtime_Semrelease(s *uint32, handoff bool, skipframes int) Acquire å’Œ Release åˆ†åˆ«å¯¹åº”äº† P æ“ä½œå’Œ V æ“ä½œã€‚"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="ä¿¡å·é‡"><meta property="og:description" content="ä¿¡å·é‡ # ä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ˜¯ä¸€ç§ç”¨äºå®ç°å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ä¹‹é—´åŒæ­¥å’Œäº’æ–¥çš„æœºåˆ¶ã€‚
ä¿¡å·é‡å¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªæ•´å‹æ•°ï¼ŒåŒ…å«ä¸¤ç§æ“ä½œï¼šPï¼ˆProberenï¼Œæµ‹è¯•ï¼‰æ“ä½œå’Œ Vï¼ˆVerhogenï¼Œå¢åŠ ï¼‰æ“ä½œã€‚å…¶ä¸­ï¼ŒP æ“ä½œä¼šå°è¯•è·å–ä¸€ä¸ªä¿¡å·é‡ï¼Œå¦‚æœä¿¡å·é‡çš„å€¼å¤§äº 0ï¼Œåˆ™å°†ä¿¡å·é‡çš„å€¼å‡ 1 å¹¶ ç»§ç»­æ‰§è¡Œã€‚å¦åˆ™ï¼Œå½“å‰è¿›ç¨‹æˆ–çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰å…¶ä»–è¿›ç¨‹æˆ–çº¿ç¨‹é‡Šæ”¾è¿™ä¸ªä¿¡å·é‡ä¸ºæ­¢ã€‚V æ“ä½œåˆ™æ˜¯é‡Šæ”¾ä¸€ä¸ªä¿¡å·é‡ï¼Œå°†ä¿¡å·é‡çš„å€¼åŠ  1ã€‚
P æ“ä½œå’Œ V æ“ä½œå¯ä»¥çœ‹åšæ˜¯å¯¹èµ„æºçš„è·å–å’Œé‡Šæ”¾ã€‚
Go çš„ WaitGroup å’Œ Metux éƒ½æ˜¯é€šè¿‡ä¿¡å·é‡æ¥æ§åˆ¶ goroutine çš„é˜»å¡å’Œå”¤é†’ï¼Œä¾‹å¦‚ Mutex ç»“æ„ä½“ä¸­çš„ semaï¼š
type Mutex struct { state int32 sema uint32 } Metux æœ¬è´¨ä¸Šå°±æ˜¯åŸºäºä¿¡å·é‡ï¼ˆsemaï¼‰+ åŸå­æ“ä½œæ¥å®ç°å¹¶å‘æ§åˆ¶çš„ã€‚
Go æ“ä½œä¿¡å·é‡çš„æ–¹æ³•ï¼š
// src/sync/runtime.go // é˜»å¡ç­‰å¾…ç›´åˆ° s å¤§äº 0ï¼Œç„¶åç«‹åˆ»å°† s å‡å» 1 func runtime_Semacquire(s *uint32) // ç±»ä¼¼äº runtime_Semacquire // å¦‚æœ lifo ä¸º trueï¼Œwaiter å°†ä¼šè¢«æ’å…¥åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œå¦åˆ™æ’å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ // skipframes æ˜¯è·Ÿè¸ªè¿‡ç¨‹ä¸­è¦çœç•¥çš„å¸§æ•°ï¼Œä»è¿™é‡Œå¼€å§‹è®¡ç®— func runtime_SemacquireMutex(s *uint32, lifo bool, skipframes int) // å°† s å¢åŠ  1ï¼Œç„¶åé€šçŸ¥é˜»å¡åœ¨ runtime_Semacquire çš„ goroutine // å¦‚æœ handoff ä¸º trueï¼Œä¼ é€’ä¿¡å·åˆ°é˜Ÿåˆ—å¤´éƒ¨çš„ waiter // skipframes æ˜¯è·Ÿè¸ªè¿‡ç¨‹ä¸­è¦çœç•¥çš„å¸§æ•°ï¼Œä»è¿™é‡Œå¼€å§‹è®¡ç®— func runtime_Semrelease(s *uint32, handoff bool, skipframes int) Acquire å’Œ Release åˆ†åˆ«å¯¹åº”äº† P æ“ä½œå’Œ V æ“ä½œã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://shipengqi.github.io/golang-learn/docs/concurrency/10_sema/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-11-06T14:16:11+08:00"><title>ä¿¡å·é‡ | Go Learning</title><link rel=manifest href=/golang-learn/manifest.json><link rel=icon href=/golang-learn/favicon.png><link rel=stylesheet href=/golang-learn/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/golang-learn/flexsearch.min.js></script>
<script defer src=/golang-learn/en.search.min.85ac43de481b0867c3ed54a5a2263e836d58519eeddb4df16af262f7ed157d12.js integrity="sha256-haxD3kgbCGfD7VSloiY+g21YUZ7t203xavJi9+0VfRI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/golang-learn/><span>Go Learning</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://shipengqi.github.io/ target=_blank rel=noopener>Blog</a></li><li><a href=https://github.com/shipengqi/golang-learn target=_blank rel=noopener>Github</a></li></ul><ul><li><span>ğŸš è¯­è¨€åŸºç¡€</span><ul><li><a href=/golang-learn/docs/basic/01_basic_type/>åŸºç¡€æ•°æ®ç±»å‹</a></li><li><a href=/golang-learn/docs/basic/02_array/>æ•°ç»„</a></li><li><a href=/golang-learn/docs/basic/03_slice/>åˆ‡ç‰‡</a></li><li><a href=/golang-learn/docs/basic/04_map/>å“ˆå¸Œè¡¨</a></li><li><a href=/golang-learn/docs/basic/05_function/>å‡½æ•°</a></li><li><a href=/golang-learn/docs/basic/09_pointer/>æŒ‡é’ˆ</a></li></ul></li><li><a href=/golang-learn/docs/concurrency/>âš¡ å¹¶å‘ç¼–ç¨‹</a><ul><li><a href=/golang-learn/docs/concurrency/01_mutex/>äº’æ–¥é”</a></li><li><a href=/golang-learn/docs/concurrency/02_rwmutex/>è¯»å†™é”</a></li><li><a href=/golang-learn/docs/concurrency/03_waitgroup/>WaitGroup</a></li><li><a href=/golang-learn/docs/concurrency/04_cond/>æ¡ä»¶å˜é‡</a></li><li><a href=/golang-learn/docs/concurrency/05_once/>Once</a></li><li><a href=/golang-learn/docs/concurrency/06_pool/>Pool</a></li><li><a href=/golang-learn/docs/concurrency/07_context/>Context</a></li><li><a href=/golang-learn/docs/concurrency/08_atomic/>åŸå­æ“ä½œ</a></li><li><a href=/golang-learn/docs/concurrency/09_channel/>Channel</a></li><li><a href=/golang-learn/docs/concurrency/10_sema/ class=active>ä¿¡å·é‡</a></li><li><a href=/golang-learn/docs/concurrency/11_singleflight/>SingleFlight</a></li><li><a href=/golang-learn/docs/concurrency/12_errorgroup/>ErrGroup</a></li></ul></li><li><span>ğŸ› ï¸ å®è·µ</span><ul><li><a href=/golang-learn/docs/practice/01_build/>Go ç¼–è¯‘</a></li><li><a href=/golang-learn/docs/practice/02_go_race/>Go æ•°æ®ç«äº‰æ£€æµ‹å™¨</a></li><li><a href=/golang-learn/docs/practice/05_performance/>Go æ€§èƒ½ä¼˜åŒ–</a></li><li><a href=/golang-learn/docs/practice/07_coredump/>Go Core Dump è°ƒè¯•</a></li><li><a href=/golang-learn/docs/practice/08_mod/>Go Modules</a></li><li><a href=/golang-learn/docs/practice/09_gin/>Gin é™æ€æœåŠ¡å™¨</a></li></ul></li><li><span>ğŸ› ï¸ Go å·¥ç¨‹å®è·µ</span><ul><li><a href=/golang-learn/docs/project/01_specs/>é¡¹ç›®è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/02_structure/>é¡¹ç›®çš„ç›®å½•ç»“æ„</a></li><li><a href=/golang-learn/docs/project/03_code/>ä»£ç è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/04_commitizen/>Commit è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/05_version/>ç‰ˆæœ¬è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/06_api_doc/>API æ–‡æ¡£</a></li><li><a href=/golang-learn/docs/project/07_flow/>Git å·¥ä½œæµç¨‹</a></li><li><a href=/golang-learn/docs/project/08_make/>é¡¹ç›®ç®¡ç†</a></li><li><a href=/golang-learn/docs/project/09_actions/>GitHub Actions</a></li><li><a href=/golang-learn/docs/project/10_dependabot/>GitHub Dependabot</a></li><li><a href=/golang-learn/docs/project/11_templates/>GitHub æ¨¡æ¿</a></li><li><a href=/golang-learn/docs/project/12_goreleaser/>GoReleaser</a></li></ul></li><li><a href=/golang-learn/docs/advance/>ğŸ” åº•å±‚åŸç†</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/golang-learn/svg/menu.svg class=book-icon alt=Menu></label>
<strong>ä¿¡å·é‡</strong>
<label for=toc-control><img src=/golang-learn/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#ä¿¡å·é‡>ä¿¡å·é‡</a><ul><li><a href=#acquire-ä¿¡å·é‡>Acquire ä¿¡å·é‡</a></li><li><a href=#release-ä¿¡å·é‡>Release ä¿¡å·é‡</a></li><li><a href=#semaphore-æ‰©å±•åº“>semaphore æ‰©å±•åº“</a><ul><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a></li><li><a href=#åŸç†>åŸç†</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=ä¿¡å·é‡>ä¿¡å·é‡
<a class=anchor href=#%e4%bf%a1%e5%8f%b7%e9%87%8f>#</a></h1><p>ä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ˜¯ä¸€ç§ç”¨äºå®ç°å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ä¹‹é—´åŒæ­¥å’Œäº’æ–¥çš„æœºåˆ¶ã€‚</p><p>ä¿¡å·é‡å¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªæ•´å‹æ•°ï¼ŒåŒ…å«ä¸¤ç§æ“ä½œï¼š<code>P</code>ï¼ˆProberenï¼Œæµ‹è¯•ï¼‰æ“ä½œå’Œ <code>V</code>ï¼ˆVerhogenï¼Œå¢åŠ ï¼‰æ“ä½œã€‚å…¶ä¸­ï¼Œ<code>P</code> æ“ä½œä¼šå°è¯•è·å–ä¸€ä¸ªä¿¡å·é‡ï¼Œå¦‚æœä¿¡å·é‡çš„å€¼å¤§äº 0ï¼Œåˆ™å°†ä¿¡å·é‡çš„å€¼å‡ 1 å¹¶
ç»§ç»­æ‰§è¡Œã€‚å¦åˆ™ï¼Œå½“å‰è¿›ç¨‹æˆ–çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰å…¶ä»–è¿›ç¨‹æˆ–çº¿ç¨‹é‡Šæ”¾è¿™ä¸ªä¿¡å·é‡ä¸ºæ­¢ã€‚V æ“ä½œåˆ™æ˜¯é‡Šæ”¾ä¸€ä¸ªä¿¡å·é‡ï¼Œå°†ä¿¡å·é‡çš„å€¼åŠ  1ã€‚</p><p><code>P</code> æ“ä½œå’Œ <code>V</code> æ“ä½œå¯ä»¥çœ‹åšæ˜¯å¯¹èµ„æºçš„è·å–å’Œé‡Šæ”¾ã€‚</p><p>Go çš„ <code>WaitGroup</code> å’Œ <code>Metux</code> éƒ½æ˜¯é€šè¿‡ä¿¡å·é‡æ¥æ§åˆ¶ goroutine çš„é˜»å¡å’Œå”¤é†’ï¼Œä¾‹å¦‚ <code>Mutex</code> ç»“æ„ä½“ä¸­çš„ <code>sema</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Mutex</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sema</span>  <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Metux</code> æœ¬è´¨ä¸Šå°±æ˜¯åŸºäºä¿¡å·é‡ï¼ˆsemaï¼‰+ åŸå­æ“ä½œæ¥å®ç°å¹¶å‘æ§åˆ¶çš„ã€‚</p><p>Go æ“ä½œä¿¡å·é‡çš„æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/sync/runtime.go
</span></span></span><span style=display:flex><span><span style=color:#75715e>// é˜»å¡ç­‰å¾…ç›´åˆ° s å¤§äº 0ï¼Œç„¶åç«‹åˆ»å°† s å‡å» 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>runtime_Semacquire</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç±»ä¼¼äº runtime_Semacquire
</span></span></span><span style=display:flex><span><span style=color:#75715e>// å¦‚æœ lifo ä¸º trueï¼Œwaiter å°†ä¼šè¢«æ’å…¥åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œå¦åˆ™æ’å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>// skipframes æ˜¯è·Ÿè¸ªè¿‡ç¨‹ä¸­è¦çœç•¥çš„å¸§æ•°ï¼Œä»è¿™é‡Œå¼€å§‹è®¡ç®—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>runtime_SemacquireMutex</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>, <span style=color:#a6e22e>lifo</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>skipframes</span> <span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å°† s å¢åŠ  1ï¼Œç„¶åé€šçŸ¥é˜»å¡åœ¨ runtime_Semacquire çš„ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e>// å¦‚æœ handoff ä¸º trueï¼Œä¼ é€’ä¿¡å·åˆ°é˜Ÿåˆ—å¤´éƒ¨çš„ waiter
</span></span></span><span style=display:flex><span><span style=color:#75715e>// skipframes æ˜¯è·Ÿè¸ªè¿‡ç¨‹ä¸­è¦çœç•¥çš„å¸§æ•°ï¼Œä»è¿™é‡Œå¼€å§‹è®¡ç®—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>runtime_Semrelease</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>, <span style=color:#a6e22e>handoff</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>skipframes</span> <span style=color:#66d9ef>int</span>)
</span></span></code></pre></div><p>Acquire å’Œ Release åˆ†åˆ«å¯¹åº”äº† <code>P</code> æ“ä½œå’Œ <code>V</code> æ“ä½œã€‚</p><h2 id=acquire-ä¿¡å·é‡>Acquire ä¿¡å·é‡
<a class=anchor href=#acquire-%e4%bf%a1%e5%8f%b7%e9%87%8f>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/sema.go
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:linkname sync_runtime_Semacquire sync.runtime_Semacquire
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sync_runtime_Semacquire</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semacquire1</span>(<span style=color:#a6e22e>addr</span>, <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>semaBlockProfile</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>waitReasonSemacquire</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//go:linkname sync_runtime_SemacquireMutex sync.runtime_SemacquireMutex
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sync_runtime_SemacquireMutex</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>, <span style=color:#a6e22e>lifo</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>skipframes</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semacquire1</span>(<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>lifo</span>, <span style=color:#a6e22e>semaBlockProfile</span>|<span style=color:#a6e22e>semaMutexProfile</span>, <span style=color:#a6e22e>skipframes</span>, <span style=color:#a6e22e>waitReasonSyncMutexLock</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>runtime_Semacquire</code> å’Œ <code>runtime_SemacquireMutex</code> æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨äº† <code>semacquire1</code> å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>semacquire1</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>, <span style=color:#a6e22e>lifo</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>profile</span> <span style=color:#a6e22e>semaProfileFlags</span>, <span style=color:#a6e22e>skipframes</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>reason</span> <span style=color:#a6e22e>waitReason</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>curg</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;semacquire not on the G stack&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Easy case.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// ä¿¡å·é‡å¤§äº 0ï¼Œç›´æ¥è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cansemacquire</span>(<span style=color:#a6e22e>addr</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Harder case:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// æ„é€ ä¸€ä¸ª sudog
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquireSudog</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å°†ä¿¡å·é‡çš„åœ°å€æ”¾åˆ°åˆ° semtable ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// è¿”å›ä¸€ä¸ª semaRoot ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>root</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>semtable</span>.<span style=color:#a6e22e>rootFor</span>(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t0</span> <span style=color:#f92672>:=</span> int64(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>acquiretime</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>ticket</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lockWithRank</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>lockRankRoot</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ç­‰å¾…è®¡æ•° +1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>nwait</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å†æ¬¡æ£€æŸ¥ä¿¡å·é‡æ˜¯å¦å¤§äº 0ï¼Œé¿å…é”™è¯¯å”¤é†’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cansemacquire</span>(<span style=color:#a6e22e>addr</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>nwait</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å°†å½“å‰ goroutine æ”¾å…¥åˆ° semaRoot çš„ç­‰å¾…è€…é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>queue</span>(<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>lifo</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// æŒ‚èµ·å½“å‰ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>goparkunlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>reason</span>, <span style=color:#a6e22e>traceBlockSync</span>, <span style=color:#ae81ff>4</span><span style=color:#f92672>+</span><span style=color:#a6e22e>skipframes</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>ticket</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>cansemacquire</span>(<span style=color:#a6e22e>addr</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>releasetime</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>blockevent</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>releasetime</span><span style=color:#f92672>-</span><span style=color:#a6e22e>t0</span>, <span style=color:#ae81ff>3</span><span style=color:#f92672>+</span><span style=color:#a6e22e>skipframes</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releaseSudog</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>cansemacquire</code> å°±æ˜¯åˆ¤æ–­ä¿¡å·é‡çš„å€¼ï¼Œè‹¥ç­‰äº 0ï¼Œåˆ™ç›´æ¥è¿”å› <code>false</code>ï¼Œå¦åˆ™ï¼ŒCAS æ“ä½œä¿¡å·é‡ -1ï¼ŒæˆåŠŸåˆ™è¿”å› <code>true</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>cansemacquire</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ç­‰äº 0ï¼Œè¡¨ç¤ºæ²¡æœ‰èµ„æº
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Cas</span>(<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>v</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>semtable</code> æ˜¯ä¸€ä¸ª <code>semTable</code> ç±»å‹ï¼Œ<code>semTable.rootFor</code> è¿”å›çš„æ˜¯ä¸€ä¸ª <code>semaRoot</code> ç±»å‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/sema.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>semaRoot</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lock</span>  <span style=color:#a6e22e>mutex</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>treap</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>        <span style=color:#75715e>// ç­‰å¾…è€…é˜Ÿåˆ—ï¼ˆå¹³è¡¡æ ‘ï¼‰çš„æ ¹èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>nwait</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Uint32</span> <span style=color:#75715e>// ç­‰å¾…è€…çš„æ•°é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>semtable</span> <span style=color:#a6e22e>semTable</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>semTable</span> [<span style=color:#a6e22e>semTabSize</span>]<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>root</span> <span style=color:#a6e22e>semaRoot</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pad</span>  [<span style=color:#a6e22e>cpu</span>.<span style=color:#a6e22e>CacheLinePadSize</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#a6e22e>semaRoot</span>{})]<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// rootFor æœ¬è´¨ä¸Šå°±æ˜¯å°† semaRoot ä¸ä¿¡å·é‡ç»‘å®š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>semTable</span>) <span style=color:#a6e22e>rootFor</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>semaRoot</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>[(uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>addr</span>))<span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>3</span>)<span style=color:#f92672>%</span><span style=color:#a6e22e>semTabSize</span>].<span style=color:#a6e22e>root</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=release-ä¿¡å·é‡>Release ä¿¡å·é‡
<a class=anchor href=#release-%e4%bf%a1%e5%8f%b7%e9%87%8f>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/sema.go
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:linkname sync_runtime_Semrelease sync.runtime_Semrelease
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sync_runtime_Semrelease</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>, <span style=color:#a6e22e>handoff</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>skipframes</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semrelease1</span>(<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>handoff</span>, <span style=color:#a6e22e>skipframes</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>runtime_Semrelease</code> æœ€ç»ˆæ˜¯è°ƒç”¨äº† <code>semrelease1</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>semrelease1</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint32</span>, <span style=color:#a6e22e>handoff</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>skipframes</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å–å‡ºä¿¡å·é‡å¯¹åº”çš„ semaRoot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>root</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>semtable</span>.<span style=color:#a6e22e>rootFor</span>(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ä¿¡å·é‡ +1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadd</span>(<span style=color:#a6e22e>addr</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Easy case
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// æ²¡æœ‰ç­‰å¾…è€…ï¼Œç›´æ¥è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>nwait</span>.<span style=color:#a6e22e>Load</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Harder case
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lockWithRank</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>lockRankRoot</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å†æ¬¡æ£€æŸ¥ç­‰å¾…è€…è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>nwait</span>.<span style=color:#a6e22e>Load</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// è®¡æ•°å·²ç»è¢«å…¶ä»– goroutine æ¶ˆè´¹ï¼Œä¸éœ€è¦å”¤é†’å…¶ä»– goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// é˜Ÿå½“å‰ä¿¡å·é‡ä¸Šçš„ sudog
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>t0</span>, <span style=color:#a6e22e>tailtime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>dequeue</span>(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ç­‰å¾…è€…è®¡æ•° -1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>nwait</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#75715e>// May be slow or even yield, so unlock first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// å”¤é†’ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>readyWithTime</span>(<span style=color:#a6e22e>s</span>, <span style=color:#ae81ff>5</span><span style=color:#f92672>+</span><span style=color:#a6e22e>skipframes</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>ticket</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>locks</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>goyield</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>readyWithTime</code> çš„å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>readyWithTime</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>, <span style=color:#a6e22e>traceskip</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è®¾ç½® goroutine çš„çŠ¶æ€ä¸º runnable ç­‰å¾…è¢«é‡æ–°è°ƒåº¦
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>traceskip</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=semaphore-æ‰©å±•åº“>semaphore æ‰©å±•åº“
<a class=anchor href=#semaphore-%e6%89%a9%e5%b1%95%e5%ba%93>#</a></h2><p>å‰é¢ Go å¯¹ä¿¡å·é‡çš„å®ç°éƒ½æ˜¯éšè—åœ¨ runtime ä¸­çš„ï¼Œå¹¶æ²¡æœ‰æ ‡å‡†åº“æ¥ä¾›å¤–éƒ¨ä½¿ç”¨ã€‚ä¸è¿‡ Go çš„æ‰©å±•åº“ <code>golang.org/x/sync</code> æä¾›äº† <code>semaphore</code> åŒ…å®ç°çš„ä¿¡å·é‡æ“ä½œã€‚</p><p>ä½¿ç”¨ <code>func NewWeighted(n int64) *Weighted</code> æ¥åˆ›å»ºä¿¡å·é‡ã€‚</p><p><code>Weighted</code> æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>Acquire(ctx contex.Context, n int64) error</code>ï¼šå¯¹åº” <code>P</code> æ“ä½œï¼Œå¯ä»¥ä¸€æ¬¡è·å– n ä¸ªèµ„æºï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿå¤šçš„èµ„æºï¼Œè°ƒç”¨è€…å°±ä¼šè¢«é˜»å¡ã€‚</li><li><code>Release(n int64)</code>ï¼šå¯¹åº” <code>V</code> æ“ä½œï¼Œå¯ä»¥é‡Šæ”¾ n ä¸ªèµ„æºã€‚</li><li><code>TryAcquire(n int64) bool</code>ï¼šå°è¯•è·å– n ä¸ªèµ„æºï¼Œä½†æ˜¯å®ƒä¸ä¼šé˜»å¡ï¼ŒæˆåŠŸè·å– n ä¸ªèµ„æºåˆ™è¿”å› <code>true</code>ã€‚å¦åˆ™ä¸€ä¸ªä¹Ÿä¸è·å–ï¼Œè¿”å› <code>false</code>ã€‚</li></ul><h3 id=ä½¿ç”¨>ä½¿ç”¨
<a class=anchor href=#%e4%bd%bf%e7%94%a8>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxWorkers</span> = <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>GOMAXPROCS</span>(<span style=color:#ae81ff>0</span>)                    <span style=color:#75715e>// worker æ•°é‡å’Œ CPU æ ¸æ•°ä¸€æ ·
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sema</span>       = <span style=color:#a6e22e>semaphore</span>.<span style=color:#a6e22e>NewWeighted</span>(int64(<span style=color:#a6e22e>maxWorkers</span>)) <span style=color:#75715e>// ä¿¡å·é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>task</span>       = make([]<span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>maxWorkers</span><span style=color:#f92672>*</span><span style=color:#ae81ff>4</span>)                <span style=color:#75715e>// ä»»åŠ¡æ•°ï¼Œæ˜¯ worker çš„å››å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>task</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¦‚æœæ²¡æœ‰ worker å¯ç”¨ï¼Œä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°æŸä¸ª worker è¢«é‡Šæ”¾
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sema</span>.<span style=color:#a6e22e>Acquire</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#ae81ff>1</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¯åŠ¨ worker goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sema</span>.<span style=color:#a6e22e>Release</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>) <span style=color:#75715e>// æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶æ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>task</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–æœ€å¤§è®¡æ•°å€¼çš„ä¿¡å·é‡ï¼Œè¿™æ ·èƒ½ç¡®ä¿å‰é¢çš„ worker éƒ½æ‰§è¡Œå®Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sema</span>.<span style=color:#a6e22e>Acquire</span>(<span style=color:#a6e22e>ctx</span>, int64(<span style=color:#a6e22e>maxWorkers</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;è·å–æ‰€æœ‰çš„ worker å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>task</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=åŸç†>åŸç†
<a class=anchor href=#%e5%8e%9f%e7%90%86>#</a></h3><p><code>Weighted</code> æ˜¯ä½¿ç”¨äº’æ–¥é”å’Œ List å®ç°çš„ï¼Œä¿¡å·é‡ <code>semaphore.Weighted</code> çš„ç»“æ„ä½“ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Weighted</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>size</span>    <span style=color:#66d9ef>int64</span>         <span style=color:#75715e>// æœ€å¤§èµ„æºæ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cur</span>     <span style=color:#66d9ef>int64</span>         <span style=color:#75715e>// å½“å‰å·²è¢«ä½¿ç”¨çš„èµ„æº
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mu</span>      <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>    <span style=color:#75715e>// äº’æ–¥é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>waiters</span> <span style=color:#a6e22e>list</span>.<span style=color:#a6e22e>List</span>     <span style=color:#75715e>// ç­‰å¾…è€…é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>List å®ç°äº†ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…è€…çš„é€šçŸ¥æ˜¯é€šè¿‡ channel å®ç°çš„ã€‚</p><p><code>Acquire</code> å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Weighted</span>) <span style=color:#a6e22e>Acquire</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‰©ä½™çš„èµ„æºå¤§äº nï¼Œç›´æ¥è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>size</span><span style=color:#f92672>-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>cur</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>waiters</span>.<span style=color:#a6e22e>Len</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å·²è¢«ä½¿ç”¨çš„èµ„æº +n
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>cur</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¯·æ±‚çš„èµ„æºæ•° n å¤§äºæœ€å¤§çš„èµ„æºæ•° size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> &gt; <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>size</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä¾èµ– ctx çš„çŠ¶æ€è¿”å›ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜èµ„æºä¸è¶³
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŠŠè°ƒç”¨è€…åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// åˆ›å»ºä¸€ä¸ª ready chan,ä»¥ä¾¿è¢«é€šçŸ¥å”¤é†’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ready</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>waiter</span>{<span style=color:#a6e22e>n</span>: <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>ready</span>: <span style=color:#a6e22e>ready</span>}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ’å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œelem æ˜¯æ–°æ’å…¥çš„å…ƒç´ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>waiters</span>.<span style=color:#a6e22e>PushBack</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é˜»å¡ç­‰å¾…ï¼Œç›´åˆ° ctx è¢«å–æ¶ˆæˆ–è€…è¶…æ—¶ï¼Œæˆ–è€…è¢«å”¤é†’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>(): <span style=color:#75715e>// ctx è¢«å–æ¶ˆæˆ–è€…è¶…æ—¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ready</span>: <span style=color:#75715e>// è¢«å”¤é†’äº†ï¼Œé‚£ä¹ˆå°±å¿½ç•¥ ctx çš„çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>err</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span>: 
</span></span><span style=display:flex><span>			<span style=color:#75715e>// s.waiters.Front() å–å‡ºé˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª ç­‰å¾…è€…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>isFront</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>waiters</span>.<span style=color:#a6e22e>Front</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>elem</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ç›´æ¥ç§»é™¤å½“å‰ ç­‰å¾…è€…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>waiters</span>.<span style=color:#a6e22e>Remove</span>(<span style=color:#a6e22e>elem</span>)
</span></span><span style=display:flex><span>            <span style=color:#75715e>// è¿˜æœ‰èµ„æºï¼Œé€šçŸ¥å…¶å®ƒçš„ ç­‰å¾…è€…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isFront</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>size</span> &gt; <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>cur</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>notifyWaiters</span>()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ready</span>: <span style=color:#75715e>// è¢«å”¤é†’äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Release</code> çš„å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Weighted</span>) <span style=color:#a6e22e>Release</span>(<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å·²è¢«ä½¿ç”¨çš„èµ„æº -n
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>cur</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>cur</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>        panic(<span style=color:#e6db74>&#34;semaphore: released more than held&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…è€…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>notifyWaiters</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>notifyWaiters</code> å°±æ˜¯éå†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç­‰å¾…è€…ï¼Œå¦‚æœèµ„æºä¸å¤Ÿï¼Œæˆ–è€…ç­‰å¾…é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œå°±è¿”å›ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Weighted</span>) <span style=color:#a6e22e>notifyWaiters</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>next</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>waiters</span>.<span style=color:#a6e22e>Front</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// æ²¡æœ‰ç­‰å¾…è€…äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>next</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span> <span style=color:#75715e>// No more waiters blocked.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>Value</span>.(<span style=color:#a6e22e>waiter</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// èµ„æºä¸è¶³ï¼Œé€€å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// s.waiters.Front() æ˜¯ä»¥å…ˆå…¥å…ˆå‡ºçš„æ–¹å¼å–å‡ºç­‰å¾…è€…ï¼Œå¦‚æœç¬¬ä¸€ä¸ªç­‰å¾…è€…æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºï¼Œé‚£ä¹ˆé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…è€…éƒ½ä¼šç»§ç»­ç­‰å¾…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>size</span><span style=color:#f92672>-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>cur</span> &lt; <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>n</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// èµ„æºè¶³å¤Ÿ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// å·²è¢«ä½¿ç”¨çš„èµ„æº +n
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>cur</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å°†ç­‰å¾…è€…ç§»å‡ºé˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>waiters</span>.<span style=color:#a6e22e>Remove</span>(<span style=color:#a6e22e>next</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å…³é—­ channelï¼Œå”¤é†’ç­‰å¾…è€…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		close(<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>ready</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/commit/8dd84e00e28127fae659507809861bef11ae174f title='Last modified by PengQi Shi | November 6, 2023' target=_blank rel=noopener><img src=/golang-learn/svg/calendar.svg class=book-icon alt=Calendar>
<span>November 6, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/edit/master/content/docs/concurrency/10_sema.md target=_blank rel=noopener><img src=/golang-learn/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#ä¿¡å·é‡>ä¿¡å·é‡</a><ul><li><a href=#acquire-ä¿¡å·é‡>Acquire ä¿¡å·é‡</a></li><li><a href=#release-ä¿¡å·é‡>Release ä¿¡å·é‡</a></li><li><a href=#semaphore-æ‰©å±•åº“>semaphore æ‰©å±•åº“</a><ul><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a></li><li><a href=#åŸç†>åŸç†</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>