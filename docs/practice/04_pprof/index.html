<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Go æ€§èƒ½åˆ†æ # PProf æ˜¯ Go æä¾›çš„ç”¨äºå¯è§†åŒ–å’Œåˆ†ææ€§èƒ½åˆ†ææ•°æ®çš„å·¥å…·ã€‚
runtime/pprofï¼šé‡‡é›†ç¨‹åºï¼ˆé Serverï¼‰çš„è¿è¡Œæ•°æ®è¿›è¡Œåˆ†æ net/http/pprofï¼šé‡‡é›† HTTP Server çš„è¿è¡Œæ—¶æ•°æ®è¿›è¡Œåˆ†æ ä¸»è¦å¯ä»¥ç”¨äºï¼š
CPU Profilingï¼šCPU åˆ†æï¼ŒæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡é‡‡é›†æ‰€ç›‘å¬çš„åº”ç”¨ç¨‹åº CPUï¼ˆå«å¯„å­˜å™¨ï¼‰çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ç¡®å®šåº”ç”¨ç¨‹åºåœ¨ä¸»åŠ¨æ¶ˆè€— CPU å‘¨æœŸ æ—¶èŠ±è´¹æ—¶é—´çš„ä½ç½®ã€‚ Memory Profilingï¼šå†…å­˜åˆ†æï¼Œåœ¨åº”ç”¨ç¨‹åºè¿›è¡Œå †åˆ†é…æ—¶è®°å½•å †æ ˆè·Ÿè¸ªï¼Œç”¨äºç›‘è§†å½“å‰å’Œå†å²å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠæ£€æŸ¥å†…å­˜æ³„æ¼ã€‚ Block Profilingï¼šé˜»å¡åˆ†æï¼Œè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®ã€‚ Mutex Profilingï¼šäº’æ–¥é”åˆ†æï¼ŒæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µã€‚ æ€§èƒ½åˆ†æ # åˆ†æ HTTP Server # Web # import ( &#34;log&#34; &#34;net/http&#34; _ &#34;net/http/pprof&#34; ) var datas []string func Add(str string) string { data := []byte(str) sData := string(data) datas = append(datas, sData) return sData } func main() { go func() { for { log."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Go æ€§èƒ½åˆ†æ"><meta property="og:description" content="Go æ€§èƒ½åˆ†æ # PProf æ˜¯ Go æä¾›çš„ç”¨äºå¯è§†åŒ–å’Œåˆ†ææ€§èƒ½åˆ†ææ•°æ®çš„å·¥å…·ã€‚
runtime/pprofï¼šé‡‡é›†ç¨‹åºï¼ˆé Serverï¼‰çš„è¿è¡Œæ•°æ®è¿›è¡Œåˆ†æ net/http/pprofï¼šé‡‡é›† HTTP Server çš„è¿è¡Œæ—¶æ•°æ®è¿›è¡Œåˆ†æ ä¸»è¦å¯ä»¥ç”¨äºï¼š
CPU Profilingï¼šCPU åˆ†æï¼ŒæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡é‡‡é›†æ‰€ç›‘å¬çš„åº”ç”¨ç¨‹åº CPUï¼ˆå«å¯„å­˜å™¨ï¼‰çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ç¡®å®šåº”ç”¨ç¨‹åºåœ¨ä¸»åŠ¨æ¶ˆè€— CPU å‘¨æœŸ æ—¶èŠ±è´¹æ—¶é—´çš„ä½ç½®ã€‚ Memory Profilingï¼šå†…å­˜åˆ†æï¼Œåœ¨åº”ç”¨ç¨‹åºè¿›è¡Œå †åˆ†é…æ—¶è®°å½•å †æ ˆè·Ÿè¸ªï¼Œç”¨äºç›‘è§†å½“å‰å’Œå†å²å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠæ£€æŸ¥å†…å­˜æ³„æ¼ã€‚ Block Profilingï¼šé˜»å¡åˆ†æï¼Œè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®ã€‚ Mutex Profilingï¼šäº’æ–¥é”åˆ†æï¼ŒæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µã€‚ æ€§èƒ½åˆ†æ # åˆ†æ HTTP Server # Web # import ( &#34;log&#34; &#34;net/http&#34; _ &#34;net/http/pprof&#34; ) var datas []string func Add(str string) string { data := []byte(str) sData := string(data) datas = append(datas, sData) return sData } func main() { go func() { for { log."><meta property="og:type" content="article"><meta property="og:url" content="https://shipengqi.github.io/golang-learn/docs/practice/04_pprof/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-10-15T17:52:38+08:00"><title>Go æ€§èƒ½åˆ†æ | Go Learning</title><link rel=manifest href=/golang-learn/manifest.json><link rel=icon href=/golang-learn/favicon.png><link rel=stylesheet href=/golang-learn/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/golang-learn/flexsearch.min.js></script>
<script defer src=/golang-learn/en.search.min.ba0b0d3a0587c533dd25391aa4ba8d81cdb07d80534438536c6592a0da5c5caf.js integrity="sha256-ugsNOgWHxTPdJTkapLqNgc2wfYBTRDhTbGWSoNpcXK8=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/golang-learn/><span>Go Learning</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://shipengqi.github.io/ target=_blank rel=noopener>Blog</a></li><li><a href=https://github.com/shipengqi/golang-learn target=_blank rel=noopener>Github</a></li></ul><ul><li><span>ğŸš è¯­è¨€åŸºç¡€</span><ul><li><a href=/golang-learn/docs/basic/01_basic_type/>åŸºç¡€æ•°æ®ç±»å‹</a></li><li><a href=/golang-learn/docs/basic/02_array/>æ•°ç»„</a></li><li><a href=/golang-learn/docs/basic/03_slice/>åˆ‡ç‰‡</a></li><li><a href=/golang-learn/docs/basic/04_map/>å“ˆå¸Œè¡¨</a></li><li><a href=/golang-learn/docs/basic/05_function/>å‡½æ•°</a></li><li><a href=/golang-learn/docs/basic/09_pointer/>æŒ‡é’ˆ</a></li></ul></li><li><a href=/golang-learn/docs/concurrency/>âš¡ å¹¶å‘ç¼–ç¨‹</a><ul><li><a href=/golang-learn/docs/concurrency/01_mutex/>äº’æ–¥é”</a></li><li><a href=/golang-learn/docs/concurrency/02_rwmutex/>è¯»å†™é”</a></li><li><a href=/golang-learn/docs/concurrency/03_waitgroup/>WaitGroup</a></li><li><a href=/golang-learn/docs/concurrency/04_cond/>æ¡ä»¶å˜é‡</a></li><li><a href=/golang-learn/docs/concurrency/05_once/>Once</a></li><li><a href=/golang-learn/docs/concurrency/06_pool/>Pool</a></li><li><a href=/golang-learn/docs/concurrency/07_context/>Context</a></li><li><a href=/golang-learn/docs/concurrency/08_atomic/>åŸå­æ“ä½œ</a></li><li><a href=/golang-learn/docs/concurrency/09_channel/>Channel</a></li><li><a href=/golang-learn/docs/concurrency/10_sema/>ä¿¡å·é‡</a></li><li><a href=/golang-learn/docs/concurrency/11_singleflight/>SingleFlight</a></li><li><a href=/golang-learn/docs/concurrency/12_errorgroup/>ErrGroup</a></li></ul></li><li><span>ğŸ› ï¸ å®è·µ</span><ul><li><a href=/golang-learn/docs/practice/01_build/>Go ç¼–è¯‘</a></li><li><a href=/golang-learn/docs/practice/02_go_race/>Go æ•°æ®ç«äº‰æ£€æµ‹å™¨</a></li><li><a href=/golang-learn/docs/practice/04_pprof/ class=active>Go æ€§èƒ½åˆ†æ</a></li><li><a href=/golang-learn/docs/practice/05_performance/>Go æ€§èƒ½ä¼˜åŒ–</a></li><li><a href=/golang-learn/docs/practice/06_trace/>Go Trace</a></li><li><a href=/golang-learn/docs/practice/07_coredump/>Go CoreDump è°ƒè¯•</a></li><li><a href=/golang-learn/docs/practice/08_mod/>Go Modules</a></li><li><a href=/golang-learn/docs/practice/09_gin/>Gin é™æ€æœåŠ¡å™¨</a></li></ul></li><li><span>ğŸ› ï¸ Go å·¥ç¨‹å®è·µ</span><ul><li><a href=/golang-learn/docs/project/01_structure/>é¡¹ç›®çš„ç›®å½•ç»“æ„</a></li><li><a href=/golang-learn/docs/project/02_commitizen/>Commit è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/03_gsemver/>ç‰ˆæœ¬è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/04_flow/>Git å·¥ä½œæµç¨‹</a></li><li><a href=/golang-learn/docs/project/05_api/>API é£æ ¼</a></li><li><a href=/golang-learn/docs/project/06_api_doc/>API æ–‡æ¡£</a></li><li><a href=/golang-learn/docs/project/07_make/>make</a></li><li><a href=/golang-learn/docs/project/08_github_actions/>åŸºäº GitHub Actions çš„ CI/CD</a></li></ul></li><li><a href=/golang-learn/docs/advance/>ğŸ” åº•å±‚åŸç†</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/golang-learn/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Go æ€§èƒ½åˆ†æ</strong>
<label for=toc-control><img src=/golang-learn/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#go-æ€§èƒ½åˆ†æ>Go æ€§èƒ½åˆ†æ</a><ul><li><a href=#æ€§èƒ½åˆ†æ>æ€§èƒ½åˆ†æ</a><ul><li><a href=#åˆ†æ-http-server>åˆ†æ HTTP Server</a></li></ul></li><li><a href=#pprof-å¯è§†åŒ–ç•Œé¢>PProf å¯è§†åŒ–ç•Œé¢</a><ul><li><a href=#å®‰è£-graphviz>å®‰è£ Graphviz</a></li><li><a href=#é…ç½®ç¯å¢ƒå˜é‡>é…ç½®ç¯å¢ƒå˜é‡</a></li><li><a href=#éªŒè¯>éªŒè¯</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=go-æ€§èƒ½åˆ†æ>Go æ€§èƒ½åˆ†æ
<a class=anchor href=#go-%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90>#</a></h1><p>PProf æ˜¯ Go æä¾›çš„ç”¨äºå¯è§†åŒ–å’Œåˆ†ææ€§èƒ½åˆ†ææ•°æ®çš„å·¥å…·ã€‚</p><ul><li><code>runtime/pprof</code>ï¼šé‡‡é›†ç¨‹åºï¼ˆé Serverï¼‰çš„è¿è¡Œæ•°æ®è¿›è¡Œåˆ†æ</li><li><code>net/http/pprof</code>ï¼šé‡‡é›† HTTP Server çš„è¿è¡Œæ—¶æ•°æ®è¿›è¡Œåˆ†æ</li></ul><p>ä¸»è¦å¯ä»¥ç”¨äºï¼š</p><ul><li>CPU Profilingï¼šCPU åˆ†æï¼ŒæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡é‡‡é›†æ‰€ç›‘å¬çš„åº”ç”¨ç¨‹åº CPUï¼ˆå«å¯„å­˜å™¨ï¼‰çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ç¡®å®šåº”ç”¨ç¨‹åºåœ¨ä¸»åŠ¨æ¶ˆè€— CPU å‘¨æœŸ
æ—¶èŠ±è´¹æ—¶é—´çš„ä½ç½®ã€‚</li><li>Memory Profilingï¼šå†…å­˜åˆ†æï¼Œåœ¨åº”ç”¨ç¨‹åºè¿›è¡Œå †åˆ†é…æ—¶è®°å½•å †æ ˆè·Ÿè¸ªï¼Œç”¨äºç›‘è§†å½“å‰å’Œå†å²å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠæ£€æŸ¥å†…å­˜æ³„æ¼ã€‚</li><li>Block Profilingï¼šé˜»å¡åˆ†æï¼Œè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®ã€‚</li><li>Mutex Profilingï¼šäº’æ–¥é”åˆ†æï¼ŒæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µã€‚</li></ul><h2 id=æ€§èƒ½åˆ†æ>æ€§èƒ½åˆ†æ
<a class=anchor href=#%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90>#</a></h2><h3 id=åˆ†æ-http-server>åˆ†æ HTTP Server
<a class=anchor href=#%e5%88%86%e6%9e%90-http-server>#</a></h3><h4 id=web>Web
<a class=anchor href=#web>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;net/http/pprof&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>datas</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>str</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#a6e22e>str</span>)
</span></span><span style=display:flex><span> <span style=color:#a6e22e>sData</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span> <span style=color:#a6e22e>datas</span> = append(<span style=color:#a6e22e>datas</span>, <span style=color:#a6e22e>sData</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sData</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;https://github.com/shipengqi&#34;</span>))
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span> }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;0.0.0.0:8080&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ³¨æ„è¦å¼•å…¥ <code>_ "net/http/pprof"</code>ï¼Œè¿™æ ·ç¨‹åºè¿è¡Œä»¥åï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ  <code>/debug/pprof</code> çš„è·¯ç”±ï¼Œå¯ä»¥
è®¿é—® <code>ttp://127.0.0.1:8080/debug/pprof/</code>ã€‚</p><p><img src=../imgs/profile1.png alt=profile></p><ul><li>alloc: æŸ¥çœ‹æ‰€æœ‰å†…å­˜åˆ†é…çš„æƒ…å†µ</li><li>blockï¼ˆBlock Profilingï¼‰ï¼š<code>$HOST/debug/pprof/block</code>ï¼ŒæŸ¥çœ‹å¯¼è‡´é˜»å¡åŒæ­¥çš„å †æ ˆè·Ÿè¸ª</li><li>cmdline : å½“å‰ç¨‹åºçš„å‘½ä»¤è¡Œè°ƒç”¨</li><li>goroutineï¼š<code>$HOST/debug/pprof/goroutine</code>ï¼ŒæŸ¥çœ‹å½“å‰æ‰€æœ‰è¿è¡Œçš„ goroutines å †æ ˆè·Ÿè¸ª</li><li>heapï¼ˆMemory Profilingï¼‰: <code>$HOST/debug/pprof/heap</code>ï¼ŒæŸ¥çœ‹æ´»åŠ¨å¯¹è±¡çš„å†…å­˜åˆ†é…æƒ…å†µï¼Œåœ¨è·å–å †æ ·æœ¬ä¹‹å‰ï¼Œå¯ä»¥æŒ‡å®š gc GET å‚æ•°æ¥è¿è¡Œ gcã€‚</li><li>mutexï¼ˆMutex Profilingï¼‰: <code>$HOST/debug/pprof/mutex</code>ï¼ŒæŸ¥çœ‹å¯¼è‡´äº’æ–¥é”çš„ç«äº‰æŒæœ‰è€…çš„å †æ ˆè·Ÿè¸ª</li><li>profile: <code>$HOST/debug/pprof/profile</code>ï¼Œ é»˜è®¤è¿›è¡Œ 30s çš„ CPU Profilingï¼Œå¯ä»¥ GET å‚æ•° <code>seconds</code> ä¸­æŒ‡å®šæŒç»­æ—¶é—´ã€‚
è·å¾— profile æ–‡ä»¶ä¹‹åï¼Œä½¿ç”¨ <code>go tool pprof</code> å‘½ä»¤åˆ†æ profile æ–‡ä»¶ã€‚</li><li>threadcreateï¼š<code>$HOST/debug/pprof/threadcreat</code>eï¼ŒæŸ¥çœ‹åˆ›å»ºæ–° OS çº¿ç¨‹çš„å †æ ˆè·Ÿè¸ª</li><li>trace: å½“å‰ç¨‹åºçš„æ‰§è¡Œè½¨è¿¹ã€‚å¯ä»¥åœ¨ GET å‚æ•° <code>seconds</code> ä¸­æŒ‡å®šæŒç»­æ—¶é—´ã€‚è·å–è·Ÿè¸ªæ–‡ä»¶ä¹‹åï¼Œä½¿ç”¨ <code>go tool trace</code> å‘½ä»¤æ¥åˆ†æã€‚</li></ul><h4 id=äº¤äº’å¼ç»ˆç«¯>äº¤äº’å¼ç»ˆç«¯
<a class=anchor href=#%e4%ba%a4%e4%ba%92%e5%bc%8f%e7%bb%88%e7%ab%af>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># seconds å¯ä»¥è°ƒæ•´ç­‰å¾…çš„æ—¶é—´ï¼Œå½“å‰å‘½ä»¤è®¾ç½®ç­‰å¾… 60 ç§’åä¼šè¿›è¡Œ CPU Profiling</span>
</span></span><span style=display:flex><span>go tool pprof http://localhost:8080/debug/pprof/profile?seconds<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Fetching profile over HTTP from http://localhost:6060/debug/pprof/profile?seconds<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng.CORPDOM<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.samples.cpu.001.pb.gz
</span></span><span style=display:flex><span>Type: cpu
</span></span><span style=display:flex><span>Time: Nov 18, <span style=color:#ae81ff>2019</span> at 11:08am <span style=color:#f92672>(</span>CST<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Duration: 10.20s, Total samples <span style=color:#f92672>=</span> 10.03s <span style=color:#f92672>(</span>98.38%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Entering interactive mode <span style=color:#f92672>(</span>type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> commands, <span style=color:#e6db74>&#34;o&#34;</span> <span style=color:#66d9ef>for</span> options<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¿›å…¥äº¤äº’å¼å‘½ä»¤æ¨¡å¼</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> top <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Showing nodes accounting <span style=color:#66d9ef>for</span> 9.54s, 95.11% of 10.03s total
</span></span><span style=display:flex><span>Dropped <span style=color:#ae81ff>73</span> nodes <span style=color:#f92672>(</span>cum &lt;<span style=color:#f92672>=</span> 0.05s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Showing top <span style=color:#ae81ff>10</span> nodes out of <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>      flat  flat%   sum%        cum   cum%
</span></span><span style=display:flex><span>     9.42s 93.92% 93.92%      9.46s 94.32%  runtime.cgocall
</span></span><span style=display:flex><span>     0.02s   0.2% 94.12%      9.62s 95.91%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.writeConsole
</span></span><span style=display:flex><span>     0.02s   0.2% 94.32%      9.81s 97.81%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.Output
</span></span><span style=display:flex><span>     0.02s   0.2% 94.52%      0.10s     1%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.formatHeader
</span></span><span style=display:flex><span>     0.02s   0.2% 94.72%      0.06s   0.6%  main.Add
</span></span><span style=display:flex><span>     0.02s   0.2% 94.92%      9.50s 94.72%  syscall.Syscall6
</span></span><span style=display:flex><span>     0.01s   0.1% 95.01%      0.07s   0.7%  runtime.systemstack
</span></span><span style=display:flex><span>     0.01s   0.1% 95.11%      9.51s 94.82%  syscall.WriteConsole
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0% 95.11%      0.07s   0.7%  fmt.Sprintln
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0% 95.11%      9.69s 96.61%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.Write
</span></span></code></pre></div><p>ä¸Šé¢çš„è¾“å‡ºï¼š</p><ul><li><code>flat</code>ï¼šç»™å®šå‡½æ•°ä¸Šè¿è¡Œè€—æ—¶</li><li><code>flat%</code>ï¼šåŒä¸Šçš„ CPU è¿è¡Œè€—æ—¶æ€»æ¯”ä¾‹</li><li><code>sum%</code>ï¼šç»™å®šå‡½æ•°ç´¯ç§¯ä½¿ç”¨ CPU æ€»æ¯”ä¾‹</li><li><code>cum</code>ï¼šå½“å‰å‡½æ•°åŠ ä¸Šå®ƒä¹‹ä¸Šçš„è°ƒç”¨è¿è¡Œæ€»è€—æ—¶</li><li><code>cum%</code>ï¼šåŒä¸Šçš„ CPU è¿è¡Œè€—æ—¶æ€»æ¯”ä¾‹</li><li>æœ€åä¸€åˆ—ä¸ºå‡½æ•°åç§°</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go tool pprof http://localhost:6060/debug/pprof/heap
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Fetching profile over HTTP from http://localhost:6060/debug/pprof/heap
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng.CORPDOM<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.alloc_objects.alloc_space.inuse_objects.inuse_space.008.pb.gz
</span></span><span style=display:flex><span>Type: inuse_space
</span></span><span style=display:flex><span>Entering interactive mode <span style=color:#f92672>(</span>type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> commands, <span style=color:#e6db74>&#34;o&#34;</span> <span style=color:#66d9ef>for</span> options<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> top
</span></span><span style=display:flex><span>Showing nodes accounting <span style=color:#66d9ef>for</span> 837.48MB, 100% of 837.48MB total
</span></span><span style=display:flex><span>      flat  flat%   sum%        cum   cum%
</span></span><span style=display:flex><span>  837.48MB   100%   100%   837.48MB   100%  main.main.func1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å…¶ä»–åˆ†æ</span>
</span></span><span style=display:flex><span>go tool pprof http://localhost:6060/debug/pprof/block
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>go tool pprof http://localhost:6060/debug/pprof/mutex
</span></span></code></pre></div><ul><li><code>-inuse_space</code>ï¼šåˆ†æåº”ç”¨ç¨‹åºçš„å¸¸é©»å†…å­˜å ç”¨æƒ…å†µ</li><li><code>-alloc_objects</code>ï¼šåˆ†æåº”ç”¨ç¨‹åºçš„å†…å­˜ä¸´æ—¶åˆ†é…æƒ…å†µ</li></ul><h2 id=pprof-å¯è§†åŒ–ç•Œé¢>PProf å¯è§†åŒ–ç•Œé¢
<a class=anchor href=#pprof-%e5%8f%af%e8%a7%86%e5%8c%96%e7%95%8c%e9%9d%a2>#</a></h2><p><code>data.go</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>pdata</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>datas</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>str</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#a6e22e>str</span>)
</span></span><span style=display:flex><span> <span style=color:#a6e22e>sData</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span> <span style=color:#a6e22e>datas</span> = append(<span style=color:#a6e22e>datas</span>, <span style=color:#a6e22e>sData</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sData</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>data_test.go</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>pdata</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;https://github.com/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestAdd</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Test.Add error!&#34;</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkAdd</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># ä¸‹é¢çš„å‘½ä»¤ä¼šç”Ÿæˆ cprof æ–‡ä»¶, ä½¿ç”¨ go tool pprof åˆ†æ</span>
</span></span><span style=display:flex><span>go test -bench . -cpuprofile<span style=color:#f92672>=</span>cprof
</span></span><span style=display:flex><span>goos: windows
</span></span><span style=display:flex><span>goarch: amd64
</span></span><span style=display:flex><span>pkg: github.com/shipengqi/golang-learn/demos/pprof/pdata
</span></span><span style=display:flex><span>BenchmarkAdd-8          <span style=color:#ae81ff>10084636</span>               <span style=color:#ae81ff>143</span> ns/op
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      github.com/shipengqi/golang-learn/demos/pprof/pdata     2.960s
</span></span></code></pre></div><p>å¯åŠ¨å¯è§†åŒ–ç•Œé¢ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ go tool pprof -http<span style=color:#f92672>=</span>:8080 cpu.prof
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆ–è€…</span>
</span></span><span style=display:flex><span>$ go tool pprof cpu.prof
</span></span><span style=display:flex><span>$ <span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> web
</span></span></code></pre></div><p>å¦‚æœå‡ºç° <code>Could not execute dot; may need to install graphviz.</code>ï¼Œå‚è€ƒ &ldquo;å®‰è£ Graphviz&rdquo;</p><p><img src=../imgs/profile2.png alt></p><p>ä¸Šå›¾ä¸­çš„æ¡†è¶Šå¤§ï¼Œçº¿è¶Šç²—ä»£è¡¨å®ƒæ¶ˆè€—çš„æ—¶é—´è¶Šé•¿ã€‚</p><p><img src=../imgs/profile3.png alt></p><p><img src=../imgs/profile4.png alt></p><p>PProf çš„å¯è§†åŒ–ç•Œé¢èƒ½å¤Ÿæ›´æ–¹ä¾¿ã€æ›´ç›´è§‚çš„çœ‹åˆ° Go åº”ç”¨ç¨‹åºçš„è°ƒç”¨é“¾ã€ä½¿ç”¨æƒ…å†µç­‰ã€‚</p><p>ç«ç„°å›¾ï¼š
<img src=../imgs/profile5.png alt></p><h3 id=å®‰è£-graphviz>å®‰è£ Graphviz
<a class=anchor href=#%e5%ae%89%e8%a3%9d-graphviz>#</a></h3><p>å®˜ç½‘ <a href=http://www.graphviz.org/download/>ä¸‹è½½åœ°å€</a></p><h3 id=é…ç½®ç¯å¢ƒå˜é‡>é…ç½®ç¯å¢ƒå˜é‡
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f>#</a></h3><p>å°† bin ç›®å½•æ·»åŠ åˆ° Path ç¯å¢ƒå˜é‡ä¸­ï¼Œå¦‚ <code>C:\Program Files (x86)\Graphviz2.38\bin</code>ã€‚</p><h3 id=éªŒè¯>éªŒè¯
<a class=anchor href=#%e9%aa%8c%e8%af%81>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dot -version
</span></span></code></pre></div><p><strong>éƒ¨åˆ†å†…å®¹æ¥è‡ª</strong> <a href=https://github.com/EDDYCJY/blog/blob/7b021d0dee/tools/go-tool-pprof.md>Go å¤§æ€å™¨ä¹‹æ€§èƒ½å‰–æ PProf</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/commit/e2c1b9369331db41bcc14cb50249d04165b4bc8c title='Last modified by shipengqi | October 15, 2023' target=_blank rel=noopener><img src=/golang-learn/svg/calendar.svg class=book-icon alt=Calendar>
<span>October 15, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/edit/master/content/docs/practice/04_pprof.md target=_blank rel=noopener><img src=/golang-learn/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#go-æ€§èƒ½åˆ†æ>Go æ€§èƒ½åˆ†æ</a><ul><li><a href=#æ€§èƒ½åˆ†æ>æ€§èƒ½åˆ†æ</a><ul><li><a href=#åˆ†æ-http-server>åˆ†æ HTTP Server</a></li></ul></li><li><a href=#pprof-å¯è§†åŒ–ç•Œé¢>PProf å¯è§†åŒ–ç•Œé¢</a><ul><li><a href=#å®‰è£-graphviz>å®‰è£ Graphviz</a></li><li><a href=#é…ç½®ç¯å¢ƒå˜é‡>é…ç½®ç¯å¢ƒå˜é‡</a></li><li><a href=#éªŒè¯>éªŒè¯</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>