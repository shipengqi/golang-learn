<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Channel # Donâ€™t communicate by sharing memory; share memory by communicating. ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œé€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚ è¿™æ˜¯ Go è¯­è¨€æœ€é‡è¦çš„ç¼–ç¨‹ç†å¿µã€‚goroutine é€šè¿‡ channel å‘å¦ä¸€ä¸ª goroutine å‘é€æ¶ˆæ¯ï¼Œchannel å’Œ goroutine ç»“åˆï¼Œå¯ä»¥å®ç°ç”¨é€šä¿¡ä»£æ›¿å…±äº«å†…å­˜çš„ CSP ï¼ˆCommunicating Sequential Processï¼‰æ¨¡å‹ã€‚
ä½¿ç”¨ # åˆ›å»º channelï¼š
// æ— ç¼“å†² channel ch := make(chan int) // å¸¦ç¼“å†² channelï¼Œç¼“å†²åŒºä¸º 3 ch = make(chan int, 3) channel çš„é›¶å€¼æ˜¯ nilã€‚
æ— ç¼“å†² channel # æ— ç¼“å†² channel ä¹Ÿå«åšåŒæ­¥ channelï¼š
ä¸€ä¸ª goroutine åŸºäºä¸€ä¸ªæ— ç¼“å†² channel å‘é€æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ª goroutine åœ¨ç›¸åŒçš„ channel ä¸Šæ‰§è¡Œæ¥æ”¶æ“ä½œã€‚ ä¸€ä¸ª goroutine åŸºäºä¸€ä¸ªæ— ç¼“å†² channel å…ˆæ‰§è¡Œäº†æ¥æ”¶æ“ä½œï¼Œä¹Ÿä¼šé˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ª goroutine åœ¨ç›¸åŒçš„ channel ä¸Šæ‰§è¡Œå‘é€æ“ä½œ å¸¦ç¼“å†² channel # å¸¦ç¼“å†²çš„ channel æœ‰ä¸€ä¸ªç¼“å†²åŒºï¼š"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Channel"><meta property="og:description" content="Channel # Donâ€™t communicate by sharing memory; share memory by communicating. ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œé€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚ è¿™æ˜¯ Go è¯­è¨€æœ€é‡è¦çš„ç¼–ç¨‹ç†å¿µã€‚goroutine é€šè¿‡ channel å‘å¦ä¸€ä¸ª goroutine å‘é€æ¶ˆæ¯ï¼Œchannel å’Œ goroutine ç»“åˆï¼Œå¯ä»¥å®ç°ç”¨é€šä¿¡ä»£æ›¿å…±äº«å†…å­˜çš„ CSP ï¼ˆCommunicating Sequential Processï¼‰æ¨¡å‹ã€‚
ä½¿ç”¨ # åˆ›å»º channelï¼š
// æ— ç¼“å†² channel ch := make(chan int) // å¸¦ç¼“å†² channelï¼Œç¼“å†²åŒºä¸º 3 ch = make(chan int, 3) channel çš„é›¶å€¼æ˜¯ nilã€‚
æ— ç¼“å†² channel # æ— ç¼“å†² channel ä¹Ÿå«åšåŒæ­¥ channelï¼š
ä¸€ä¸ª goroutine åŸºäºä¸€ä¸ªæ— ç¼“å†² channel å‘é€æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ª goroutine åœ¨ç›¸åŒçš„ channel ä¸Šæ‰§è¡Œæ¥æ”¶æ“ä½œã€‚ ä¸€ä¸ª goroutine åŸºäºä¸€ä¸ªæ— ç¼“å†² channel å…ˆæ‰§è¡Œäº†æ¥æ”¶æ“ä½œï¼Œä¹Ÿä¼šé˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ª goroutine åœ¨ç›¸åŒçš„ channel ä¸Šæ‰§è¡Œå‘é€æ“ä½œ å¸¦ç¼“å†² channel # å¸¦ç¼“å†²çš„ channel æœ‰ä¸€ä¸ªç¼“å†²åŒºï¼š"><meta property="og:type" content="article"><meta property="og:url" content="https://shipengqi.github.io/golang-learn/docs/concurrency/09_channel/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-11-03T10:03:13+08:00"><title>Channel | Go Learning</title><link rel=manifest href=/golang-learn/manifest.json><link rel=icon href=/golang-learn/favicon.png><link rel=stylesheet href=/golang-learn/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/golang-learn/flexsearch.min.js></script>
<script defer src=/golang-learn/en.search.min.85ac43de481b0867c3ed54a5a2263e836d58519eeddb4df16af262f7ed157d12.js integrity="sha256-haxD3kgbCGfD7VSloiY+g21YUZ7t203xavJi9+0VfRI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/golang-learn/><span>Go Learning</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://shipengqi.github.io/ target=_blank rel=noopener>Blog</a></li><li><a href=https://github.com/shipengqi/golang-learn target=_blank rel=noopener>Github</a></li></ul><ul><li><span>ğŸš è¯­è¨€åŸºç¡€</span><ul><li><a href=/golang-learn/docs/basic/01_basic_type/>åŸºç¡€æ•°æ®ç±»å‹</a></li><li><a href=/golang-learn/docs/basic/02_array/>æ•°ç»„</a></li><li><a href=/golang-learn/docs/basic/03_slice/>åˆ‡ç‰‡</a></li><li><a href=/golang-learn/docs/basic/04_map/>å“ˆå¸Œè¡¨</a></li><li><a href=/golang-learn/docs/basic/05_function/>å‡½æ•°</a></li><li><a href=/golang-learn/docs/basic/09_pointer/>æŒ‡é’ˆ</a></li></ul></li><li><a href=/golang-learn/docs/concurrency/>âš¡ å¹¶å‘ç¼–ç¨‹</a><ul><li><a href=/golang-learn/docs/concurrency/01_mutex/>äº’æ–¥é”</a></li><li><a href=/golang-learn/docs/concurrency/02_rwmutex/>è¯»å†™é”</a></li><li><a href=/golang-learn/docs/concurrency/03_waitgroup/>WaitGroup</a></li><li><a href=/golang-learn/docs/concurrency/04_cond/>æ¡ä»¶å˜é‡</a></li><li><a href=/golang-learn/docs/concurrency/05_once/>Once</a></li><li><a href=/golang-learn/docs/concurrency/06_pool/>Pool</a></li><li><a href=/golang-learn/docs/concurrency/07_context/>Context</a></li><li><a href=/golang-learn/docs/concurrency/08_atomic/>åŸå­æ“ä½œ</a></li><li><a href=/golang-learn/docs/concurrency/09_channel/ class=active>Channel</a></li><li><a href=/golang-learn/docs/concurrency/10_sema/>ä¿¡å·é‡</a></li><li><a href=/golang-learn/docs/concurrency/11_singleflight/>SingleFlight</a></li><li><a href=/golang-learn/docs/concurrency/12_errorgroup/>ErrGroup</a></li></ul></li><li><span>ğŸ› ï¸ å®è·µ</span><ul><li><a href=/golang-learn/docs/practice/01_build/>Go ç¼–è¯‘</a></li><li><a href=/golang-learn/docs/practice/02_go_race/>Go æ•°æ®ç«äº‰æ£€æµ‹å™¨</a></li><li><a href=/golang-learn/docs/practice/05_performance/>Go æ€§èƒ½ä¼˜åŒ–</a></li><li><a href=/golang-learn/docs/practice/07_coredump/>Go Core Dump è°ƒè¯•</a></li><li><a href=/golang-learn/docs/practice/08_mod/>Go Modules</a></li><li><a href=/golang-learn/docs/practice/09_gin/>Gin é™æ€æœåŠ¡å™¨</a></li></ul></li><li><span>ğŸ› ï¸ Go å·¥ç¨‹å®è·µ</span><ul><li><a href=/golang-learn/docs/project/01_specs/>é¡¹ç›®è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/02_structure/>é¡¹ç›®çš„ç›®å½•ç»“æ„</a></li><li><a href=/golang-learn/docs/project/03_code/>ä»£ç è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/04_commitizen/>Commit è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/05_version/>ç‰ˆæœ¬è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/06_api_doc/>API æ–‡æ¡£</a></li><li><a href=/golang-learn/docs/project/07_flow/>Git å·¥ä½œæµç¨‹</a></li><li><a href=/golang-learn/docs/project/08_make/>é¡¹ç›®ç®¡ç†</a></li><li><a href=/golang-learn/docs/project/09_actions/>GitHub Actions</a></li><li><a href=/golang-learn/docs/project/10_dependabot/>GitHub Dependabot</a></li><li><a href=/golang-learn/docs/project/11_templates/>GitHub æ¨¡æ¿</a></li><li><a href=/golang-learn/docs/project/12_goreleaser/>GoReleaser</a></li></ul></li><li><a href=/golang-learn/docs/advance/>ğŸ” åº•å±‚åŸç†</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/golang-learn/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Channel</strong>
<label for=toc-control><img src=/golang-learn/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#channel>Channel</a><ul><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a><ul><li><a href=#æ— ç¼“å†²-channel>æ— ç¼“å†² channel</a></li><li><a href=#å¸¦ç¼“å†²-channel>å¸¦ç¼“å†² channel</a></li><li><a href=#å…³é—­-channel>å…³é—­ channel</a></li><li><a href=#å•å‘-channel>å•å‘ channel</a></li><li><a href=#cap-å’Œ-len>cap å’Œ len</a></li><li><a href=#ä½¿ç”¨-range-éå†-channel>ä½¿ç”¨ range éå† channel</a></li><li><a href=#ä½¿ç”¨-channel-å®ç°äº’æ–¥é”>ä½¿ç”¨ channel å®ç°äº’æ–¥é”</a></li></ul></li><li><a href=#åŸç†>åŸç†</a><ul><li><a href=#åˆ›å»º-channel>åˆ›å»º channel</a></li><li><a href=#å‘-channel-å‘é€æ•°æ®>å‘ channel å‘é€æ•°æ®</a></li><li><a href=#ä»-channel-æ¥æ”¶æ•°æ®>ä» channel æ¥æ”¶æ•°æ®</a></li><li><a href=#å…³é—­-channel-1>å…³é—­ channel</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=channel>Channel
<a class=anchor href=#channel>#</a></h1><pre tabindex=0><code>Donâ€™t communicate by sharing memory; share memory by communicating.
ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œé€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚
</code></pre><p>è¿™æ˜¯ Go è¯­è¨€æœ€é‡è¦çš„ç¼–ç¨‹ç†å¿µã€‚goroutine é€šè¿‡ channel å‘å¦ä¸€ä¸ª goroutine å‘é€æ¶ˆæ¯ï¼Œchannel å’Œ goroutine ç»“åˆï¼Œå¯ä»¥å®ç°ç”¨é€šä¿¡ä»£æ›¿å…±äº«å†…å­˜çš„ CSP ï¼ˆCommunicating Sequential Processï¼‰æ¨¡å‹ã€‚</p><h2 id=ä½¿ç”¨>ä½¿ç”¨
<a class=anchor href=#%e4%bd%bf%e7%94%a8>#</a></h2><p>åˆ›å»º channelï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// æ— ç¼“å†² channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¸¦ç¼“å†² channelï¼Œç¼“å†²åŒºä¸º 3
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>ch</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>, <span style=color:#ae81ff>3</span>)
</span></span></code></pre></div><blockquote><p>channel çš„é›¶å€¼æ˜¯ <code>nil</code>ã€‚</p></blockquote><h3 id=æ— ç¼“å†²-channel>æ— ç¼“å†² channel
<a class=anchor href=#%e6%97%a0%e7%bc%93%e5%86%b2-channel>#</a></h3><p>æ— ç¼“å†² channel ä¹Ÿå«åšåŒæ­¥ channelï¼š</p><ul><li>ä¸€ä¸ª goroutine åŸºäºä¸€ä¸ªæ— ç¼“å†² channel å‘é€æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ª goroutine åœ¨ç›¸åŒçš„ channel ä¸Šæ‰§è¡Œæ¥æ”¶æ“ä½œã€‚</li><li>ä¸€ä¸ª goroutine åŸºäºä¸€ä¸ªæ— ç¼“å†² channel å…ˆæ‰§è¡Œäº†æ¥æ”¶æ“ä½œï¼Œä¹Ÿä¼šé˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ª goroutine åœ¨ç›¸åŒçš„ channel ä¸Šæ‰§è¡Œå‘é€æ“ä½œ</li></ul><h3 id=å¸¦ç¼“å†²-channel>å¸¦ç¼“å†² channel
<a class=anchor href=#%e5%b8%a6%e7%bc%93%e5%86%b2-channel>#</a></h3><p>å¸¦ç¼“å†²çš„ channel æœ‰ä¸€ä¸ªç¼“å†²åŒºï¼š</p><ul><li>è‹¥ç¼“å†²åŒºæœªæ»¡åˆ™ä¸ä¼šé˜»å¡ï¼Œå‘é€è€…å¯ä»¥ä¸æ–­çš„å‘é€æ•°æ®ã€‚å½“ç¼“å†²åŒºæ»¡äº†åï¼Œå‘é€è€…å°±ä¼šé˜»å¡ã€‚</li><li>å½“ç¼“å†²åŒºä¸ºç©ºæ—¶ï¼Œæ¥å—è€…å°±ä¼šé˜»å¡ï¼Œç›´è‡³æœ‰æ–°çš„æ•°æ®</li></ul><h3 id=å…³é—­-channel>å…³é—­ channel
<a class=anchor href=#%e5%85%b3%e9%97%ad-channel>#</a></h3><p>ä½¿ç”¨ <code>close</code> å‡½æ•°å…³é—­ channelï¼š</p><ul><li>channel å…³é—­åä¸èƒ½å†å‘é€æ•°æ®</li><li>channel å…³é—­åå¯ä»¥æ¥æ”¶å·²ç»å‘é€æˆåŠŸçš„æ•°æ®ã€‚</li><li>channel å…³é—­åå¦‚æœ channel ä¸­æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆæ¥æ”¶è€…ä¼šæ”¶åˆ°ä¸€ä¸ª channel å…ƒç´ çš„é›¶å€¼ã€‚</li></ul><p><code>close</code> è¡¨ç¤ºè¿™ä¸ª channel ä¸ä¼šå†ç»§ç»­å‘é€æ•°æ®ï¼Œæ‰€ä»¥è¦<strong>åœ¨å‘é€è€…æ‰€åœ¨çš„ goroutine å»å…³é—­ channel</strong>ã€‚</p><blockquote><p>å…³é—­ä¸€ä¸ª <code>nil</code> çš„ channel ä¼šå¯¼è‡´ panicã€‚<br>é‡å¤å…³é—­ channel ä¼šå¯¼è‡´ panicã€‚<br>å‘å·²å…³é—­çš„ channel å‘é€å€¼ä¼šå¯¼è‡´ panicã€‚<br></p></blockquote><h3 id=å•å‘-channel>å•å‘ channel
<a class=anchor href=#%e5%8d%95%e5%90%91-channel>#</a></h3><p>å½“ä¸€ä¸ª channel ä½œä¸ºä¸€ä¸ªå‡½æ•°å‚æ•°æ—¶ï¼Œå®ƒä¸€èˆ¬æ€»æ˜¯è¢«ä¸“é—¨ç”¨äº<strong>åªå‘é€æˆ–è€…åªæ¥æ”¶</strong>ã€‚</p><ul><li><code>chan&lt;- int</code> è¡¨ç¤ºä¸€ä¸ªåªå‘é€ <code>int</code> çš„ channelã€‚</li><li><code>&lt;-chan int</code> è¡¨ç¤ºä¸€ä¸ªåªæ¥æ”¶ <code>int</code> çš„ channelã€‚</li></ul><h3 id=cap-å’Œ-len>cap å’Œ len
<a class=anchor href=#cap-%e5%92%8c-len>#</a></h3><ul><li><code>cap</code> å‡½æ•°å¯ä»¥è·å– channel å†…éƒ¨ç¼“å†²åŒºçš„å®¹é‡ã€‚</li><li><code>len</code> å‡½æ•°å¯ä»¥è·å– channel å†…éƒ¨ç¼“å†²åŒºæœ‰æ•ˆå…ƒç´ çš„ä¸ªæ•°ã€‚</li></ul><h3 id=ä½¿ç”¨-range-éå†-channel>ä½¿ç”¨ range éå† channel
<a class=anchor href=#%e4%bd%bf%e7%94%a8-range-%e9%81%8d%e5%8e%86-channel>#</a></h3><p>ä½¿ç”¨ <code>range</code> å¾ªç¯å¯ä»¥éå† channelï¼Œå®ƒä¾æ¬¡ä» channel ä¸­æ¥æ”¶æ•°æ®ï¼Œå½“ channel è¢«å…³é—­å¹¶ä¸”æ²¡æœ‰å€¼å¯æ¥æ”¶æ—¶è·³å‡ºå¾ªç¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å…³é—­ channel
</span></span></span><span style=display:flex><span><span style=color:#75715e>// å¦‚æœä¸å…³é—­ channelï¼Œrange å°±ä¼šé˜»å¡å½“å‰ goroutine, ç›´åˆ° channel å…³é—­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>close(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ch</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>v</span>) 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ä½¿ç”¨-channel-å®ç°äº’æ–¥é”>ä½¿ç”¨ channel å®ç°äº’æ–¥é”
<a class=anchor href=#%e4%bd%bf%e7%94%a8-channel-%e5%ae%9e%e7%8e%b0%e4%ba%92%e6%96%a5%e9%94%81>#</a></h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®¹é‡åªæœ‰ <code>1</code> çš„ channel æ¥ä¿è¯æœ€å¤šåªæœ‰ä¸€ä¸ª goroutine åœ¨åŒä¸€æ—¶åˆ»è®¿é—®ä¸€ä¸ªå…±äº«å˜é‡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sema</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}, <span style=color:#ae81ff>1</span>) <span style=color:#75715e>// a binary semaphore guarding balance 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>balance</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Deposit</span>(<span style=color:#a6e22e>amount</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sema</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{} <span style=color:#75715e>// acquire lock 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>balance</span> = <span style=color:#a6e22e>balance</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>amount</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sema</span> <span style=color:#75715e>// release lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Balance</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sema</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{} <span style=color:#75715e>// acquire lock 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>balance</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sema</span> <span style=color:#75715e>// release lock 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// return b
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=åŸç†>åŸç†
<a class=anchor href=#%e5%8e%9f%e7%90%86>#</a></h2><p>channel æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæœ‰é”çš„ç¯å½¢é˜Ÿåˆ—ï¼Œchannel çš„ç»“æ„ä½“ <code>hchan</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/chan.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>hchan</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>qcount</span>   <span style=color:#66d9ef>uint</span>           <span style=color:#75715e>// total data in the queue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dataqsiz</span> <span style=color:#66d9ef>uint</span>           <span style=color:#75715e>// size of the circular queue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>buf</span>      <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> <span style=color:#75715e>// points to an array of dataqsiz elements
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>elemsize</span> <span style=color:#66d9ef>uint16</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>closed</span>   <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elemtype</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span> <span style=color:#75715e>// element type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sendx</span>    <span style=color:#66d9ef>uint</span>   <span style=color:#75715e>// send index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>recvx</span>    <span style=color:#66d9ef>uint</span>   <span style=color:#75715e>// receive index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>recvq</span>    <span style=color:#a6e22e>waitq</span>  <span style=color:#75715e>// list of recv waiters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sendq</span>    <span style=color:#a6e22e>waitq</span>  <span style=color:#75715e>// list of send waiters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// lock protects all fields in hchan, as well as several
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// fields in sudogs blocked on this channel.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Do not change another G&#39;s status while holding this lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// (in particular, do not ready a G), as this can deadlock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// with stack shrinking.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lock</span> <span style=color:#a6e22e>mutex</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>qcount</code>ï¼šchannel ä¸­çš„å…ƒç´ ä¸ªæ•°</li><li><code>dataqsiz</code>ï¼šchannel ä¸­çš„å¾ªç¯é˜Ÿåˆ—çš„é•¿åº¦</li><li><code>buf</code>ï¼šchannel çš„ç¼“å†²åŒºæ•°æ®æŒ‡é’ˆï¼ŒæŒ‡å‘åº•å±‚çš„å¾ªç¯æ•°ç»„ï¼Œåªé’ˆå¯¹æœ‰ç¼“å†²çš„ channelã€‚</li><li><code>elemsize</code>ï¼šchannel ä¸­å…ƒç´ å¤§å°</li><li><code>elemtype</code>ï¼šchannel ä¸­å…ƒç´ ç±»å‹</li><li><code>closed</code>ï¼šchannel æ˜¯å¦è¢«å…³é—­çš„æ ‡å¿—ä½</li><li><code>sendx</code>ï¼šè¡¨ç¤ºå½“å‰å¯ä»¥å‘é€çš„å…ƒç´ åœ¨åº•å±‚å¾ªç¯æ•°ç»„ä¸­ä½ç½®ç´¢å¼•</li><li><code>recvx</code>ï¼šè¡¨ç¤ºå½“å‰å¯ä»¥å‘é€çš„å…ƒç´ åœ¨åº•å±‚å¾ªç¯æ•°ç»„ä¸­ä½ç½®ç´¢å¼•</li><li><code>sendq</code>ï¼šå‘ channel å‘é€æ•°æ®è€Œè¢«é˜»å¡çš„ goroutine é˜Ÿåˆ—</li><li><code>recvq</code>ï¼šè¯»å– channel çš„æ•°æ®è€Œè¢«é˜»å¡çš„ goroutine é˜Ÿåˆ—</li><li><code>lock</code>ï¼šä¿æŠ¤ <code>hchan</code> ä¸­æ‰€æœ‰å­—æ®µ</li></ul><p><code>waitq</code> æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œé“¾è¡¨ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯ <code>sudog</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>waitq</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>first</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>last</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>sudog</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æŒ‡å‘å½“å‰çš„ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æŒ‡å‘ä¸‹ä¸€ä¸ª goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>next</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æŒ‡å‘ä¸Šä¸€ä¸ª goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>prev</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æŒ‡å‘å…ƒç´ æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h3 id=åˆ›å»º-channel>åˆ›å»º channel
<a class=anchor href=#%e5%88%9b%e5%bb%ba-channel>#</a></h3><p>åˆ›å»º channel è¦ä½¿ç”¨ <code>make</code>ï¼Œç¼–è¯‘å™¨ä¼šå°† <code>make</code> è½¬æ¢æˆ <code>makechan</code> æˆ–è€… <code>makechan64</code> å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/chan.go#L72
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>makechan</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>chantype</span>, <span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Elem</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// compiler checks this but be safe.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>mem</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// æ— ç¼“å†² channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// è°ƒç”¨ mallocgc æ–¹æ³•åˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span> = (<span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>)(<span style=color:#a6e22e>mallocgc</span>(<span style=color:#a6e22e>hchanSize</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>true</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>PtrBytes</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// channel å­˜å‚¨çš„å…ƒç´ ç±»å‹ä¸æ˜¯æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// åˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ç»™ hchan å’Œåº•å±‚æ•°ç»„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span> = (<span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>)(<span style=color:#a6e22e>mallocgc</span>(<span style=color:#a6e22e>hchanSize</span><span style=color:#f92672>+</span><span style=color:#a6e22e>mem</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>true</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>c</span>), <span style=color:#a6e22e>hchanSize</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿›è¡Œä¸¤æ¬¡å†…å­˜åˆ†é…æ“ä½œï¼Œåˆ†åˆ«ä¸º hchan å’Œç¼“å†²åŒºåˆ†é…å†…å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span> = new(<span style=color:#a6e22e>hchan</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>mallocgc</span>(<span style=color:#a6e22e>mem</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è®¾ç½®å…ƒç´ å¤§å°ï¼Œå…ƒç´ ç±»å‹ï¼Œå¾ªç¯æ•°ç»„çš„é•¿åº¦
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemsize</span> = uint16(<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Size_</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span> = <span style=color:#a6e22e>elem</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> = uint(<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lockInit</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>lockRankHchan</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä½¿ç”¨ mallocgc å‡½æ•°åˆ›å»º channelï¼Œå°±æ„å‘³ç€ channel éƒ½æ˜¯åˆ†é…åœ¨å †ä¸Šçš„ã€‚æ‰€ä»¥<strong>å½“ä¸€ä¸ª channel æ²¡æœ‰è¢«ä»»ä½• goroutine å¼•ç”¨æ—¶ï¼Œæ˜¯ä¼šè¢« GC å›æ”¶çš„</strong>ã€‚</p><h3 id=å‘-channel-å‘é€æ•°æ®>å‘ channel å‘é€æ•°æ®
<a class=anchor href=#%e5%90%91-channel-%e5%8f%91%e9%80%81%e6%95%b0%e6%8d%ae>#</a></h3><p>å‘é€æ“ä½œï¼Œä¹Ÿå°±æ˜¯ <code>ch &lt;- i</code> è¯­å¥ï¼Œç¼–è¯‘å™¨æœ€ç»ˆä¼šå°†è¯¥è¯­å¥è½¬æ¢æˆ <code>chansend</code> å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/chan.go
</span></span></span><span style=display:flex><span><span style=color:#75715e>// block ä¸º true æ—¶ï¼Œè¡¨ç¤ºå½“å‰æ“ä½œæ˜¯é˜»å¡çš„ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chansend</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>block</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>callerpc</span> <span style=color:#66d9ef>uintptr</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ä¸å¯ä»¥é˜»å¡ï¼Œç›´æ¥è¿”å› falseï¼Œè¡¨ç¤ºæœªå‘é€æˆåŠŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æŒ‚èµ·å½“å‰ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>gopark</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>waitReasonChanSendNilChan</span>, <span style=color:#a6e22e>traceBlockForever</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;unreachable&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>full</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t0</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>blockprofilerate</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t0</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ‰§è¡Œå‘é€æ•°æ®çš„é€»è¾‘ä¹‹å‰ï¼Œå…ˆä¸ºå½“å‰ channel åŠ é”ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹å¹¶å‘ä¿®æ”¹æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦‚æœ channel å·²ç»å…³é—­ï¼Œé‚£ä¹ˆå‘è¯¥ channel å‘é€æ•°æ®ä¼šå¯¼è‡´ panicï¼šsend on closed channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// è§£é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// panic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;send on closed channel&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å½“å‰æ¥æ”¶é˜Ÿåˆ—é‡Œå­˜åœ¨ goroutineï¼Œé€šè¿‡ runtime.send ç›´æ¥å°†æ•°æ®å‘é€ç»™é˜»å¡çš„æ¥æ”¶è€…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>dequeue</span>(); <span style=color:#a6e22e>sg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>) }, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜æ²¡æœ‰ç­‰å¾…æ•°æ®çš„æ¥æ”¶è€…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¯¹äºæœ‰ç¼“å†²çš„ channelï¼Œå¹¶ä¸”è¿˜æœ‰ç¼“å†²ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> &lt; <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è®¡ç®—å‡ºä¸‹ä¸€ä¸ªå¯ä»¥å­˜å‚¨æ•°æ®çš„ä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>qp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chanbuf</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>racenotify</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å°†å‘é€çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºä¸­å¹¶å¢åŠ  sendx ç´¢å¼•å’Œ qcount è®¡æ•°å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>qp</span>, <span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// sendx ç´¢å¼• +1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ç”±äº buf æ˜¯ä¸€ä¸ªå¾ªç¯æ•°ç»„ï¼Œæ‰€ä»¥å½“ sendx ç­‰äº dataqsiz æ—¶ä¼šé‡æ–°å›åˆ°æ•°ç»„å¼€å§‹çš„ä½ç½®ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// é‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜ç¼“å†²ç©ºé—´å·²æ»¡ï¼Œæˆ–è€…æ˜¯æ— ç¼“å†² channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦‚æœä¸å¯ä»¥é˜»å¡ï¼Œç›´æ¥è¿”å› falseï¼Œè¡¨ç¤ºæœªå‘é€æˆåŠŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç¼“å†²ç©ºé—´å·²æ»¡æˆ–è€…æ˜¯æ— ç¼“å†² channelï¼Œå‘é€æ–¹ä¼šè¢«é˜»å¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è·å–å½“å‰å‘é€æ•°æ®çš„ goroutine çš„æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ„é€ ä¸€ä¸ª sudog
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquireSudog</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t0</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è®¾ç½®è¿™ä¸€æ¬¡é˜»å¡å‘é€çš„ç›¸å…³ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#a6e22e>ep</span> <span style=color:#75715e>// å¾…å‘é€æ•°æ®çš„å†…å­˜åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>waitlink</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>gp</span> <span style=color:#75715e>// å½“å‰å‘é€æ•°æ®çš„ goroutine çš„æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>isSelect</span> = <span style=color:#66d9ef>false</span> <span style=color:#75715e>// æ˜¯å¦åœ¨ select ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>c</span> <span style=color:#75715e>// å‘é€çš„ channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#a6e22e>mysg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å°† sudog æ”¾å…¥åˆ°å‘é€ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>enqueue</span>(<span style=color:#a6e22e>mysg</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æŒ‚èµ·å½“å‰ goroutineï¼Œç­‰å¾…å”¤é†’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>parkingOnChan</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gopark</span>(<span style=color:#a6e22e>chanparkcommit</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>), <span style=color:#a6e22e>waitReasonChanSend</span>, <span style=color:#a6e22e>traceBlockChanSend</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>KeepAlive</span>(<span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// goroutine å¼€å§‹è¢«å”¤é†’äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;G waiting list is corrupted&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>activeStackChans</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>closed</span> <span style=color:#f92672>:=</span> !<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>success</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>blockevent</span>(<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span><span style=color:#f92672>-</span><span style=color:#a6e22e>t0</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç§»é™¤ mysg ä¸Šç»‘å®šçš„ channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releaseSudog</span>(<span style=color:#a6e22e>mysg</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>closed</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;chansend: spurious wakeup&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// è¢«å”¤é†’äº†ï¼Œä½†æ˜¯ channel å·²ç»å…³é—­äº†ï¼Œpanic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;send on closed channel&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è¿”å› true è¡¨ç¤ºå·²ç»æˆåŠŸå‘ channel å‘é€äº†æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>send</code> å‘é€æ•°æ®ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>sg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>unlockf</span> <span style=color:#66d9ef>func</span>(), <span style=color:#a6e22e>skip</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// sg æ˜¯æ¥æ”¶è€…çš„ sudog ç»“æ„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// sg.elem æŒ‡å‘æ¥æ”¶åˆ°çš„å€¼å­˜æ”¾çš„ä½ç½®ï¼Œå¦‚ val &lt;- chï¼ŒæŒ‡çš„å°±æ˜¯ &amp;val
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ç›´æ¥æ‹·è´å†…å­˜åˆ° val &lt;- ch è¡¨è¾¾å¼ä¸­å˜é‡ val æ‰€åœ¨çš„å†…å­˜åœ°å€ï¼ˆ&amp;valï¼‰ä¸Š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>sendDirect</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è·å– sudog ä¸Šç»‘å®šçš„ç­‰å¾…æ¥æ”¶çš„ goroutine çš„æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlockf</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å”¤é†’ç­‰å¾…æ¥æ”¶çš„ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>skip</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p><code>goready</code> æ˜¯å°† goroutine çš„çŠ¶æ€æ”¹æˆ <code>runnable</code>ï¼Œç„¶åéœ€è¦ç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sendDirect</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span>, <span style=color:#a6e22e>sg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>, <span style=color:#a6e22e>src</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// src æ˜¯å½“å‰ goroutine å‘é€çš„æ•°æ®çš„å†…å­˜åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// dst æ˜¯æ¥æ”¶è€…çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dst</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å†™å±éšœ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>typeBitsBulkBarrier</span>(<span style=color:#a6e22e>t</span>, uintptr(<span style=color:#a6e22e>dst</span>), uintptr(<span style=color:#a6e22e>src</span>), <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ‹·è´å†…å­˜æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>memmove</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ä»-channel-æ¥æ”¶æ•°æ®>ä» channel æ¥æ”¶æ•°æ®
<a class=anchor href=#%e4%bb%8e-channel-%e6%8e%a5%e6%94%b6%e6%95%b0%e6%8d%ae>#</a></h3><p>Go ä¸­å¯ä»¥ä½¿ç”¨ä¸¤ç§ä¸åŒçš„æ–¹å¼å»æ¥æ”¶ channel ä¸­çš„æ•°æ®ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ch</span>
</span></span></code></pre></div><p>ç¼–è¯‘å™¨çš„å¤„ç†ååˆ†åˆ«ä¼šè½¬æ¢æˆ <code>chanrecv1</code>ï¼Œ<code>chanrecv2</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/chan.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chanrecv1</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chanrecv2</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>received</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>received</span> = <span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸¤ä¸ªæ–¹æ³•æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº† <code>chanrecv</code> å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/chan.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>block</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#a6e22e>selected</span>, <span style=color:#a6e22e>received</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// channel æ˜¯ nil
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ä¸å¯ä»¥é˜»å¡ï¼Œç›´æ¥è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// æŒ‚èµ·å½“å‰ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>gopark</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>waitReasonChanReceiveNilChan</span>, <span style=color:#a6e22e>traceBlockForever</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;unreachable&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>empty</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>empty</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>raceacquire</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t0</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>blockprofilerate</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t0</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ‰§è¡Œæ¥æ”¶æ•°æ®çš„é€»è¾‘ä¹‹å‰ï¼Œå…ˆä¸ºå½“å‰ channel åŠ é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// channel å·²å…³é—­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// åº•å±‚çš„å¾ªç¯æ•°ç»„ buf ä¸­æ²¡æœ‰å…ƒç´ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>raceacquire</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// é‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// typedmemclr æ ¹æ®ç±»å‹æ¸…ç†ç›¸åº”åœ°å€çš„å†…å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// channel æœªå…³é—­ï¼Œå¹¶ä¸”ç­‰å¾…å‘é€é˜Ÿåˆ—é‡Œå­˜åœ¨ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// å‘é€çš„ goroutine è¢«é˜»å¡ï¼Œé‚£æœ‰ä¸¤ç§æƒ…å†µï¼š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// 1. è¿™æ˜¯ä¸€ä¸ªéç¼“å†²å‹çš„ channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// 2. ç¼“å†²å‹çš„ channelï¼Œä½†æ˜¯ buf æ»¡äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// recv ç›´æ¥è¿›è¡Œå†…å­˜æ‹·è´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>dequeue</span>(); <span style=color:#a6e22e>sg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>recv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>) }, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// channel æœªå…³é—­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// ç¼“å†²å‹ channel å¹¶ä¸” buf é‡Œæœ‰å…ƒç´ ï¼Œå¯ä»¥æ­£å¸¸æ¥æ”¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç›´æ¥ä»å¾ªç¯æ•°ç»„é‡Œå–å‡ºè¦æ¥æ”¶çš„å…ƒç´ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>qp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chanbuf</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>racenotify</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// è¿™é‡Œè¡¨ç¤ºï¼Œä»£ç ä¸­æ²¡æœ‰å¿½ç•¥è¦æ¥æ”¶çš„å€¼ï¼Œä¸æ˜¯ &#34;&lt;- ch&#34;ï¼Œè€Œæ˜¯ &#34;val &lt;- ch&#34;ï¼Œep æŒ‡å‘ val
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// æ‹·è´æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#a6e22e>qp</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// æ¸…ç†æ‰å¾ªç¯æ•°ç»„é‡Œç›¸åº”ä½ç½®çš„å€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>qp</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// recvx ç´¢å¼• +1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å…ƒç´ ä¸ªæ•° -1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// éé˜»å¡æ¥æ”¶ï¼Œé‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// selected è¿”å› falseï¼Œå› ä¸ºæ²¡æœ‰æ¥æ”¶åˆ°å€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// èµ°åˆ°è¿™é‡Œè¯´æ˜ buf æ˜¯ç©ºçš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ²¡æœ‰æ•°æ®å¯æ¥æ”¶ï¼Œé˜»å¡å½“å‰æ¥æ”¶çš„ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è·å–å½“å‰æ¥æ”¶çš„ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ„é€ ä¸€ä¸ª sudog
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquireSudog</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t0</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®è¿™ä¸€æ¬¡é˜»å¡æ¥æ”¶çš„ç›¸å…³ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#a6e22e>ep</span> <span style=color:#75715e>// å¾…æ¥æ”¶æ•°æ®çš„åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>waitlink</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#a6e22e>mysg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>gp</span> <span style=color:#75715e>// å½“å‰æ¥æ”¶çš„ goroutine æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>isSelect</span> = <span style=color:#66d9ef>false</span> <span style=color:#75715e>// æ˜¯å¦åœ¨ select ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>c</span> <span style=color:#75715e>// æ¥æ”¶çš„ channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å°† sudog æ”¾å…¥åˆ°æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>enqueue</span>(<span style=color:#a6e22e>mysg</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>parkingOnChan</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æŒ‚èµ·å½“å‰æ¥æ”¶ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gopark</span>(<span style=color:#a6e22e>chanparkcommit</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>), <span style=color:#a6e22e>waitReasonChanReceive</span>, <span style=color:#a6e22e>traceBlockChanRecv</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è¢«å”¤é†’äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;G waiting list is corrupted&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>activeStackChans</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>blockevent</span>(<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span><span style=color:#f92672>-</span><span style=color:#a6e22e>t0</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>success</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>success</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releaseSudog</span>(<span style=color:#a6e22e>mysg</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>success</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>recv</code> æ¥æ”¶æ•°æ®ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>recv</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>sg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>unlockf</span> <span style=color:#66d9ef>func</span>(), <span style=color:#a6e22e>skip</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ— ç¼“å†²çš„ channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>racesync</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿™é‡Œè¡¨ç¤ºï¼Œä»£ç ä¸­æ²¡æœ‰å¿½ç•¥è¦æ¥æ”¶çš„å€¼ï¼Œä¸æ˜¯ &#34;&lt;- ch&#34;ï¼Œè€Œæ˜¯ &#34;val &lt;- ch&#34;ï¼Œep æŒ‡å‘ val
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ç›´æ¥æ‹·è´æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>recvDirect</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ç¼“å†²å‹çš„ channelï¼Œä½†æ˜¯ buf å·²æ»¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// å°†åº•å±‚çš„å¾ªç¯æ•°ç»„ buf é˜Ÿé¦–çš„å…ƒç´ æ‹·è´åˆ°æ¥æ”¶æ•°æ®çš„åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// å°†å‘é€è€…çš„æ•°æ®æ”¾å…¥ buf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>qp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chanbuf</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#a6e22e>qp</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å°†å‘é€è€…æ•°æ®æ‹·è´åˆ° buf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>qp</span>, <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å¢åŠ  recvx ç´¢å¼•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// é‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>unlockf</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å”¤é†’å‘é€çš„ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>skip</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å…³é—­-channel-1>å…³é—­ channel
<a class=anchor href=#%e5%85%b3%e9%97%ad-channel-1>#</a></h3><p><code>close</code> å…³é—­ channel ä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢æˆ <code>closechan</code> å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/chan.go#L357
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>closechan</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å…³é—­ä¸€ä¸ª nil çš„ channelï¼Œpanic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;close of nil channel&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å…ˆåŠ é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// é‡å¤å…³é—­ï¼Œpanic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;close of closed channel&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// è®¾ç½® channel å…³é—­çš„æ ‡å¿—ä½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>glist</span> <span style=color:#a6e22e>gList</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°† channel ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—çš„é‡Œ sudog é‡Šæ”¾
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ä»æ¥æ”¶é˜Ÿåˆ—é‡Œå–å‡ºä¸€ä¸ª sudog
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>dequeue</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// æ¥æ”¶é˜Ÿåˆ—ç©ºäº†ï¼Œè·³å‡ºå¾ªç¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// è·å–æ¥æ”¶ goroutine çš„æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>raceacquireg</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>())
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// æ”¾å…¥é“¾è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>glist</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>gp</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å°† channel ç­‰å¾…å‘é€é˜Ÿåˆ—çš„é‡Œ sudog é‡Šæ”¾
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å¦‚æœå­˜åœ¨ï¼Œè¿™äº› goroutine å°†ä¼š panic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å¯ä»¥æŸ¥çœ‹ chansend å‡½æ•°ä¸­çš„é€»è¾‘ï¼š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å¯¹äºå‘é€è€…ï¼Œå¦‚æœè¢«å”¤é†’å channel å·²å…³é—­ï¼Œåˆ™ä¼š panic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä»å‘é€é˜Ÿåˆ—é‡Œå–å‡ºä¸€ä¸ª sudog
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>dequeue</span>()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å‘é€é˜Ÿåˆ—ç©ºäº†ï¼Œè·³å‡ºå¾ªç¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è·å–å‘é€ goroutine çš„æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>raceacquireg</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>())
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ”¾å…¥é“¾è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>glist</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>gp</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// é‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// éå†é“¾è¡¨ï¼Œå”¤é†’æ‰€æœ‰ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>glist</span>.<span style=color:#a6e22e>empty</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>glist</span>.<span style=color:#a6e22e>pop</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>schedlink</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>recvq</code> å’Œ <code>sendq</code> ä¸­çš„æ‰€æœ‰ goroutine è¢«å”¤é†’åï¼Œä¼šåˆ†åˆ«å»æ‰§è¡Œ <code>chanrecv</code> å’Œ <code>chansend</code> ä¸­ <code>gopark</code> åé¢çš„ä»£ç ã€‚</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/commit/c3f5fc9206b580b4993549de65beb4210f2967a9 title='Last modified by PengQi Shi | November 3, 2023' target=_blank rel=noopener><img src=/golang-learn/svg/calendar.svg class=book-icon alt=Calendar>
<span>November 3, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/edit/master/content/docs/concurrency/09_channel.md target=_blank rel=noopener><img src=/golang-learn/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#channel>Channel</a><ul><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a><ul><li><a href=#æ— ç¼“å†²-channel>æ— ç¼“å†² channel</a></li><li><a href=#å¸¦ç¼“å†²-channel>å¸¦ç¼“å†² channel</a></li><li><a href=#å…³é—­-channel>å…³é—­ channel</a></li><li><a href=#å•å‘-channel>å•å‘ channel</a></li><li><a href=#cap-å’Œ-len>cap å’Œ len</a></li><li><a href=#ä½¿ç”¨-range-éå†-channel>ä½¿ç”¨ range éå† channel</a></li><li><a href=#ä½¿ç”¨-channel-å®ç°äº’æ–¥é”>ä½¿ç”¨ channel å®ç°äº’æ–¥é”</a></li></ul></li><li><a href=#åŸç†>åŸç†</a><ul><li><a href=#åˆ›å»º-channel>åˆ›å»º channel</a></li><li><a href=#å‘-channel-å‘é€æ•°æ®>å‘ channel å‘é€æ•°æ®</a></li><li><a href=#ä»-channel-æ¥æ”¶æ•°æ®>ä» channel æ¥æ”¶æ•°æ®</a></li><li><a href=#å…³é—­-channel-1>å…³é—­ channel</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>