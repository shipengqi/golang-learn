<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Go Learning â€“ ğŸ” åº•å±‚åŸç†</title><link>https://shipengqi.github.io/golang-learn/docs/advance/</link><description>Recent content in ğŸ” åº•å±‚åŸç† on Go Learning</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><atom:link href="https://shipengqi.github.io/golang-learn/docs/advance/index.xml" rel="self" type="application/rss+xml"/><item><title>å‰ç½®çŸ¥è¯†</title><link>https://shipengqi.github.io/golang-learn/docs/advance/pre/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://shipengqi.github.io/golang-learn/docs/advance/pre/</guid><description/></item><item><title>è°ƒåº¦å™¨</title><link>https://shipengqi.github.io/golang-learn/docs/advance/scheduler/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://shipengqi.github.io/golang-learn/docs/advance/scheduler/</guid><description>
&lt;p>goroutine æ˜¯ Go å®ç°çš„ç”¨æˆ·æ€çº¿ç¨‹ï¼Œä¸»è¦ç”¨æ¥è§£å†³æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸¤ä¸ªæ–¹é¢çš„é—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>åˆ›å»ºå’Œåˆ‡æ¢å¤ªé‡ï¼šæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„åˆ›å»ºå’Œåˆ‡æ¢éƒ½éœ€è¦è¿›å…¥å†…æ ¸ï¼Œè€Œè¿›å…¥å†…æ ¸æ‰€æ¶ˆè€—çš„æ€§èƒ½ä»£ä»·æ¯”è¾ƒé«˜ï¼Œå¼€é”€è¾ƒå¤§ï¼›&lt;/li>
&lt;li>å†…å­˜ä½¿ç”¨å¤ªé‡ï¼šä¸€æ–¹é¢ï¼Œä¸ºäº†å°½é‡é¿å…æç«¯æƒ…å†µä¸‹æ“ä½œç³»ç»Ÿçº¿ç¨‹æ ˆçš„æº¢å‡ºï¼Œå†…æ ¸åœ¨åˆ›å»ºæ“ä½œç³»ç»Ÿçº¿ç¨‹æ—¶é»˜è®¤ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªè¾ƒå¤§çš„æ ˆå†…å­˜ï¼ˆè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå†…æ ¸å¹¶ä¸ä¼šä¸€å¼€å§‹å°±åˆ†é…è¿™ä¹ˆå¤šçš„ç‰©ç†å†…å­˜ï¼‰ï¼Œç„¶è€Œåœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç³»ç»Ÿçº¿ç¨‹è¿œè¿œç”¨ä¸äº†è¿™ä¹ˆå¤šå†…å­˜ï¼Œè¿™å¯¼è‡´äº†æµªè´¹ï¼›å¦ä¸€æ–¹é¢ï¼Œæ ˆå†…å­˜ç©ºé—´ä¸€æ—¦åˆ›å»ºå’Œåˆå§‹åŒ–å®Œæˆä¹‹åå…¶å¤§å°å°±ä¸èƒ½å†æœ‰å˜åŒ–ï¼Œè¿™å†³å®šäº†åœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ä¸‹ç³»ç»Ÿçº¿ç¨‹æ ˆè¿˜æ˜¯æœ‰æº¢å‡ºçš„é£é™©ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç”¨æˆ·æ€çš„ goroutine åˆ™è½»é‡å¾—å¤šï¼š&lt;/p>
&lt;ol>
&lt;li>goroutine æ˜¯ç”¨æˆ·æ€çº¿ç¨‹ï¼Œå…¶&lt;strong>åˆ›å»ºå’Œåˆ‡æ¢éƒ½åœ¨ç”¨æˆ·ä»£ç ä¸­å®Œæˆè€Œæ— éœ€è¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸&lt;/strong>ï¼Œæ‰€ä»¥å…¶å¼€é”€è¦è¿œè¿œå°äºç³»ç»Ÿçº¿ç¨‹çš„åˆ›å»ºå’Œåˆ‡æ¢ï¼›&lt;/li>
&lt;li>goroutine å¯åŠ¨æ—¶é»˜è®¤æ ˆå¤§å°åªæœ‰ 2kï¼Œè¿™åœ¨å¤šæ•°æƒ…å†µä¸‹å·²ç»å¤Ÿç”¨äº†ï¼Œå³ä½¿ä¸å¤Ÿç”¨ï¼Œgoroutine çš„æ ˆä¹Ÿä¼šè‡ªåŠ¨æ‰©å¤§ï¼ŒåŒæ—¶ï¼Œå¦‚æœæ ˆå¤ªå¤§äº†è¿‡äºæµªè´¹å®ƒè¿˜èƒ½è‡ªåŠ¨æ”¶ç¼©ï¼Œè¿™æ ·æ—¢æ²¡æœ‰æ ˆæº¢å‡ºçš„é£é™©ï¼Œä¹Ÿä¸ä¼šé€ æˆæ ˆå†…å­˜ç©ºé—´çš„å¤§é‡æµªè´¹ã€‚&lt;/li>
&lt;/ol>
&lt;h2>Go è°ƒåº¦çš„æœ¬è´¨&lt;span class="hx-absolute -hx-mt-20" id="go-è°ƒåº¦çš„æœ¬è´¨">&lt;/span>
&lt;a href="#go-%e8%b0%83%e5%ba%a6%e7%9a%84%e6%9c%ac%e8%b4%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Go è°ƒåº¦çš„æœ¬è´¨æ˜¯ä¸€ä¸ª&lt;strong>ç”Ÿäº§-æ¶ˆè´¹æµç¨‹&lt;/strong>ã€‚&lt;code>m&lt;/code> æ‹¿åˆ° goroutine å¹¶è¿è¡Œå®ƒçš„è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªæ¶ˆè´¹è¿‡ç¨‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.gitcode.com/shipengqi/illustrations/files/main/go/scheduler-queue.png" alt="scheduler-queue" loading="lazy" />&lt;/p>
&lt;p>ç”Ÿäº§å‡ºçš„ goroutine å°±æ”¾åœ¨å¯è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚å¯è¿è¡Œé˜Ÿåˆ—æ˜¯åˆ†ä¸ºä¸‰çº§ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>runnext&lt;/code>ï¼šå®é™…ä¸Šåªèƒ½æŒ‡å‘ä¸€ä¸ª goroutineã€‚&lt;/li>
&lt;li>&lt;code>local&lt;/code>ï¼šæ¯ä¸ª &lt;code>p&lt;/code> éƒ½æœ‰ä¸€ä¸ªæœ¬åœ°é˜Ÿåˆ—&lt;/li>
&lt;li>&lt;code>global&lt;/code>ï¼šå…¨å±€é˜Ÿåˆ—&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>å…ˆçœ‹ runnextï¼Œå†çœ‹ local queueï¼Œå†çœ‹ global queueã€‚å½“ç„¶ï¼Œå¦‚æœå®åœ¨æ‰¾ä¸åˆ°ï¼Œå°±å»å…¶ä»– &lt;code>p&lt;/code> å»å·&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;strong>goroutine æ”¾åˆ°å“ªä¸ªå¯è¿è¡Œé˜Ÿåˆ—ï¼Ÿ&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>å¦‚æœ &lt;code>runnext&lt;/code> ä¸ºç©ºï¼Œé‚£ä¹ˆ goroutine å°±ä¼šé¡ºåˆ©åœ°æ”¾å…¥ &lt;code>runnext&lt;/code>ï¼Œ&lt;code>runnext&lt;/code> ä¼˜å…ˆçº§æœ€é«˜ï¼Œæœ€å…ˆè¢«æ¶ˆè´¹&lt;/strong>ã€‚&lt;/li>
&lt;li>&lt;strong>&lt;code>runnext&lt;/code> ä¸ä¸ºç©ºï¼Œé‚£å°±å…ˆè´Ÿè´£æŠŠ &lt;code>runnext&lt;/code> ä¸Šçš„ old goroutine è¸¢èµ°ï¼Œå†æŠŠ new goroutine æ”¾ä¸Šæ¥&lt;/strong>ã€‚&lt;/li>
&lt;li>&lt;code>runnext&lt;/code> ä¸­è¢«è¸¢èµ°çš„ goroutineï¼Œ&lt;strong>åœ¨ local queue ä¸æ»¡æ—¶ï¼Œåˆ™å°†å®ƒæ”¾å…¥ local queue&lt;/strong>ï¼›å¦åˆ™æ„å‘³ç€ &lt;strong>local queue å·²æ»¡&lt;/strong>ï¼Œéœ€è¦å‡è´Ÿï¼Œä¼šå°†&lt;strong>å®ƒå’Œå½“å‰ &lt;code>p&lt;/code> çš„ local queue ä¸­çš„ä¸€åŠ goroutine ä¸€èµ·æ”¾åˆ° global queue ä¸­&lt;/strong>ã€‚&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;runtime&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GOMAXPROCS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">ch&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// è¾“å‡º
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 9
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 3
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 4
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 5
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 6
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 7
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 8
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// fatal error: all goroutines are asleep - deadlock!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// goroutine 1 [chan receive]:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// main.main()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// C:/Code/my-repos/example.v1/advance/scheduler/v1/main.go:18 +0x6c
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è¾“å‡ºçš„é¡ºåºï¼š&lt;code>9, 0, 1, 2, 3, 4, 5, 6, 7, 8&lt;/code>ã€‚è¿™å°±æ˜¯å› ä¸ºåªæœ‰ä¸€ä¸ª &lt;code>p&lt;/code>ï¼Œæ¯æ¬¡ç”Ÿäº§å‡ºæ¥çš„ goroutine éƒ½ä¼šç¬¬ä¸€æ—¶é—´å¡åˆ° &lt;code>runnext&lt;/code>ï¼Œè€Œ &lt;code>i&lt;/code> ä» &lt;code>1&lt;/code> å¼€å§‹ï¼Œ&lt;code>runnext&lt;/code> å·²ç»æœ‰ goroutine åœ¨äº†ï¼Œæ‰€ä»¥è¿™æ—¶ä¼šæŠŠ old goroutine ç§»åˆ° &lt;code>p&lt;/code> çš„æœ¬é˜Ÿé˜Ÿåˆ—ä¸­å»ï¼Œå†æŠŠ new goroutine æ”¾åˆ° &lt;code>runnext&lt;/code>ã€‚ä¹‹åä¼šé‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚&lt;/p>
&lt;p>å› æ­¤è¿™åå½“ä¸€æ¬¡ &lt;code>i&lt;/code> ä¸º &lt;code>9&lt;/code> æ—¶ï¼Œæ–° goroutine è¢«å¡åˆ° &lt;code>runnext&lt;/code>ï¼Œå…¶ä½™ goroutine éƒ½åœ¨æœ¬åœ°é˜Ÿåˆ—ã€‚&lt;/p>
&lt;p>ä¹‹åï¼Œmain goroutine æ‰§è¡Œäº†ä¸€ä¸ªè¯» channel çš„è¯­å¥ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½çš„è°ƒåº¦æ—¶æœºï¼šmain goroutine æŒ‚èµ·ï¼Œè¿è¡Œ &lt;code>p&lt;/code> çš„ &lt;code>runnext&lt;/code> å’Œæœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—é‡Œçš„ gorotuineã€‚&lt;/p></description></item><item><title>å†…å­˜ç®¡ç†</title><link>https://shipengqi.github.io/golang-learn/docs/advance/mm/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://shipengqi.github.io/golang-learn/docs/advance/mm/</guid><description/></item><item><title>ç½‘ç»œè½®è¯¢å™¨</title><link>https://shipengqi.github.io/golang-learn/docs/advance/04_netpooler/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://shipengqi.github.io/golang-learn/docs/advance/04_netpooler/</guid><description>
&lt;p>Go è¯­è¨€åœ¨ç½‘ç»œè½®è¯¢å™¨ä¸­ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨æ¨¡å‹å¤„ç† I/O æ“ä½œã€‚&lt;/p>
&lt;h2>I/O æ¨¡å‹&lt;span class="hx-absolute -hx-mt-20" id="io-æ¨¡å‹">&lt;/span>
&lt;a href="#io-%e6%a8%a1%e5%9e%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>é˜»å¡ I/O&lt;span class="hx-absolute -hx-mt-20" id="é˜»å¡-io">&lt;/span>
&lt;a href="#%e9%98%bb%e5%a1%9e-io" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>é˜»å¡ I/O æ˜¯æœ€å¸¸è§çš„ I/O æ¨¡å‹ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“é€šè¿‡ &lt;code>read&lt;/code> æˆ–è€… &lt;code>write&lt;/code> ç­‰ç³»ç»Ÿè°ƒç”¨è¯»å†™æ–‡ä»¶æˆ–è€…ç½‘ç»œæ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«é˜»å¡ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œå½“æ‰§è¡Œ &lt;code>read&lt;/code> ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€ï¼Œå†…æ ¸ä¼šæ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å¯è¯»ï¼›å½“æ–‡ä»¶æè¿°ç¬¦ä¸­å­˜åœ¨æ•°æ®æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šå°†å‡†å¤‡å¥½çš„æ•°æ®æ‹·è´ç»™åº”ç”¨ç¨‹åºå¹¶äº¤å›æ§åˆ¶æƒã€‚&lt;/p>
&lt;p>æ“ä½œç³»ç»Ÿä¸­å¤šæ•°çš„ I/O æ“ä½œéƒ½æ˜¯å¦‚ä¸Šæ‰€ç¤ºçš„é˜»å¡è¯·æ±‚ï¼Œä¸€æ—¦æ‰§è¡Œ I/O æ“ä½œï¼Œåº”ç”¨ç¨‹åºä¼šé™·å…¥é˜»å¡ç­‰å¾… I/O æ“ä½œçš„ç»“æŸã€‚&lt;/p>
&lt;h3>éé˜»å¡ I/O&lt;span class="hx-absolute -hx-mt-20" id="éé˜»å¡-io">&lt;/span>
&lt;a href="#%e9%9d%9e%e9%98%bb%e5%a1%9e-io" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>å½“è¿›ç¨‹æŠŠä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è®¾ç½®æˆéé˜»å¡æ—¶ï¼Œæ‰§è¡Œ &lt;code>read&lt;/code> å’Œ &lt;code>write&lt;/code> ç­‰ I/O æ“ä½œä¼šç«‹åˆ»è¿”å›ä¸€ä¸ª &lt;code>EAGAIN&lt;/code> é”™è¯¯ã€‚æ„å‘³ç€è¯¥æ–‡ä»¶æè¿°ç¬¦è¿˜åœ¨ç­‰å¾…ç¼“å†²åŒºä¸­çš„æ•°æ®ã€‚éšåï¼Œåº”ç”¨ç¨‹åºä¼šä¸æ–­&lt;strong>è½®è¯¢&lt;/strong>è°ƒç”¨ &lt;code>read&lt;/code> ç›´åˆ°å®ƒçš„è¿”å›å€¼å¤§äº 0ï¼Œè¿™æ—¶åº”ç”¨ç¨‹åºå°±å¯ä»¥å¯¹è¯»å–æ“ä½œç³»ç»Ÿç¼“å†²åŒºä¸­çš„æ•°æ®å¹¶è¿›è¡Œæ“ä½œã€‚&lt;/p>
&lt;h3>å¤šè·¯å¤ç”¨&lt;span class="hx-absolute -hx-mt-20" id="å¤šè·¯å¤ç”¨">&lt;/span>
&lt;a href="#%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>å¤šè·¯å¤ç”¨æ˜¯æŒ‡è¿›ç¨‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œèƒ½å¤Ÿé€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œã€‚&lt;/p>
&lt;p>ç³»ç»Ÿè°ƒç”¨ select ä¹Ÿå¯ä»¥æä¾› I/O å¤šè·¯å¤ç”¨çš„èƒ½åŠ›ï¼Œä½†æ˜¯ä½¿ç”¨å®ƒæœ‰æ¯”è¾ƒå¤šçš„é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>ç›‘å¬èƒ½åŠ›æœ‰é™ï¼šæœ€å¤šåªèƒ½ç›‘å¬ 1024 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼›&lt;/li>
&lt;li>å†…å­˜æ‹·è´å¼€é”€å¤§ï¼šéœ€è¦ç»´æŠ¤ä¸€ä¸ªè¾ƒå¤§çš„æ•°æ®ç»“æ„å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥ç»“æ„éœ€è¦æ‹·è´åˆ°å†…æ ¸ä¸­ï¼›&lt;/li>
&lt;li>æ—¶é—´å¤æ‚åº¦ &lt;code>O(n)&lt;/code>ï¼šè¿”å›å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ä¸ªæ•°åï¼Œéœ€è¦éå†æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼›&lt;/li>
&lt;/ul>
&lt;h4>epoll&lt;span class="hx-absolute -hx-mt-20" id="epoll">&lt;/span>
&lt;a href="#epoll" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>ä¸‰å¤§æ ¸å¿ƒç³»ç»Ÿè°ƒç”¨ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// åˆ›å»º epol å®ä¾‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">epoll_create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç®¡ç†ç›‘æ§åˆ—è¡¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">epoll_ctl&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">epfd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">op&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">epoll_event&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">event&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç­‰å¾…äº‹ä»¶å°±ç»ª
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">epoll_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">epfd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">epoll_event&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">events&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">maxevents&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">timeout&lt;/span>&lt;span class="p">);&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>Go çš„ç½‘ç»œè½®è¯¢å®ç°&lt;span class="hx-absolute -hx-mt-20" id="go-çš„ç½‘ç»œè½®è¯¢å®ç°">&lt;/span>
&lt;a href="#go-%e7%9a%84%e7%bd%91%e7%bb%9c%e8%bd%ae%e8%af%a2%e5%ae%9e%e7%8e%b0" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>ä¸åŒçš„æ“ä½œç³»ç»Ÿä¹Ÿéƒ½å®ç°äº†è‡ªå·±çš„ I/O å¤šè·¯å¤ç”¨å‡½æ•°ï¼Œä¾‹å¦‚ï¼š&lt;code>epoll&lt;/code>ã€&lt;code>kqueue&lt;/code> å’Œ &lt;code>evport&lt;/code> ç­‰ã€‚&lt;/p>
&lt;p>Go ä¸ºäº†æé«˜åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ“ä½œæ€§èƒ½ï¼Œä½¿ç”¨å¹³å°ç‰¹å®šçš„å‡½æ•°å®ç°äº†å¤šä¸ªç‰ˆæœ¬çš„ç½‘ç»œè½®è¯¢æ¨¡å—ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>src/runtime/netpoll_epoll.go&lt;/code>&lt;/li>
&lt;li>&lt;code>src/runtime/netpoll_kqueue.go&lt;/code>&lt;/li>
&lt;li>&lt;code>src/runtime/netpoll_solaris.go&lt;/code>&lt;/li>
&lt;li>&lt;code>src/runtime/netpoll_windows.go&lt;/code>&lt;/li>
&lt;li>&lt;code>src/runtime/netpoll_aix.go&lt;/code>&lt;/li>
&lt;li>&lt;code>src/runtime/netpoll_fake.go&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ Go ç¨‹åºæ—¶ï¼Œä¼šæ ¹æ®ç›®æ ‡å¹³å°é€‰æ‹©æ ‘ä¸­ç‰¹å®šçš„åˆ†æ”¯è¿›è¡Œç¼–è¯‘ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç›®æ ‡å¹³å°æ˜¯ Linuxï¼Œé‚£ä¹ˆå°±ä¼šæ ¹æ®æ–‡ä»¶ä¸­çš„ &lt;code>// +build linux&lt;/code> ç¼–è¯‘æŒ‡ä»¤é€‰æ‹© &lt;code>src/runtime/netpoll_epoll.go&lt;/code> å¹¶ä½¿ç”¨ &lt;code>epoll&lt;/code> å‡½æ•°å¤„ç†ç”¨æˆ·çš„ I/O æ“ä½œã€‚&lt;/p>
&lt;p>&lt;code>epoll&lt;/code>ã€&lt;code>kqueue&lt;/code> ç­‰å¤šè·¯å¤ç”¨æ¨¡å—éƒ½è¦å®ç°ä»¥ä¸‹äº”ä¸ªå‡½æ•°ï¼Œè¿™äº”ä¸ªå‡½æ•°æ„æˆä¸€ä¸ªæ¥å£ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// åˆå§‹åŒ–ç½‘ç»œè½®è¯¢å™¨ï¼Œé€šè¿‡ sync.Once å’Œ netpollInited å˜é‡ä¿è¯å‡½æ•°åªä¼šè°ƒç”¨ä¸€æ¬¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">netpollinit&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„è¾¹ç¼˜è§¦å‘äº‹ä»¶ï¼Œåˆ›å»ºäº‹ä»¶å¹¶åŠ å…¥ç›‘å¬
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">netpollopen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span> &lt;span class="kt">uintptr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pd&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">pollDesc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// è½®è¯¢ç½‘ç»œå¹¶è¿”å›ä¸€ç»„å·²ç»å‡†å¤‡å°±ç»ªçš„ goroutineï¼Œä¼ å…¥çš„å‚æ•°ä¼šå†³å®šå®ƒçš„è¡Œä¸º
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¦‚æœå‚æ•°å°äº 0ï¼Œæ— é™æœŸç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼›
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¦‚æœå‚æ•°ç­‰äº 0ï¼Œéé˜»å¡åœ°è½®è¯¢ç½‘ç»œï¼›
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¦‚æœå‚æ•°å¤§äº 0ï¼Œé˜»å¡ç‰¹å®šæ—¶é—´è½®è¯¢ç½‘ç»œï¼›
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">netpoll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">delta&lt;/span> &lt;span class="kt">int64&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">gList&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å”¤é†’ç½‘ç»œè½®è¯¢å™¨ï¼Œä¾‹å¦‚ï¼šè®¡æ—¶å™¨å‘å‰ä¿®æ”¹æ—¶é—´æ—¶ä¼šé€šè¿‡è¯¥å‡½æ•°ä¸­æ–­ç½‘ç»œè½®è¯¢å™¨4ï¼›
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">netpollBreak&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// åˆ¤æ–­æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¢«è½®è¯¢å™¨ä½¿ç”¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">netpollIsPollDescriptor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span> &lt;span class="kt">uintptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h4>åˆå§‹åŒ–&lt;span class="hx-absolute -hx-mt-20" id="åˆå§‹åŒ–">&lt;/span>
&lt;a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>&lt;code>runtime.netpollinit&lt;/code>ï¼Œå³ Linux ä¸Šçš„ &lt;code>epoll&lt;/code>ï¼Œå®ƒä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š&lt;/p>
&lt;ol>
&lt;li>æ˜¯è°ƒç”¨ &lt;code>epollcreate1&lt;/code> åˆ›å»ºä¸€ä¸ªæ–°çš„ &lt;code>epoll&lt;/code> æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¼šåœ¨æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨ï¼›&lt;/li>
&lt;li>é€šè¿‡ &lt;code>runtime.nonblockingPipe &lt;/code>åˆ›å»ºä¸€ä¸ªç”¨äºé€šä¿¡çš„ç®¡é“ï¼›&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>epollctl&lt;/code> å°†ç”¨äºè¯»å–æ•°æ®çš„æ–‡ä»¶æè¿°ç¬¦æ‰“åŒ…æˆ &lt;code>epollevent&lt;/code> äº‹ä»¶åŠ å…¥ç›‘å¬ï¼›&lt;/li>
&lt;/ol>
&lt;h4>goroutine ä¸ epoll çš„åä½œæµç¨‹&lt;span class="hx-absolute -hx-mt-20" id="goroutine-ä¸-epoll-çš„åä½œæµç¨‹">&lt;/span>
&lt;a href="#goroutine-%e4%b8%8e-epoll-%e7%9a%84%e5%8d%8f%e4%bd%9c%e6%b5%81%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>goroutine å‘èµ·ç½‘ç»œè¯»æ“ä½œï¼ˆå¦‚ &lt;code>conn.Read()&lt;/code>ï¼‰ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">buf&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1024&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// éé˜»å¡ I/Oï¼Œè§¦å‘ netpoller ä»‹å…¥
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>å½“ goroutine è°ƒç”¨ &lt;code>conn.Read()&lt;/code> æ—¶ï¼ŒGo çš„ net åŒ…ä¼šå…ˆå°è¯•&lt;strong>éé˜»å¡è¯»å–&lt;/strong>ï¼ˆ&lt;code>syscall.Read(fd, buf)&lt;/code>ï¼‰ã€‚&lt;/li>
&lt;li>å¦‚æœæ•°æ®æœªå°±ç»ªï¼ˆè¿”å› &lt;code>EAGAIN&lt;/code> é”™è¯¯ï¼‰ï¼ŒGo ä¼šå°†&lt;strong>æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰ æ³¨å†Œåˆ° epoll ç›‘å¬é˜Ÿåˆ—&lt;/strong>ï¼Œå¹¶å°†å½“å‰ goroutine é˜»å¡ã€‚&lt;/li>
&lt;/ul>
&lt;p>goroutine æŒ‚èµ·ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¼ªä»£ç ï¼šGo è¿è¡Œæ—¶å†…éƒ¨å¤„ç†
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EAGAIN&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å°† fd æ³¨å†Œåˆ° epollï¼Œå¹¶æŒ‚èµ·å½“å‰ Goroutine
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">netpollqueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">currentG&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">gopark&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// æŒ‚èµ· Goroutineï¼Œåˆ‡æ¢æ‰§è¡Œå…¶ä»–ä»»åŠ¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å°† fd å…³è”åˆ°å½“å‰ goroutine
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">netpollblock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span> &lt;span class="kt">uintptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pd&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getPollDesc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">setG&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">getg&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="c1">// å…³è”å½“å‰ Goroutine
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">gopark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">netpollblockcommit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pointer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pd&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">waitReasonIOWait&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>&lt;code>gopark()&lt;/code> å°†å½“å‰ goroutine ç½®ä¸º Gwaiting çŠ¶æ€ï¼Œå¹¶è®©å‡º CPU ç»™å…¶ä»– goroutineã€‚&lt;/li>
&lt;/ul>
&lt;p>epoll ç›‘å¬å°±ç»ªäº‹ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>åå°çš„ ç½‘ç»œè½®è¯¢å™¨çº¿ç¨‹ï¼ˆé€šå¸¸ç”± Go è¿è¡Œæ—¶å¯åŠ¨ï¼‰é€šè¿‡ &lt;code>epoll_wait&lt;/code> ç›‘å¬æ‰€æœ‰æ³¨å†Œçš„ fdã€‚&lt;/li>
&lt;li>å½“æ•°æ®åˆ°è¾¾æ—¶ï¼Œepoll è¿”å›å°±ç»ªçš„ fdï¼Œè½®è¯¢å™¨æ‰¾åˆ°å…³è”çš„ goroutineï¼Œå°†å…¶æ ‡è®°ä¸ºå¯è¿è¡Œï¼ˆGrunnableï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>goroutine æ¢å¤æ‰§è¡Œï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">netpoll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">delay&lt;/span> &lt;span class="kt">int64&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">events&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">epoll_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">epfd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ev&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">events&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pd&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">pollDesc&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="nx">ev&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">netpollready&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">toRun&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pd&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// å°†å…³è”çš„ Goroutine åŠ å…¥è¿è¡Œé˜Ÿåˆ—
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">toRun&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>è°ƒåº¦å™¨å°†å°±ç»ªçš„ goroutine æ”¾å…¥è¿è¡Œé˜Ÿåˆ—ï¼Œç­‰å¾… Mï¼ˆOS çº¿ç¨‹ï¼‰æ‰§è¡Œã€‚&lt;/li>
&lt;li>goroutine ä» &lt;code>gopark()&lt;/code> åç»§ç»­æ‰§è¡Œï¼Œå†æ¬¡è°ƒç”¨ &lt;code>syscall.Read&lt;/code>ï¼Œæ­¤æ—¶æ•°æ®å·²å°±ç»ªã€‚&lt;/li>
&lt;/ul></description></item><item><title>ç³»ç»Ÿç›‘æ§</title><link>https://shipengqi.github.io/golang-learn/docs/advance/05_sysmon/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://shipengqi.github.io/golang-learn/docs/advance/05_sysmon/</guid><description>
&lt;p>Go çš„ç³»ç»Ÿç›‘æ§ (sysmon) æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç‰¹æ®Šçº¿ç¨‹ï¼Œå®ƒåœ¨åå°æŒç»­è¿è¡Œï¼Œè´Ÿè´£å¤„ç†å„ç§è¿è¡Œæ—¶ç³»ç»Ÿçš„ç»´æŠ¤ä»»åŠ¡å’Œç›‘æ§å·¥ä½œã€‚å®ƒåœ¨å†…éƒ¨å¯åŠ¨äº†ä¸€ä¸ªä¸ä¼šä¸­æ­¢çš„å¾ªç¯ï¼Œåœ¨å¾ªç¯çš„å†…éƒ¨ä¼šè½®è¯¢ç½‘ç»œã€æŠ¢å é•¿æœŸè¿è¡Œæˆ–è€…å¤„äºç³»ç»Ÿè°ƒç”¨çš„ goroutine ä»¥åŠè§¦å‘åƒåœ¾å›æ”¶ï¼Œé€šè¿‡è¿™äº›è¡Œä¸ºï¼Œå®ƒèƒ½å¤Ÿè®©ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€å˜å¾—æ›´å¥åº·ã€‚&lt;/p>
&lt;p>&lt;code>runtime.main&lt;/code> å‡½æ•°ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">haveSysmon&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç°åœ¨æ‰§è¡Œçš„æ˜¯ main goroutineï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯ main goroutine çš„æ ˆï¼Œéœ€è¦åˆ‡æ¢åˆ° g0 æ ˆå»æ‰§è¡Œ newm()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">systemstack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ›å»ºä¸“ç”¨ç›‘æ§çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ç‹¬ç«‹äºè°ƒåº¦å™¨ï¼Œä¸éœ€è¦è·Ÿ p å…³è”å³å¯è¿è¡Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">newm&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sysmon&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>ç›‘æ§å¾ªç¯&lt;span class="hx-absolute -hx-mt-20" id="ç›‘æ§å¾ªç¯">&lt;/span>
&lt;a href="#%e7%9b%91%e6%8e%a7%e5%be%aa%e7%8e%af" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// runtime/proc.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">sysmon&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nmsys&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">checkdead&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ­»é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">lasttrace&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">int64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">idle&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c1">// how many cycles in succession we had not wokeup somebody
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">delay&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">uint32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åŠ¨æ€è°ƒæ•´ä¼‘çœ æ—¶é—´
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">idle&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">delay&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">20&lt;/span> &lt;span class="c1">// 20Î¼s
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">idle&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">50&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">delay&lt;/span> &lt;span class="o">*=&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="c1">// æŒ‡æ•°é€€é¿
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">delay&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">1000&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ä¸Šé™ 10ms
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">delay&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">usleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">delay&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ç³»ç»Ÿç›‘æ§åœ¨æ¯æ¬¡å¾ªç¯å¼€å§‹æ—¶éƒ½ä¼šé€šè¿‡ &lt;code>usleep&lt;/code> æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œè¯¥å‡½æ•°çš„å‚æ•°æ˜¯å¾®ç§’ã€‚&lt;/p>
&lt;ol>
&lt;li>åˆå§‹çš„ä¼‘çœ æ—¶é—´æ˜¯ 20Î¼sï¼›&lt;/li>
&lt;li>æœ€é•¿çš„ä¼‘çœ æ—¶é—´æ˜¯ 10msï¼›&lt;/li>
&lt;li>å½“ç³»ç»Ÿç›‘æ§åœ¨ 50 ä¸ªå¾ªç¯ä¸­éƒ½æ²¡æœ‰å”¤é†’ goroutine æ—¶ï¼Œä¼‘çœ æ—¶é—´åœ¨æ¯ä¸ªå¾ªç¯éƒ½ä¼šå€å¢ï¼›&lt;/li>
&lt;/ol>
&lt;p>å®ƒé™¤äº†ä¼šæ£€æŸ¥æ­»é”ä¹‹å¤–ï¼Œè¿˜ä¼šåœ¨å¾ªç¯ä¸­å®Œæˆä»¥ä¸‹çš„å·¥ä½œï¼š&lt;/p>
&lt;ul>
&lt;li>è¿è¡Œè®¡æ—¶å™¨ï¼šæ£€æŸ¥åº”ç”¨ç¨‹åºä¸­è®¾ç½®çš„è®¡æ—¶å™¨ï¼Œç¡®ä¿é‚£äº›éœ€è¦è¢«è§¦å‘çš„è®¡æ—¶å™¨ä¼šåœ¨åˆ°æœŸæ—¶é—´èƒ½å¤ŸåŠæ—¶è¿è¡Œã€‚å½“å‘ç°æœ‰è®¡æ—¶å™¨éœ€è¦è§¦å‘æ—¶ï¼Œ&lt;code>sysmon&lt;/code> ä¼šå”¤é†’ç©ºé—²çš„ &lt;code>p&lt;/code> å’Œ &lt;code>m&lt;/code> æ¥å¤„ç†è¿™äº›è®¡æ—¶å™¨äº‹ä»¶ï¼›&lt;/li>
&lt;li>è½®è¯¢ç½‘ç»œ â€” è·å–éœ€è¦å¤„ç†çš„åˆ°æœŸæ–‡ä»¶æè¿°ç¬¦ï¼›&lt;/li>
&lt;li>æŠ¢å å¤„ç†å™¨ â€” æŠ¢å è¿è¡Œæ—¶é—´è¾ƒé•¿çš„æˆ–è€…å¤„äºç³»ç»Ÿè°ƒç”¨çš„ goroutineï¼›&lt;/li>
&lt;li>åƒåœ¾å›æ”¶ â€” åœ¨æ»¡è¶³æ¡ä»¶æ—¶è§¦å‘åƒåœ¾æ”¶é›†å›æ”¶å†…å­˜ï¼›&lt;/li>
&lt;/ul>
&lt;h3>è¿è¡Œè®¡æ—¶å™¨&lt;span class="hx-absolute -hx-mt-20" id="è¿è¡Œè®¡æ—¶å™¨">&lt;/span>
&lt;a href="#%e8%bf%90%e8%a1%8c%e8%ae%a1%e6%97%b6%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åœ¨ç³»ç»Ÿç›‘æ§çš„å¾ªç¯ä¸­ï¼Œé€šè¿‡ &lt;code>runtime.nanotime&lt;/code> å’Œ &lt;code>runtime.timeSleepUntil&lt;/code> è·å–å½“å‰æ—¶é—´å’Œè®¡æ—¶å™¨ä¸‹ä¸€æ¬¡éœ€è¦å”¤é†’çš„æ—¶é—´ã€‚&lt;/p>
&lt;p>ç³»ç»Ÿç›‘æ§å†ä¸‹é¢çš„æƒ…å†µä¸‹ä¼šé™·å…¥ä¼‘çœ ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>å½“å‰è°ƒåº¦å™¨éœ€è¦æ‰§è¡Œåƒåœ¾å›æ”¶&lt;/strong>ã€‚&lt;/li>
&lt;li>æ‰€æœ‰å¤„ç†å™¨éƒ½å¤„äºé—²ç½®çŠ¶æ€æ—¶ã€‚&lt;/li>
&lt;li>æ²¡æœ‰éœ€è¦è§¦å‘çš„è®¡æ—¶å™¨ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä¼‘çœ çš„æ—¶é—´ä¼šä¾æ®å¼ºåˆ¶ GC çš„å‘¨æœŸ &lt;code>forcegcperiod&lt;/code> å’Œè®¡æ—¶å™¨ä¸‹æ¬¡è§¦å‘çš„æ—¶é—´ç¡®å®šã€‚&lt;/p>
&lt;h3>è½®è¯¢ç½‘ç»œ&lt;span class="hx-absolute -hx-mt-20" id="è½®è¯¢ç½‘ç»œ">&lt;/span>
&lt;a href="#%e8%bd%ae%e8%af%a2%e7%bd%91%e7%bb%9c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>å¦‚æœä¸Šä¸€æ¬¡è½®è¯¢ç½‘ç»œå·²ç»è¿‡å»äº† 10msï¼Œé‚£ä¹ˆç³»ç»Ÿç›‘æ§è¿˜ä¼šåœ¨å¾ªç¯ä¸­è½®è¯¢ç½‘ç»œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¾…æ‰§è¡Œçš„æ–‡ä»¶æè¿°ç¬¦ã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// runtime/proc.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">sysmon&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">lastpoll&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">int64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Load64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lastpoll&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nf">netpollinited&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">lastpoll&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">lastpoll&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">1000&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">now&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Cas64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lastpoll&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">uint64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lastpoll&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">uint64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">list&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">netpoll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">empty&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">incidlelocked&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">injectglist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">incidlelocked&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>éé˜»å¡åœ°è°ƒç”¨ &lt;code>runtime.netpoll&lt;/code> æ£€æŸ¥å¾…æ‰§è¡Œçš„æ–‡ä»¶æè¿°ç¬¦å¹¶é€šè¿‡ &lt;code>runtime.injectglist&lt;/code> å°†æ‰€æœ‰å¤„äºå°±ç»ªçŠ¶æ€çš„ goroutine åŠ å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">injectglist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">glist&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gList&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">glist&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">empty&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">glist&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">empty&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">glist&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">pop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">casgstatus&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_Gwaiting&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_Grunnable&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">globrunqput&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">npidle&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="o">--&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">startm&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="nx">glist&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">gList&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è¯¥å‡½æ•°ä¼šå°†æ‰€æœ‰ goroutine çš„çŠ¶æ€ä» &lt;code>_Gwaiting&lt;/code> åˆ‡æ¢è‡³ &lt;code>_Grunnable&lt;/code> å¹¶åŠ å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—ç­‰å¾…è¿è¡Œï¼Œå¦‚æœå½“å‰ç¨‹åºä¸­å­˜åœ¨ç©ºé—²çš„ &lt;code>p&lt;/code>ï¼Œä¼šé€šè¿‡ &lt;code>runtime.startm&lt;/code> å¯åŠ¨çº¿ç¨‹æ¥æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚&lt;/p>
&lt;h3>æŠ¢å å¤„ç†&lt;span class="hx-absolute -hx-mt-20" id="æŠ¢å å¤„ç†">&lt;/span>
&lt;a href="#%e6%8a%a2%e5%8d%a0%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>ç³»ç»Ÿç›‘æ§ä¼šåœ¨å¾ªç¯ä¸­è°ƒç”¨ &lt;code>runtime.retake&lt;/code> æŠ¢å å¤„äºè¿è¡Œæˆ–è€…ç³»ç»Ÿè°ƒç”¨ä¸­çš„ &lt;code>p&lt;/code>ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// runtime/proc.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">sysmon&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// retake P&amp;#39;s blocked in syscalls
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// and preempt long running G&amp;#39;s
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nf">retake&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">idle&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">idle&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>reatke&lt;/code> å‡½æ•°ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">sysmontick&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">schedtick&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="c1">// p çš„è°ƒåº¦æ¬¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">schedwhen&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="c1">// p çš„ä¸Šæ¬¡è°ƒåº¦æ—¶é—´
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">syscalltick&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="c1">// ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">syscallwhen&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="c1">// ä¸Šæ¬¡ç³»ç»Ÿè°ƒç”¨æ—¶é—´
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">retake&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span> &lt;span class="kt">int64&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Prevent allp slice changes. This lock will be completely
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// uncontended unless we&amp;#39;re already stopping the world.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">allpLock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// éå†æ‰€æœ‰çš„ p
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">allp&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">allp&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">pp&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// This can happen if procresize has grown
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// allp but not yet created new Ps.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pd&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">pp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sysmontick&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">pp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sysretake&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å½“ p å¤„äº _Prunning æˆ–è€… _Psyscall çŠ¶æ€æ—¶ï¼Œå¦‚æœä¸Šä¸€æ¬¡è§¦å‘è°ƒåº¦çš„æ—¶é—´å·²ç»è¿‡å»äº† 10msï¼Œé€šè¿‡ runtime.preemptone æŠ¢å å½“å‰ p
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">_Prunning&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">_Psyscall&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Preempt G if it&amp;#39;s running on the same schedtick for
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// too long. This could be from a single long-running
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// goroutine or a sequence of goroutines run via
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// runnext, which share a single schedtick time slice.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">t&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">int64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">schedtick&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// schedtick è¡¨ç¤º p çš„è°ƒåº¦æ¬¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nb">int64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">schedtick&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">t&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">schedtick&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">uint32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">schedwhen&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">now&lt;/span> &lt;span class="c1">// schedwhen è¡¨ç¤º p ä¸Šæ¬¡è°ƒåº¦æ—¶é—´
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">schedwhen&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">forcePreemptNS&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="nx">now&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ä¸Šä¸€æ¬¡è§¦å‘è°ƒåº¦çš„æ—¶é—´å·²ç»è¶…è¿‡äº† 10ms
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">preemptone&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// In case of syscall, preemptone() doesn&amp;#39;t
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// work, because there is no M wired to P.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">sysretake&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å½“ p å¤„äº _Psyscall çŠ¶æ€æ—¶
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">_Psyscall&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// On the one hand we don&amp;#39;t want to retake Ps if there is no other work to do,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// but on the other hand we want to retake them eventually
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// because they can prevent the sysmon thread from deep sleep.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// åˆ¤æ–­å½“äº² p çš„è¿è¡Œé˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// æ˜¯å¦å­˜åœ¨ç©ºé—²çš„ p
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ç³»ç»Ÿè°ƒç”¨æ—¶é—´æ˜¯å¦è¶…è¿‡äº† 10ms
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nf">runqempty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pp&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nmspinning&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Load&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">sched&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">npidle&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Load&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">syscallwhen&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">1000&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nx">now&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Drop allpLock so we can take sched.lock.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">allpLock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Need to decrement number of idle locked M&amp;#39;s
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// (pretending that one more is running) before the CAS.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// Otherwise the M from which we retake can exit the syscall,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// increment nmidle and report deadlock.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">incidlelocked&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">trace&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">traceAcquire&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Cas&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">pp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_Pidle&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">trace&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ok&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">trace&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ProcSteal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">traceRelease&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">trace&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">n&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">syscalltick&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">handoffp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">trace&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ok&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">traceRelease&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">trace&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">incidlelocked&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">allpLock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">allpLock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">uint32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ol>
&lt;li>å½“å¤„ &lt;code>p&lt;/code> å¤„äº &lt;code>_Prunning&lt;/code> æˆ–è€… &lt;code>_Psyscall&lt;/code> çŠ¶æ€æ—¶ï¼Œå¦‚æœä¸Šä¸€æ¬¡è§¦å‘è°ƒåº¦çš„æ—¶é—´å·²ç»è¿‡å»äº† 10msï¼Œé€šè¿‡ &lt;code>runtime.preemptone&lt;/code> æŠ¢å å½“å‰ &lt;code>p&lt;/code>ï¼›&lt;/li>
&lt;li>å½“ &lt;code>p&lt;/code> å¤„äº &lt;code>_Psyscall&lt;/code> çŠ¶æ€æ—¶ï¼Œåœ¨æ»¡è¶³ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä¼šè°ƒç”¨ &lt;code>runtime.handoffp&lt;/code> è®©å‡º &lt;code>p&lt;/code> çš„ä½¿ç”¨æƒï¼š
&lt;ul>
&lt;li>&lt;strong>å½“ &lt;code>p&lt;/code> çš„è¿è¡Œé˜Ÿåˆ—ä¸ä¸ºç©ºæˆ–è€…ä¸å­˜åœ¨ç©ºé—²çš„ &lt;code>p&lt;/code> æ—¶&lt;/strong>ï¼ˆè¿è¡Œé˜Ÿåˆ—ä¸ä¸ºç©ºè¯´æ˜è¿˜æœ‰ goroutine ç­‰å¾…è¿è¡Œï¼›æ²¡æœ‰ç©ºé—²çš„ &lt;code>p&lt;/code> è¯´æ˜æœ‰ç‚¹å¿™ï¼‰ï¼›&lt;/li>
&lt;li>&lt;strong>å½“ç³»ç»Ÿè°ƒç”¨æ—¶é—´è¶…è¿‡äº† 10ms æ—¶&lt;/strong>ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>è¢«æŠ¢å çš„ goroutineï¼ŒçŠ¶æ€ä» &lt;code>Grunning&lt;/code> å˜ä¸º &lt;code>Grunnable&lt;/code>ï¼Œç„¶åè¢«æ”¾å›å…¨å±€è¿è¡Œé˜Ÿåˆ—ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;code>preemptone&lt;/code> å‡½æ•°çš„ä¸»è¦æµç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>è®¾ç½®å½“å‰ goroutine çš„æŠ¢å æ ‡å¿— &lt;code>gp.preempt&lt;/code> ä¸º &lt;code>true&lt;/code>ï¼›&lt;/li>
&lt;li>å¼‚æ­¥æŠ¢å ,å‘é€ &lt;code>SIGURG&lt;/code> ä¿¡å·;&lt;/li>
&lt;li>ä¿¡å·å¤„ç†ç¨‹åºä¿å­˜ä¸Šä¸‹æ–‡;&lt;/li>
&lt;li>æ‰§è¡Œè°ƒåº¦;&lt;/li>
&lt;/ol>
&lt;p>&lt;code>handoffp&lt;/code> å‡½æ•°çš„ä¸»è¦æµç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>è§£é™¤ &lt;code>p&lt;/code> å’Œ &lt;code>m&lt;/code> çš„ç»‘å®šå…³ç³»ï¼Œè®¾ç½® &lt;code>p&lt;/code> çŠ¶æ€ä¸º&lt;code> _Pidle&lt;/code>ï¼›&lt;/li>
&lt;li>å¯åŠ¨ä¸€ä¸ªæ–°çš„ &lt;code>m&lt;/code>ï¼Œç»‘å®šåˆ° &lt;code>p&lt;/code> ä¸Šï¼›&lt;/li>
&lt;li>åˆ‡æ¢åˆ°æ–°çš„ &lt;code>m&lt;/code> è¿è¡Œï¼Œæ‰§è¡Œè°ƒåº¦ï¼›&lt;/li>
&lt;/ol>
&lt;h4>ä¿¡å·æŠ¢å çš„æµç¨‹&lt;span class="hx-absolute -hx-mt-20" id="ä¿¡å·æŠ¢å çš„æµç¨‹">&lt;/span>
&lt;a href="#%e4%bf%a1%e5%8f%b7%e6%8a%a2%e5%8d%a0%e7%9a%84%e6%b5%81%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;pre>&lt;code>sysmon(æ£€æµ‹è¶…æ—¶) â†’ preemptone() â†’ preemptM() â†’ å‘é€ SIGURG â†’
ä¿¡å·å¤„ç†ç¨‹åº â†’ asyncPreempt â†’ asyncPreempt2 â†’ mcall(gopreempt_m) â†’ æŠ¢å  goroutine â†’ æ‰§è¡Œè°ƒåº¦&lt;/code>&lt;/pre>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>åƒåœ¾å›æ”¶&lt;span class="hx-absolute -hx-mt-20" id="åƒåœ¾å›æ”¶">&lt;/span>
&lt;a href="#%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åœ¨æœ€åï¼Œç³»ç»Ÿç›‘æ§è¿˜ä¼šå†³å®šæ˜¯å¦éœ€è¦è§¦å‘å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼Œ&lt;code>runtime.sysmon&lt;/code> ä¼šæ„å»º &lt;code>runtime.gcTrigger&lt;/code> å¹¶è°ƒç”¨ &lt;code>runtime.gcTrigger.test&lt;/code> æ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦è§¦å‘åƒåœ¾å›æ”¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">sysmon&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">t&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">gcTrigger&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">kind&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gcTriggerTime&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">});&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">test&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">forcegc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">idle&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">forcegc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">forcegc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">idle&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">list&lt;/span> &lt;span class="nx">gList&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">forcegc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">g&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">injectglist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">forcegc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¦‚æœéœ€è¦è§¦å‘åƒåœ¾å›æ”¶ï¼Œä¼š&lt;strong>å°†ç”¨äºåƒåœ¾å›æ”¶çš„ goroutine åŠ å…¥å…¨å±€é˜Ÿåˆ—ï¼Œè®©è°ƒåº¦å™¨é€‰æ‹©åˆé€‚çš„ &lt;code>p&lt;/code> å»æ‰§è¡Œ&lt;/strong>ã€‚&lt;/p></description></item></channel></rss>