<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Go 性能分析 # PProf 是 Go 提供的用于可视化和分析性能分析数据的工具。
runtime/pprof：采集程序（非 Server）的运行数据进行分析 net/http/pprof：采集 HTTP Server 的运行时数据进行分析 主要可以用于：
CPU Profiling：CPU 分析，按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期 时花费时间的位置。 Memory Profiling：内存分析，在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏。 Block Profiling：阻塞分析，记录 goroutine 阻塞等待同步（包括定时器通道）的位置。 Mutex Profiling：互斥锁分析，报告互斥锁的竞争情况。 性能分析 # 分析 HTTP Server # Web # import ( &#34;log&#34; &#34;net/http&#34; _ &#34;net/http/pprof&#34; ) var datas []string func Add(str string) string { data := []byte(str) sData := string(data) datas = append(datas, sData) return sData } func main() { go func() { for { log."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Go 性能分析"><meta property="og:description" content="Go 性能分析 # PProf 是 Go 提供的用于可视化和分析性能分析数据的工具。
runtime/pprof：采集程序（非 Server）的运行数据进行分析 net/http/pprof：采集 HTTP Server 的运行时数据进行分析 主要可以用于：
CPU Profiling：CPU 分析，按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期 时花费时间的位置。 Memory Profiling：内存分析，在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏。 Block Profiling：阻塞分析，记录 goroutine 阻塞等待同步（包括定时器通道）的位置。 Mutex Profiling：互斥锁分析，报告互斥锁的竞争情况。 性能分析 # 分析 HTTP Server # Web # import ( &#34;log&#34; &#34;net/http&#34; _ &#34;net/http/pprof&#34; ) var datas []string func Add(str string) string { data := []byte(str) sData := string(data) datas = append(datas, sData) return sData } func main() { go func() { for { log."><meta property="og:type" content="article"><meta property="og:url" content="https://shipengqi.github.io/golang-learn/docs/practice/04_pprof/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-10-15T17:52:38+08:00"><title>Go 性能分析 | Go Learning</title><link rel=manifest href=/golang-learn/manifest.json><link rel=icon href=/golang-learn/favicon.png><link rel=stylesheet href=/golang-learn/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/golang-learn/flexsearch.min.js></script>
<script defer src=/golang-learn/en.search.min.ba0b0d3a0587c533dd25391aa4ba8d81cdb07d80534438536c6592a0da5c5caf.js integrity="sha256-ugsNOgWHxTPdJTkapLqNgc2wfYBTRDhTbGWSoNpcXK8=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/golang-learn/><span>Go Learning</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://shipengqi.github.io/ target=_blank rel=noopener>Blog</a></li><li><a href=https://github.com/shipengqi/golang-learn target=_blank rel=noopener>Github</a></li></ul><ul><li><span>🍚 语言基础</span><ul><li><a href=/golang-learn/docs/basic/01_basic_type/>基础数据类型</a></li><li><a href=/golang-learn/docs/basic/02_array/>数组</a></li><li><a href=/golang-learn/docs/basic/03_slice/>切片</a></li><li><a href=/golang-learn/docs/basic/04_map/>哈希表</a></li><li><a href=/golang-learn/docs/basic/05_function/>函数</a></li><li><a href=/golang-learn/docs/basic/09_pointer/>指针</a></li></ul></li><li><a href=/golang-learn/docs/concurrency/>⚡ 并发编程</a><ul><li><a href=/golang-learn/docs/concurrency/01_mutex/>互斥锁</a></li><li><a href=/golang-learn/docs/concurrency/02_rwmutex/>读写锁</a></li><li><a href=/golang-learn/docs/concurrency/03_waitgroup/>WaitGroup</a></li><li><a href=/golang-learn/docs/concurrency/04_cond/>条件变量</a></li><li><a href=/golang-learn/docs/concurrency/05_once/>Once</a></li><li><a href=/golang-learn/docs/concurrency/06_pool/>Pool</a></li><li><a href=/golang-learn/docs/concurrency/07_context/>Context</a></li><li><a href=/golang-learn/docs/concurrency/08_atomic/>原子操作</a></li><li><a href=/golang-learn/docs/concurrency/09_channel/>Channel</a></li><li><a href=/golang-learn/docs/concurrency/10_sema/>信号量</a></li><li><a href=/golang-learn/docs/concurrency/11_singleflight/>SingleFlight</a></li><li><a href=/golang-learn/docs/concurrency/12_errorgroup/>ErrGroup</a></li></ul></li><li><span>🛠️ 实践</span><ul><li><a href=/golang-learn/docs/practice/01_build/>Go 编译</a></li><li><a href=/golang-learn/docs/practice/02_go_race/>Go 数据竞争检测器</a></li><li><a href=/golang-learn/docs/practice/04_pprof/ class=active>Go 性能分析</a></li><li><a href=/golang-learn/docs/practice/05_performance/>Go 性能优化</a></li><li><a href=/golang-learn/docs/practice/06_trace/>Go Trace</a></li><li><a href=/golang-learn/docs/practice/07_coredump/>Go CoreDump 调试</a></li><li><a href=/golang-learn/docs/practice/08_mod/>Go Modules</a></li><li><a href=/golang-learn/docs/practice/09_gin/>Gin 静态服务器</a></li></ul></li><li><span>🛠️ Go 工程实践</span><ul><li><a href=/golang-learn/docs/project/01_structure/>项目的目录结构</a></li><li><a href=/golang-learn/docs/project/02_commitizen/>Commit 规范</a></li><li><a href=/golang-learn/docs/project/03_gsemver/>版本规范</a></li><li><a href=/golang-learn/docs/project/04_flow/>Git 工作流程</a></li><li><a href=/golang-learn/docs/project/05_api/>API 风格</a></li><li><a href=/golang-learn/docs/project/06_api_doc/>API 文档</a></li><li><a href=/golang-learn/docs/project/07_make/>make</a></li><li><a href=/golang-learn/docs/project/08_github_actions/>基于 GitHub Actions 的 CI/CD</a></li></ul></li><li><a href=/golang-learn/docs/advance/>🔍 底层原理</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/golang-learn/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Go 性能分析</strong>
<label for=toc-control><img src=/golang-learn/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#go-性能分析>Go 性能分析</a><ul><li><a href=#性能分析>性能分析</a><ul><li><a href=#分析-http-server>分析 HTTP Server</a></li></ul></li><li><a href=#pprof-可视化界面>PProf 可视化界面</a><ul><li><a href=#安裝-graphviz>安裝 Graphviz</a></li><li><a href=#配置环境变量>配置环境变量</a></li><li><a href=#验证>验证</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=go-性能分析>Go 性能分析
<a class=anchor href=#go-%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90>#</a></h1><p>PProf 是 Go 提供的用于可视化和分析性能分析数据的工具。</p><ul><li><code>runtime/pprof</code>：采集程序（非 Server）的运行数据进行分析</li><li><code>net/http/pprof</code>：采集 HTTP Server 的运行时数据进行分析</li></ul><p>主要可以用于：</p><ul><li>CPU Profiling：CPU 分析，按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期
时花费时间的位置。</li><li>Memory Profiling：内存分析，在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏。</li><li>Block Profiling：阻塞分析，记录 goroutine 阻塞等待同步（包括定时器通道）的位置。</li><li>Mutex Profiling：互斥锁分析，报告互斥锁的竞争情况。</li></ul><h2 id=性能分析>性能分析
<a class=anchor href=#%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90>#</a></h2><h3 id=分析-http-server>分析 HTTP Server
<a class=anchor href=#%e5%88%86%e6%9e%90-http-server>#</a></h3><h4 id=web>Web
<a class=anchor href=#web>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;net/http/pprof&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>datas</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>str</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#a6e22e>str</span>)
</span></span><span style=display:flex><span> <span style=color:#a6e22e>sData</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span> <span style=color:#a6e22e>datas</span> = append(<span style=color:#a6e22e>datas</span>, <span style=color:#a6e22e>sData</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sData</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;https://github.com/shipengqi&#34;</span>))
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span> }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;0.0.0.0:8080&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>注意要引入 <code>_ "net/http/pprof"</code>，这样程序运行以后，就会自动添加 <code>/debug/pprof</code> 的路由，可以
访问 <code>ttp://127.0.0.1:8080/debug/pprof/</code>。</p><p><img src=../imgs/profile1.png alt=profile></p><ul><li>alloc: 查看所有内存分配的情况</li><li>block（Block Profiling）：<code>$HOST/debug/pprof/block</code>，查看导致阻塞同步的堆栈跟踪</li><li>cmdline : 当前程序的命令行调用</li><li>goroutine：<code>$HOST/debug/pprof/goroutine</code>，查看当前所有运行的 goroutines 堆栈跟踪</li><li>heap（Memory Profiling）: <code>$HOST/debug/pprof/heap</code>，查看活动对象的内存分配情况，在获取堆样本之前，可以指定 gc GET 参数来运行 gc。</li><li>mutex（Mutex Profiling）: <code>$HOST/debug/pprof/mutex</code>，查看导致互斥锁的竞争持有者的堆栈跟踪</li><li>profile: <code>$HOST/debug/pprof/profile</code>， 默认进行 30s 的 CPU Profiling，可以 GET 参数 <code>seconds</code> 中指定持续时间。
获得 profile 文件之后，使用 <code>go tool pprof</code> 命令分析 profile 文件。</li><li>threadcreate：<code>$HOST/debug/pprof/threadcreat</code>e，查看创建新 OS 线程的堆栈跟踪</li><li>trace: 当前程序的执行轨迹。可以在 GET 参数 <code>seconds</code> 中指定持续时间。获取跟踪文件之后，使用 <code>go tool trace</code> 命令来分析。</li></ul><h4 id=交互式终端>交互式终端
<a class=anchor href=#%e4%ba%a4%e4%ba%92%e5%bc%8f%e7%bb%88%e7%ab%af>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># seconds 可以调整等待的时间，当前命令设置等待 60 秒后会进行 CPU Profiling</span>
</span></span><span style=display:flex><span>go tool pprof http://localhost:8080/debug/pprof/profile?seconds<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Fetching profile over HTTP from http://localhost:6060/debug/pprof/profile?seconds<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng.CORPDOM<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.samples.cpu.001.pb.gz
</span></span><span style=display:flex><span>Type: cpu
</span></span><span style=display:flex><span>Time: Nov 18, <span style=color:#ae81ff>2019</span> at 11:08am <span style=color:#f92672>(</span>CST<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Duration: 10.20s, Total samples <span style=color:#f92672>=</span> 10.03s <span style=color:#f92672>(</span>98.38%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Entering interactive mode <span style=color:#f92672>(</span>type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> commands, <span style=color:#e6db74>&#34;o&#34;</span> <span style=color:#66d9ef>for</span> options<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 进入交互式命令模式</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> top <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Showing nodes accounting <span style=color:#66d9ef>for</span> 9.54s, 95.11% of 10.03s total
</span></span><span style=display:flex><span>Dropped <span style=color:#ae81ff>73</span> nodes <span style=color:#f92672>(</span>cum &lt;<span style=color:#f92672>=</span> 0.05s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Showing top <span style=color:#ae81ff>10</span> nodes out of <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>      flat  flat%   sum%        cum   cum%
</span></span><span style=display:flex><span>     9.42s 93.92% 93.92%      9.46s 94.32%  runtime.cgocall
</span></span><span style=display:flex><span>     0.02s   0.2% 94.12%      9.62s 95.91%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.writeConsole
</span></span><span style=display:flex><span>     0.02s   0.2% 94.32%      9.81s 97.81%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.Output
</span></span><span style=display:flex><span>     0.02s   0.2% 94.52%      0.10s     1%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.formatHeader
</span></span><span style=display:flex><span>     0.02s   0.2% 94.72%      0.06s   0.6%  main.Add
</span></span><span style=display:flex><span>     0.02s   0.2% 94.92%      9.50s 94.72%  syscall.Syscall6
</span></span><span style=display:flex><span>     0.01s   0.1% 95.01%      0.07s   0.7%  runtime.systemstack
</span></span><span style=display:flex><span>     0.01s   0.1% 95.11%      9.51s 94.82%  syscall.WriteConsole
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0% 95.11%      0.07s   0.7%  fmt.Sprintln
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0% 95.11%      9.69s 96.61%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.Write
</span></span></code></pre></div><p>上面的输出：</p><ul><li><code>flat</code>：给定函数上运行耗时</li><li><code>flat%</code>：同上的 CPU 运行耗时总比例</li><li><code>sum%</code>：给定函数累积使用 CPU 总比例</li><li><code>cum</code>：当前函数加上它之上的调用运行总耗时</li><li><code>cum%</code>：同上的 CPU 运行耗时总比例</li><li>最后一列为函数名称</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go tool pprof http://localhost:6060/debug/pprof/heap
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Fetching profile over HTTP from http://localhost:6060/debug/pprof/heap
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng.CORPDOM<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.alloc_objects.alloc_space.inuse_objects.inuse_space.008.pb.gz
</span></span><span style=display:flex><span>Type: inuse_space
</span></span><span style=display:flex><span>Entering interactive mode <span style=color:#f92672>(</span>type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> commands, <span style=color:#e6db74>&#34;o&#34;</span> <span style=color:#66d9ef>for</span> options<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> top
</span></span><span style=display:flex><span>Showing nodes accounting <span style=color:#66d9ef>for</span> 837.48MB, 100% of 837.48MB total
</span></span><span style=display:flex><span>      flat  flat%   sum%        cum   cum%
</span></span><span style=display:flex><span>  837.48MB   100%   100%   837.48MB   100%  main.main.func1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 其他分析</span>
</span></span><span style=display:flex><span>go tool pprof http://localhost:6060/debug/pprof/block
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>go tool pprof http://localhost:6060/debug/pprof/mutex
</span></span></code></pre></div><ul><li><code>-inuse_space</code>：分析应用程序的常驻内存占用情况</li><li><code>-alloc_objects</code>：分析应用程序的内存临时分配情况</li></ul><h2 id=pprof-可视化界面>PProf 可视化界面
<a class=anchor href=#pprof-%e5%8f%af%e8%a7%86%e5%8c%96%e7%95%8c%e9%9d%a2>#</a></h2><p><code>data.go</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>pdata</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>datas</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>str</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#a6e22e>str</span>)
</span></span><span style=display:flex><span> <span style=color:#a6e22e>sData</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span> <span style=color:#a6e22e>datas</span> = append(<span style=color:#a6e22e>datas</span>, <span style=color:#a6e22e>sData</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sData</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>data_test.go</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>pdata</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;https://github.com/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestAdd</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Test.Add error!&#34;</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkAdd</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>运行基准测试：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 下面的命令会生成 cprof 文件, 使用 go tool pprof 分析</span>
</span></span><span style=display:flex><span>go test -bench . -cpuprofile<span style=color:#f92672>=</span>cprof
</span></span><span style=display:flex><span>goos: windows
</span></span><span style=display:flex><span>goarch: amd64
</span></span><span style=display:flex><span>pkg: github.com/shipengqi/golang-learn/demos/pprof/pdata
</span></span><span style=display:flex><span>BenchmarkAdd-8          <span style=color:#ae81ff>10084636</span>               <span style=color:#ae81ff>143</span> ns/op
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      github.com/shipengqi/golang-learn/demos/pprof/pdata     2.960s
</span></span></code></pre></div><p>启动可视化界面：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ go tool pprof -http<span style=color:#f92672>=</span>:8080 cpu.prof
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 或者</span>
</span></span><span style=display:flex><span>$ go tool pprof cpu.prof
</span></span><span style=display:flex><span>$ <span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> web
</span></span></code></pre></div><p>如果出现 <code>Could not execute dot; may need to install graphviz.</code>，参考 &ldquo;安裝 Graphviz&rdquo;</p><p><img src=../imgs/profile2.png alt></p><p>上图中的框越大，线越粗代表它消耗的时间越长。</p><p><img src=../imgs/profile3.png alt></p><p><img src=../imgs/profile4.png alt></p><p>PProf 的可视化界面能够更方便、更直观的看到 Go 应用程序的调用链、使用情况等。</p><p>火焰图：
<img src=../imgs/profile5.png alt></p><h3 id=安裝-graphviz>安裝 Graphviz
<a class=anchor href=#%e5%ae%89%e8%a3%9d-graphviz>#</a></h3><p>官网 <a href=http://www.graphviz.org/download/>下载地址</a></p><h3 id=配置环境变量>配置环境变量
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f>#</a></h3><p>将 bin 目录添加到 Path 环境变量中，如 <code>C:\Program Files (x86)\Graphviz2.38\bin</code>。</p><h3 id=验证>验证
<a class=anchor href=#%e9%aa%8c%e8%af%81>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dot -version
</span></span></code></pre></div><p><strong>部分内容来自</strong> <a href=https://github.com/EDDYCJY/blog/blob/7b021d0dee/tools/go-tool-pprof.md>Go 大杀器之性能剖析 PProf</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/commit/e2c1b9369331db41bcc14cb50249d04165b4bc8c title='Last modified by shipengqi | October 15, 2023' target=_blank rel=noopener><img src=/golang-learn/svg/calendar.svg class=book-icon alt=Calendar>
<span>October 15, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/edit/master/content/docs/practice/04_pprof.md target=_blank rel=noopener><img src=/golang-learn/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#go-性能分析>Go 性能分析</a><ul><li><a href=#性能分析>性能分析</a><ul><li><a href=#分析-http-server>分析 HTTP Server</a></li></ul></li><li><a href=#pprof-可视化界面>PProf 可视化界面</a><ul><li><a href=#安裝-graphviz>安裝 Graphviz</a></li><li><a href=#配置环境变量>配置环境变量</a></li><li><a href=#验证>验证</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>