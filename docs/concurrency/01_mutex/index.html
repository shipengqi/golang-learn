<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="äº’æ–¥é” # Go çš„æ ‡å‡†åº“ sync æä¾›äº†ä¸¤ç§é”ç±»å‹ï¼šsync.Mutex å’Œ sync.RWMutexï¼Œå‰è€…æ˜¯äº’æ–¥é”ï¼ˆæ’ä»–é”ï¼‰ï¼Œåè€…æ˜¯è¯»å†™é”ã€‚
äº’æ–¥é”æ˜¯å¹¶å‘æ§åˆ¶çš„ä¸€ä¸ªåŸºæœ¬æ‰‹æ®µï¼Œæ˜¯ä¸ºäº†é¿å…ç«äº‰è€Œå»ºç«‹çš„ä¸€ç§å¹¶å‘æ§åˆ¶æœºåˆ¶ã€‚
Go å®šä¹‰çš„é”æ¥å£åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š
type Locker interface { Lock() // è¯·æ±‚é” Unlock() // é‡Šæ”¾é” } ä½¿ç”¨ # import &#34;sync&#34; var ( mu sync.Mutex // guards balance balance int ) func Deposit(amount int) { mu.Lock() defer mu.Unlock() balance = balance + amount } func Balance() int { mu.Lock() defer mu.Unlock() b := balance return b } å½“å·²ç»æœ‰ goroutine è°ƒç”¨ Lock æ–¹æ³•è·å¾—äº†è¿™ä¸ªé”ï¼Œå†æœ‰ goroutine è¯·æ±‚è¿™ä¸ªé”å°±ä¼šé˜»å¡åœ¨ Lock æ–¹æ³•çš„è°ƒç”¨ä¸Šï¼Œ ç›´åˆ°æŒæœ‰è¿™ä¸ªé”çš„ goroutine è°ƒç”¨ UnLock é‡Šæ”¾è¿™ä¸ªé”ã€‚"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="äº’æ–¥é”"><meta property="og:description" content="äº’æ–¥é” # Go çš„æ ‡å‡†åº“ sync æä¾›äº†ä¸¤ç§é”ç±»å‹ï¼šsync.Mutex å’Œ sync.RWMutexï¼Œå‰è€…æ˜¯äº’æ–¥é”ï¼ˆæ’ä»–é”ï¼‰ï¼Œåè€…æ˜¯è¯»å†™é”ã€‚
äº’æ–¥é”æ˜¯å¹¶å‘æ§åˆ¶çš„ä¸€ä¸ªåŸºæœ¬æ‰‹æ®µï¼Œæ˜¯ä¸ºäº†é¿å…ç«äº‰è€Œå»ºç«‹çš„ä¸€ç§å¹¶å‘æ§åˆ¶æœºåˆ¶ã€‚
Go å®šä¹‰çš„é”æ¥å£åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š
type Locker interface { Lock() // è¯·æ±‚é” Unlock() // é‡Šæ”¾é” } ä½¿ç”¨ # import &#34;sync&#34; var ( mu sync.Mutex // guards balance balance int ) func Deposit(amount int) { mu.Lock() defer mu.Unlock() balance = balance + amount } func Balance() int { mu.Lock() defer mu.Unlock() b := balance return b } å½“å·²ç»æœ‰ goroutine è°ƒç”¨ Lock æ–¹æ³•è·å¾—äº†è¿™ä¸ªé”ï¼Œå†æœ‰ goroutine è¯·æ±‚è¿™ä¸ªé”å°±ä¼šé˜»å¡åœ¨ Lock æ–¹æ³•çš„è°ƒç”¨ä¸Šï¼Œ ç›´åˆ°æŒæœ‰è¿™ä¸ªé”çš„ goroutine è°ƒç”¨ UnLock é‡Šæ”¾è¿™ä¸ªé”ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://shipengqi.github.io/golang-learn/docs/concurrency/01_mutex/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-11-27T21:09:02+08:00"><title>äº’æ–¥é” | Go Learning</title><link rel=manifest href=/golang-learn/manifest.json><link rel=icon href=/golang-learn/favicon.png><link rel=stylesheet href=/golang-learn/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/golang-learn/flexsearch.min.js></script>
<script defer src=/golang-learn/en.search.min.9c656a69f0b12ad1b59282775751d4b2d3243b4cac00002847e176b3252bddf1.js integrity="sha256-nGVqafCxKtG1koJ3V1HUstMkO0ysAAAoR+F2syUr3fE=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/golang-learn/><span>Go Learning</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://shipengqi.github.io/ target=_blank rel=noopener>Blog</a></li><li><a href=https://github.com/shipengqi/golang-learn target=_blank rel=noopener>Github</a></li></ul><ul><li><span>ğŸš è¯­è¨€åŸºç¡€</span><ul><li><a href=/golang-learn/docs/basic/01_basic_type/>åŸºç¡€æ•°æ®ç±»å‹</a></li><li><a href=/golang-learn/docs/basic/02_array/>æ•°ç»„</a></li><li><a href=/golang-learn/docs/basic/03_slice/>åˆ‡ç‰‡</a></li><li><a href=/golang-learn/docs/basic/04_map/>å“ˆå¸Œè¡¨</a></li><li><a href=/golang-learn/docs/basic/05_function/>å‡½æ•°</a></li><li><a href=/golang-learn/docs/basic/09_pointer/>æŒ‡é’ˆ</a></li></ul></li><li><a href=/golang-learn/docs/concurrency/>âš¡ å¹¶å‘ç¼–ç¨‹</a><ul><li><a href=/golang-learn/docs/concurrency/01_mutex/ class=active>äº’æ–¥é”</a></li><li><a href=/golang-learn/docs/concurrency/02_rwmutex/>è¯»å†™é”</a></li><li><a href=/golang-learn/docs/concurrency/03_waitgroup/>WaitGroup</a></li><li><a href=/golang-learn/docs/concurrency/04_cond/>æ¡ä»¶å˜é‡</a></li><li><a href=/golang-learn/docs/concurrency/05_once/>Once</a></li><li><a href=/golang-learn/docs/concurrency/06_pool/>Pool</a></li><li><a href=/golang-learn/docs/concurrency/07_context/>Context</a></li><li><a href=/golang-learn/docs/concurrency/08_atomic/>åŸå­æ“ä½œ</a></li><li><a href=/golang-learn/docs/concurrency/09_channel/>Channel</a></li><li><a href=/golang-learn/docs/concurrency/10_sema/>ä¿¡å·é‡</a></li><li><a href=/golang-learn/docs/concurrency/11_singleflight/>SingleFlight</a></li><li><a href=/golang-learn/docs/concurrency/12_errorgroup/>ErrGroup</a></li></ul></li><li><span>ğŸ› ï¸ å®è·µ</span><ul><li><a href=/golang-learn/docs/practice/01_build/>Go ç¼–è¯‘</a></li><li><a href=/golang-learn/docs/practice/02_go_race/>Go æ•°æ®ç«äº‰æ£€æµ‹å™¨</a></li><li><a href=/golang-learn/docs/practice/04_pprof/>Go æ€§èƒ½åˆ†æ</a></li><li><a href=/golang-learn/docs/practice/05_performance/>Go æ€§èƒ½ä¼˜åŒ–</a></li><li><a href=/golang-learn/docs/practice/07_coredump/>Go Core Dump è°ƒè¯•</a></li><li><a href=/golang-learn/docs/practice/08_mod/>Go Modules</a></li><li><a href=/golang-learn/docs/practice/09_gin/>Gin é™æ€æœåŠ¡å™¨</a></li></ul></li><li><span>ğŸ› ï¸ Go å·¥ç¨‹å®è·µ</span><ul><li><a href=/golang-learn/docs/project/01_specs/>é¡¹ç›®è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/02_structure/>é¡¹ç›®çš„ç›®å½•ç»“æ„</a></li><li><a href=/golang-learn/docs/project/03_code/>ä»£ç è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/04_commitizen/>Commit è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/05_version/>ç‰ˆæœ¬è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/06_api_doc/>API æ–‡æ¡£</a></li><li><a href=/golang-learn/docs/project/07_flow/>Git å·¥ä½œæµç¨‹</a></li><li><a href=/golang-learn/docs/project/08_make/>é¡¹ç›®ç®¡ç†</a></li><li><a href=/golang-learn/docs/project/09_actions/>GitHub Actions</a></li><li><a href=/golang-learn/docs/project/10_dependabot/>GitHub Dependabot</a></li><li><a href=/golang-learn/docs/project/11_templates/>GitHub æ¨¡æ¿</a></li><li><a href=/golang-learn/docs/project/12_goreleaser/>GoReleaser</a></li></ul></li><li><a href=/golang-learn/docs/advance/>ğŸ” åº•å±‚åŸç†</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/golang-learn/svg/menu.svg class=book-icon alt=Menu></label>
<strong>äº’æ–¥é”</strong>
<label for=toc-control><img src=/golang-learn/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#äº’æ–¥é”>äº’æ–¥é”</a><ul><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a><ul><li><a href=#ä¸ºä»€ä¹ˆä¸€å®šè¦åŠ é”>ä¸ºä»€ä¹ˆä¸€å®šè¦åŠ é”ï¼Ÿ</a></li></ul></li><li><a href=#åŸç†>åŸç†</a><ul><li><a href=#é¥¥é¥¿æ¨¡å¼>é¥¥é¥¿æ¨¡å¼</a></li><li><a href=#lock>Lock</a></li><li><a href=#unlock>Unlock</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=äº’æ–¥é”>äº’æ–¥é”
<a class=anchor href=#%e4%ba%92%e6%96%a5%e9%94%81>#</a></h1><p>Go çš„æ ‡å‡†åº“ <code>sync</code> æä¾›äº†ä¸¤ç§é”ç±»å‹ï¼š<code>sync.Mutex</code> å’Œ <code>sync.RWMutex</code>ï¼Œå‰è€…æ˜¯äº’æ–¥é”ï¼ˆæ’ä»–é”ï¼‰ï¼Œåè€…æ˜¯è¯»å†™é”ã€‚</p><p>äº’æ–¥é”æ˜¯å¹¶å‘æ§åˆ¶çš„ä¸€ä¸ªåŸºæœ¬æ‰‹æ®µï¼Œæ˜¯ä¸ºäº†é¿å…ç«äº‰è€Œå»ºç«‹çš„ä¸€ç§å¹¶å‘æ§åˆ¶æœºåˆ¶ã€‚</p><p>Go å®šä¹‰çš„é”æ¥å£åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Locker</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Lock</span>() <span style=color:#75715e>// è¯·æ±‚é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Unlock</span>() <span style=color:#75715e>// é‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=ä½¿ç”¨>ä½¿ç”¨
<a class=anchor href=#%e4%bd%bf%e7%94%a8>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span> <span style=color:#75715e>// guards balance 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>balance</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Deposit</span>(<span style=color:#a6e22e>amount</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>balance</span> = <span style=color:#a6e22e>balance</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>amount</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Balance</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>balance</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å½“å·²ç»æœ‰ goroutine è°ƒç”¨ <code>Lock</code> æ–¹æ³•è·å¾—äº†è¿™ä¸ªé”ï¼Œå†æœ‰ goroutine è¯·æ±‚è¿™ä¸ªé”å°±ä¼šé˜»å¡åœ¨ <code>Lock</code> æ–¹æ³•çš„è°ƒç”¨ä¸Šï¼Œ
ç›´åˆ°æŒæœ‰è¿™ä¸ªé”çš„ goroutine è°ƒç”¨ <code>UnLock</code> é‡Šæ”¾è¿™ä¸ªé”ã€‚</p><p><strong>ä½¿ç”¨ <code>defer</code> æ¥ <code>UnLock</code> é”ï¼Œç¡®ä¿åœ¨å‡½æ•°è¿”å›ä¹‹åæˆ–è€…å‘ç”Ÿé”™è¯¯è¿”å›æ—¶ä¸€å®šä¼šæ‰§è¡Œ <code>UnLock</code></strong>ã€‚</p><h3 id=ä¸ºä»€ä¹ˆä¸€å®šè¦åŠ é”>ä¸ºä»€ä¹ˆä¸€å®šè¦åŠ é”ï¼Ÿ
<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%80%e5%ae%9a%e8%a6%81%e5%8a%a0%e9%94%81>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>count</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä½¿ç”¨ WaitGroup ç­‰å¾… 10 ä¸ª goroutine å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å¯¹å˜é‡ count æ‰§è¡Œ 10 æ¬¡åŠ  1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>j</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>j</span> &lt; <span style=color:#ae81ff>1000</span>; <span style=color:#a6e22e>j</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>count</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç­‰å¾… 10 ä¸ª goroutine å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>count</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸Šé¢çš„ä¾‹å­ä¸­æœŸæœ›çš„æœ€åè®¡æ•°çš„ç»“æœæ˜¯ <code>10 * 1000 = 10000</code>ã€‚ä½†æ˜¯æ¯æ¬¡è¿è¡Œéƒ½å¯èƒ½å¾—åˆ°ä¸åŒçš„ç»“æœï¼ŒåŸºæœ¬ä¸Šä¸ä¼šå¾—åˆ°çš„ä¸€ä¸‡çš„ç»“æœã€‚</p><p>è¿™æ˜¯å› ä¸ºï¼Œ<code>count++</code> ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå®ƒè‡³å°‘åŒ…å« 3 ä¸ªæ­¥éª¤</p><ol><li>è¯»å–å˜é‡ count çš„å½“å‰å€¼ï¼Œ</li><li>å¯¹è¿™ä¸ªå€¼åŠ  1ï¼Œ</li><li>æŠŠç»“æœä¿å­˜åˆ° count ä¸­ã€‚</li></ol><p>å› ä¸ºä¸æ˜¯åŸå­æ“ä½œï¼Œå°±ä¼šæœ‰æ•°æ®ç«äº‰çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œä¸¤ä¸ª goroutine åŒæ—¶è¯»å–åˆ° count çš„å€¼ä¸º 8888ï¼Œæ¥ç€å„è‡ªæŒ‰ç…§è‡ªå·±çš„é€»è¾‘åŠ  1ï¼Œå€¼å˜æˆäº† 8889ï¼ŒæŠŠè¿™ä¸ªç»“æœå†å†™å›åˆ° count å˜é‡ã€‚
æ­¤æ—¶æ€»æ•°åªå¢åŠ äº† 1ï¼Œä½†æ˜¯åº”è¯¥æ˜¯å¢åŠ  2 æ‰å¯¹ã€‚è¿™æ˜¯å¹¶å‘è®¿é—®å…±äº«æ•°æ®çš„å¸¸è§é—®é¢˜ã€‚</p><p>æ•°æ®ç«äº‰çš„é—®é¢˜å¯ä»¥å†ç¼–è¯‘æ—¶é€šè¿‡æ•°æ®ç«äº‰æ£€æµ‹å™¨ï¼ˆrace detectorï¼‰å·¥å…·å‘ç°è®¡æ•°å™¨ç¨‹åºçš„é—®é¢˜ä»¥åŠä¿®å¤æ–¹æ³•ã€‚</p><h2 id=åŸç†>åŸç†
<a class=anchor href=#%e5%8e%9f%e7%90%86>#</a></h2><p><code>sync.Mutex</code> çš„ç»“æ„ä½“ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/sync/mutex.go#L34
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Mutex</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sema</span>  <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>state</code> å’Œ <code>sema</code> åŠ èµ·æ¥å ç”¨ 8 ä¸ªå­—èŠ‚ã€‚</p><p><code>state</code> æ˜¯ä¸€ä¸ªå¤åˆå‹çš„å­—æ®µï¼ŒåŒ…å«å¤šä¸ªæ„ä¹‰ï¼š</p><p><img src=https://raw.githubusercontent.com/shipengqi/illustrations/132b0f97ec250e221f725cbeb2d5c323a35f1cfe/go/mutex-state.png alt=mutex-state></p><p>åœ¨é»˜è®¤çŠ¶æ€ä¸‹ï¼Œäº’æ–¥é”çš„æ‰€æœ‰çŠ¶æ€ä½éƒ½æ˜¯ 0ï¼Œ<code>int32</code> ä¸­çš„ä¸åŒä½åˆ†åˆ«è¡¨ç¤ºäº†ä¸åŒçš„çŠ¶æ€ï¼š</p><ul><li><code>locked</code>ï¼šè¡¨ç¤ºè¿™ä¸ªé”æ˜¯å¦è¢«æŒæœ‰</li><li><code>woken</code>ï¼šè¡¨ç¤ºæ˜¯å¦ä»æœ‰å”¤é†’çš„ goroutine</li><li><code>starving</code>ï¼šè¡¨ç¤ºæ­¤é”æ˜¯å¦è¿›å…¥é¥¥é¥¿çŠ¶æ€</li><li><code>waitersCount</code>ï¼šè¡¨ç¤ºç­‰å¾…æ­¤é”çš„ goroutine çš„æ•°é‡</li></ul><h3 id=é¥¥é¥¿æ¨¡å¼>é¥¥é¥¿æ¨¡å¼
<a class=anchor href=#%e9%a5%a5%e9%a5%bf%e6%a8%a1%e5%bc%8f>#</a></h3><p>è¯·æ±‚é”çš„ goroutine æœ‰ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯æ–°æ¥è¯·æ±‚é”çš„ goroutineï¼Œå¦ä¸€ç±»æ˜¯è¢«å”¤é†’çš„ç­‰å¾…è¯·æ±‚é”çš„ goroutineã€‚</p><p>ç”±äºæ–°æ¥çš„ goroutine ä¹Ÿå‚ä¸ç«äº‰é”ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œç­‰å¾…ä¸­çš„ goroutine å¯èƒ½ä¸€ç›´è·å–ä¸åˆ°é”ï¼Œè¿™å°±æ˜¯<strong>é¥¥é¥¿é—®é¢˜</strong>ã€‚</p><p>ä¸ºäº†è§£å†³é¥¥é¥¿ï¼ŒGo 1.9 ä¸­ä¸º mutex å¢åŠ äº†<strong>é¥¥é¥¿æ¨¡å¼</strong>ã€‚</p><p>åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œç­‰å¾…ä¸­çš„ goroutine ä¼šæŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºè·å–é”ã€‚ä½†æ˜¯å¦‚æœæ–°æ¥çš„ goroutine ç«äº‰é”ï¼Œç­‰å¾…ä¸­çš„ goroutine å¤§æ¦‚ç‡æ˜¯è·å–ä¸åˆ°é”çš„ã€‚ä¸€æ—¦ goroutine è¶…
è¿‡ 1ms æ²¡æœ‰è·å–åˆ°é”ï¼Œå®ƒå°±ä¼šå°†å½“å‰äº’æ–¥é”åˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼ï¼Œä¿è¯é”çš„å…¬å¹³æ€§ã€‚</p><p>åœ¨é¥¥é¥¿æ¨¡å¼ä¸­ï¼Œäº’æ–¥é”ä¼šç›´æ¥äº¤ç»™ç­‰å¾…é˜Ÿåˆ—æœ€å‰é¢çš„ goroutineã€‚æ–°æ¥çš„ goroutine åœ¨è¯¥çŠ¶æ€ä¸‹ä¸èƒ½è·å–é”ã€ä¹Ÿä¸ä¼šè¿›å…¥è‡ªæ—‹çŠ¶æ€ï¼Œåªä¼šåœ¨é˜Ÿåˆ—çš„æœ«å°¾ç­‰å¾…ã€‚</p><p>ä¸‹é¢ä¸¤ç§æƒ…å†µï¼Œmutex ä¼šåˆ‡æ¢ä¸ºæ­£å¸¸æ¨¡å¼:</p><ul><li>ä¸€ä¸ª goroutine è·å¾—äº†é”å¹¶ä¸”å®ƒåœ¨é˜Ÿåˆ—çš„æœ«å°¾</li><li>ä¸€ä¸ª goroutine ç­‰å¾…çš„æ—¶é—´å°‘äº 1ms</li></ul><h3 id=lock>Lock
<a class=anchor href=#lock>#</a></h3><p><code>Lock</code> çš„å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mutexLocked</span> = <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#66d9ef>iota</span> <span style=color:#75715e>// 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mutexWoken</span> <span style=color:#75715e>// 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mutexStarving</span> <span style=color:#75715e>// 4
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mutexWaiterShift</span> = <span style=color:#66d9ef>iota</span> <span style=color:#75715e>// 3
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>starvationThresholdNs</span> = <span style=color:#ae81ff>1e6</span> <span style=color:#75715e>// 1000000
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Mutex</span>) <span style=color:#a6e22e>Lock</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Fast path: grab unlocked mutex.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// æ²¡æœ‰ goroutine æŒæœ‰é”ï¼Œä¹Ÿæ²¡æœ‰ç­‰å¾…çš„ goroutineï¼Œå½“å‰ goroutine å¯ä»¥ç›´æ¥è·å¾—é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>CompareAndSwapInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>mutexLocked</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>race</span>.<span style=color:#a6e22e>Enabled</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>race</span>.<span style=color:#a6e22e>Acquire</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Slow path (outlined so that the fast path can be inlined)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// é€šè¿‡è‡ªæ—‹ç­‰æ–¹å¼ç«äº‰é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>lockSlow</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Mutex</span>) <span style=color:#a6e22e>lockSlow</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>waitStartTime</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>starving</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e>// å½“å‰ goroutine çš„é¥¥é¥¿æ ‡è®°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>awoke</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e>// å”¤é†’æ ‡è®°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>iter</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span> <span style=color:#75715e>// è‡ªæ—‹æ¬¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>old</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span> <span style=color:#75715e>// å½“å‰é”çš„çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// é”æ˜¯éé¥¥é¥¿æ¨¡å¼å¹¶ä¸”è¿˜æ²¡è¢«é‡Šæ”¾ï¼Œå°è¯•è‡ªæ—‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&amp;</span>(<span style=color:#a6e22e>mutexLocked</span>|<span style=color:#a6e22e>mutexStarving</span>) <span style=color:#f92672>==</span> <span style=color:#a6e22e>mutexLocked</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>runtime_canSpin</span>(<span style=color:#a6e22e>iter</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// å°è¯•è®¾ç½® mutexWoken æ ‡å¿—æ¥é€šçŸ¥è§£é”ï¼Œä»¥é¿å…å”¤é†’å…¶ä»–é˜»å¡çš„ goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>awoke</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mutexWoken</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#a6e22e>mutexWaiterShift</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> 
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>CompareAndSwapInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>old</span>, <span style=color:#a6e22e>old</span>|<span style=color:#a6e22e>mutexWoken</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>awoke</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>runtime_doSpin</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>iter</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>old</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span> <span style=color:#75715e>// å†æ¬¡è·å–é”çš„çŠ¶æ€ï¼Œåé¢ä¼šæ£€æŸ¥é”æ˜¯å¦è¢«é‡Šæ”¾äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>new</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>old</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mutexStarving</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>new</span> <span style=color:#f92672>|=</span> <span style=color:#a6e22e>mutexLocked</span> <span style=color:#75715e>// éé¥¥é¥¿çŠ¶æ€ï¼ŒåŠ é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&amp;</span>(<span style=color:#a6e22e>mutexLocked</span>|<span style=color:#a6e22e>mutexStarving</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>new</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#a6e22e>mutexWaiterShift</span> <span style=color:#75715e>// waiter æ•°é‡åŠ  1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>starving</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mutexLocked</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>new</span> <span style=color:#f92672>|=</span> <span style=color:#a6e22e>mutexStarving</span> <span style=color:#75715e>// è®¾ç½®é¥¥é¥¿çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>awoke</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// The goroutine has been woken from sleep, 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// so we need to reset the flag in either case. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>new</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mutexWoken</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;sync: inconsistent mutex state&#34;</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>new</span> <span style=color:#f92672>&amp;^=</span> <span style=color:#a6e22e>mutexWoken</span> <span style=color:#75715e>// æ–°çŠ¶æ€æ¸…é™¤å”¤é†’æ ‡è®°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è®¾ç½®æ–°çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>CompareAndSwapInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>old</span>, <span style=color:#a6e22e>new</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å†æ¬¡æ£€æŸ¥ï¼ŒåŸæ¥é”çš„çŠ¶æ€å·²é‡Šæ”¾ï¼Œå¹¶ä¸”ä¸æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œæ­£å¸¸è¯·æ±‚åˆ°äº†é”ï¼Œè¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&amp;</span>(<span style=color:#a6e22e>mutexLocked</span>|<span style=color:#a6e22e>mutexStarving</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span> <span style=color:#75715e>// locked the mutex with CAS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// å¤„ç†é¥¥é¥¿çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// å¦‚æœä¹‹å‰å°±åœ¨è¯¥é˜Ÿåˆ—é‡Œé¢ï¼Œå°±åŠ å…¥åˆ°é˜Ÿåˆ—å¤´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>queueLifo</span> : <span style=color:#a6e22e>waitStartTime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>waitStartTime</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>waitStartTime</span> = <span style=color:#a6e22e>runtime_nanotime</span>()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>            <span style=color:#75715e>// runtime_SemacquireMutex é€šè¿‡ä¿¡å·é‡ä¿è¯èµ„æºä¸ä¼šè¢«ä¸¤ä¸ª goroutine è·å–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// runtime_SemacquireMutex ä¼šåœ¨æ–¹æ³•ä¸­ä¸æ–­å°è¯•è·å–é”å¹¶é™·å…¥ä¼‘çœ ç­‰å¾…ä¿¡å·é‡çš„é‡Šæ”¾
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// ä¹Ÿå°±æ˜¯è¿™é‡Œä¼šé˜»å¡ç­‰å¾…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// ä¸€æ—¦å½“å‰ goroutine å¯ä»¥è·å–ä¿¡å·é‡ï¼Œå®ƒå°±ä¼šç«‹åˆ»è¿”å›ï¼Œå‰©ä½™ä»£ç ä¹Ÿä¼šç»§ç»­æ‰§è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>runtime_SemacquireMutex</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>sema</span>, <span style=color:#a6e22e>queueLifo</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>			<span style=color:#75715e>// åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œè¿™æ®µä»£ç ä¼šè®¾ç½®å”¤é†’å’Œé¥¥é¥¿æ ‡è®°ã€é‡ç½®è¿­ä»£æ¬¡æ•°å¹¶é‡æ–°æ‰§è¡Œè·å–é”çš„å¾ªç¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œå½“å‰ goroutine ä¼šè·å¾—é”ï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­åªå­˜åœ¨å½“å‰ goroutineï¼Œé”è¿˜ä¼šä»é¥¥é¥¿æ¨¡å¼ä¸­é€€å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>starving</span> = <span style=color:#a6e22e>starving</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>runtime_nanotime</span>()<span style=color:#f92672>-</span><span style=color:#a6e22e>waitStartTime</span> &gt; <span style=color:#a6e22e>starvationThresholdNs</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>old</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mutexStarving</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&amp;</span>(<span style=color:#a6e22e>mutexLocked</span>|<span style=color:#a6e22e>mutexWoken</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#a6e22e>mutexWaiterShift</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;sync: inconsistent mutex state&#34;</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>delta</span> <span style=color:#f92672>:=</span> int32(<span style=color:#a6e22e>mutexLocked</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#a6e22e>mutexWaiterShift</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>starving</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#a6e22e>mutexWaiterShift</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>delta</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>mutexStarving</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>delta</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>awoke</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>iter</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>old</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>race</span>.<span style=color:#a6e22e>Enabled</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>race</span>.<span style=color:#a6e22e>Acquire</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span>	}	
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=è‡ªæ—‹>è‡ªæ—‹
<a class=anchor href=#%e8%87%aa%e6%97%8b>#</a></h4><p>è‡ªæ—‹æ˜¯ä¸€ç§å¤šçº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼Œ<strong>å½“å‰çš„è¿›ç¨‹åœ¨è¿›å…¥è‡ªæ—‹çš„è¿‡ç¨‹ä¸­ä¼šä¸€ç›´ä¿æŒ CPU çš„å ç”¨</strong>ï¼ŒæŒç»­æ£€æŸ¥æŸä¸ªæ¡ä»¶æ˜¯å¦ä¸ºçœŸã€‚åœ¨å¤šæ ¸çš„ CPU ä¸Šï¼Œè‡ªæ—‹å¯ä»¥é¿å… goroutine çš„åˆ‡æ¢ï¼Œä½¿ç”¨æ°å½“
ä¼šå¯¹æ€§èƒ½å¸¦æ¥å¾ˆå¤§çš„å¢ç›Šï¼Œä½†æ˜¯ä½¿ç”¨çš„ä¸æ°å½“å°±ä¼šæ‹–æ…¢æ•´ä¸ªç¨‹åºï¼Œæ‰€ä»¥ goroutine è¿›å…¥è‡ªæ—‹çš„æ¡ä»¶éå¸¸è‹›åˆ»ï¼š</p><ol><li><code>old&(mutexLocked|mutexStarving) == mutexLocked</code> åªæœ‰åœ¨æ™®é€šæ¨¡å¼</li><li><code>runtime_canSpin(iter)</code> ä¸ºçœŸï¼š<ul><li>è¿è¡Œåœ¨å¤š CPU çš„æœºå™¨ä¸Š</li><li>è‡ªæ—‹çš„æ¬¡æ•°å°äºå››æ¬¡</li><li>å½“å‰æœºå™¨ä¸Šè‡³å°‘å­˜åœ¨ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å¤„ç†å™¨ P å¹¶ä¸”å¤„ç†çš„è¿è¡Œé˜Ÿåˆ—ä¸ºç©º</li></ul></li></ol><p>è¿›å…¥è‡ªæ—‹ä¼šè°ƒç”¨ <code>runtime_doSpin()</code>ï¼Œå¹¶æ‰§è¡Œ 30 æ¬¡çš„ PAUSE æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤åªä¼šå ç”¨ CPU å¹¶æ¶ˆè€— CPU æ—¶é—´ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//go:linkname sync_runtime_doSpin sync.runtime_doSpin
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:nosplit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sync_runtime_doSpin</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>procyield</span>(<span style=color:#a6e22e>active_spin_cnt</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>Â·</span><span style=color:#a6e22e>procyield</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#a6e22e>NOSPLIT</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MOVL</span>	<span style=color:#a6e22e>cycles</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>again</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PAUSE</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SUBL</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>JNZ</span>	<span style=color:#a6e22e>again</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><h3 id=unlock>Unlock
<a class=anchor href=#unlock>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Mutex</span>) <span style=color:#a6e22e>Unlock</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>race</span>.<span style=color:#a6e22e>Enabled</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>race</span>.<span style=color:#a6e22e>Release</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Fast path: drop lock bit.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// new == 0 æˆåŠŸé‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>new</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>, <span style=color:#f92672>-</span><span style=color:#a6e22e>mutexLocked</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>new</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Outlined slow path to allow inlining the fast path.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>unlockSlow</span>(<span style=color:#a6e22e>new</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Mutex</span>) <span style=color:#a6e22e>unlockSlow</span>(<span style=color:#a6e22e>new</span> <span style=color:#66d9ef>int32</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>new</span><span style=color:#f92672>+</span><span style=color:#a6e22e>mutexLocked</span>)<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mutexLocked</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> { <span style=color:#75715e>// unlock ä¸€ä¸ªæœªåŠ é”çš„é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>fatal</span>(<span style=color:#e6db74>&#34;sync: unlock of unlocked mutex&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>new</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mutexStarving</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> { <span style=color:#75715e>// æ­£å¸¸æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>old</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>new</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ä¸å­˜åœ¨ç­‰å¾…è€… æˆ–è€… mutexLockedã€mutexStarvingã€mutexWoken çŠ¶æ€ä¸éƒ½ä¸º 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// åˆ™ä¸éœ€è¦å”¤é†’å…¶ä»–ç­‰å¾…è€…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#a6e22e>mutexWaiterShift</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>old</span><span style=color:#f92672>&amp;</span>(<span style=color:#a6e22e>mutexLocked</span>|<span style=color:#a6e22e>mutexWoken</span>|<span style=color:#a6e22e>mutexStarving</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// å­˜åœ¨ç­‰å¾…è€…ï¼Œé€šè¿‡ runtime_Semrelease å”¤é†’ç­‰å¾…è€…å¹¶ç§»äº¤é”çš„æ‰€æœ‰æƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>new</span> = (<span style=color:#a6e22e>old</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#a6e22e>mutexWaiterShift</span>) | <span style=color:#a6e22e>mutexWoken</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>CompareAndSwapInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>old</span>, <span style=color:#a6e22e>new</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>runtime_Semrelease</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>sema</span>, <span style=color:#66d9ef>false</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>old</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> { <span style=color:#75715e>// é¥¥é¥¿æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// ç›´æ¥è°ƒç”¨ runtime_Semrelease å°†å½“å‰é”äº¤ç»™ä¸‹ä¸€ä¸ªæ­£åœ¨å°è¯•è·å–é”çš„ç­‰å¾…è€…ï¼Œç­‰å¾…è€…è¢«å”¤é†’åä¼šå¾—åˆ°é”ï¼Œåœ¨è¿™æ—¶è¿˜ä¸ä¼šé€€å‡ºé¥¥é¥¿çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>runtime_Semrelease</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>sema</span>, <span style=color:#66d9ef>true</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/commit/71b3cd60afb327324631b06ed0522cc3c6479070 title='Last modified by PengQi Shi | November 27, 2023' target=_blank rel=noopener><img src=/golang-learn/svg/calendar.svg class=book-icon alt=Calendar>
<span>November 27, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/edit/master/content/docs/concurrency/01_mutex.md target=_blank rel=noopener><img src=/golang-learn/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#äº’æ–¥é”>äº’æ–¥é”</a><ul><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a><ul><li><a href=#ä¸ºä»€ä¹ˆä¸€å®šè¦åŠ é”>ä¸ºä»€ä¹ˆä¸€å®šè¦åŠ é”ï¼Ÿ</a></li></ul></li><li><a href=#åŸç†>åŸç†</a><ul><li><a href=#é¥¥é¥¿æ¨¡å¼>é¥¥é¥¿æ¨¡å¼</a></li><li><a href=#lock>Lock</a></li><li><a href=#unlock>Unlock</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>