<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Context # Go 1.7 ç‰ˆæœ¬ä¸­æ­£å¼å¼•å…¥æ–°æ ‡å‡†åº“ contextã€‚ä¸»è¦çš„ä½œç”¨æ˜¯åœ¨åœ¨ä¸€ç»„ goroutine ä¹‹é—´ä¼ é€’å…±äº«çš„å€¼ã€å–æ¶ˆä¿¡å·ã€deadline ç­‰ã€‚
type Context interface { Deadline() (deadline time.Time, ok bool) Done() <-chan struct{} Err() error Value(key interface{}) interface{} } Deadline â€” è¿”å›å½“å‰ context çš„æˆªæ­¢æ—¶é—´ã€‚ Done â€” è¿”å›ä¸€ä¸ªåªè¯»çš„ channelï¼Œå¯ç”¨äºè¯†åˆ«å½“å‰ channel æ˜¯å¦å·²ç»è¢«å…³é—­ï¼Œå…¶åŸå› å¯èƒ½æ˜¯åˆ°æœŸï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«å–æ¶ˆäº†ã€‚å¤šæ¬¡è°ƒç”¨ Done æ–¹æ³•ä¼šè¿”å›åŒä¸€ä¸ª channelã€‚ Err â€” è¿”å›å½“å‰ context è¢«å…³é—­çš„åŸå› ã€‚ å¦‚æœ context è¢«å–æ¶ˆï¼Œä¼šè¿”å› Canceled é”™è¯¯ã€‚ å¦‚æœ context è¶…æ—¶ï¼Œä¼šè¿”å› DeadlineExceeded é”™è¯¯ã€‚ Value â€” è¿”å›å½“å‰ context å¯¹åº”æ‰€å­˜å‚¨çš„ contextä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥ä¼ é€’è¯·æ±‚ç‰¹å®šçš„æ•°æ®ã€‚ åˆ›å»º contextï¼š
Backgroundï¼šåˆ›å»ºä¸€ä¸ªç©ºçš„ contextï¼Œä¸€èˆ¬ç”¨åœ¨ä¸»å‡½æ•°ã€åˆå§‹åŒ–ã€æµ‹è¯•ä»¥åŠåˆ›å»º root context çš„æ—¶å€™ã€‚ TODOï¼šåˆ›å»ºä¸€ä¸ªç©ºçš„ contextï¼Œä¸çŸ¥é“è¦ä¼ é€’ä¸€äº›ä»€ä¹ˆä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±ç”¨è¿™ä¸ªã€‚ WithCancelï¼šåŸºäº parent context åˆ›å»ºä¸€ä¸ªå¯ä»¥å–æ¶ˆçš„æ–° contextã€‚ WithTimeoutï¼šåŸºäº parent context åˆ›å»ºä¸€ä¸ªå…·æœ‰è¶…æ—¶æ—¶é—´çš„æ–° contextã€‚ WithDeadlineï¼šå’Œ WithTimeout ä¸€æ ·ï¼Œåªä¸è¿‡å‚æ•°æ˜¯æˆªæ­¢æ—¶é—´ï¼ˆè¶…æ—¶æ—¶é—´åŠ ä¸Šå½“å‰æ—¶é—´ï¼‰ã€‚ WithValueï¼šåŸºäºæŸä¸ª context åˆ›å»ºå¹¶å­˜å‚¨å¯¹åº”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ æœ€å¸¸ç”¨çš„åœºæ™¯ï¼Œä½¿ç”¨ context æ¥å–æ¶ˆä¸€ä¸ª goroutine çš„è¿è¡Œï¼š"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Context"><meta property="og:description" content="Context # Go 1.7 ç‰ˆæœ¬ä¸­æ­£å¼å¼•å…¥æ–°æ ‡å‡†åº“ contextã€‚ä¸»è¦çš„ä½œç”¨æ˜¯åœ¨åœ¨ä¸€ç»„ goroutine ä¹‹é—´ä¼ é€’å…±äº«çš„å€¼ã€å–æ¶ˆä¿¡å·ã€deadline ç­‰ã€‚
type Context interface { Deadline() (deadline time.Time, ok bool) Done() <-chan struct{} Err() error Value(key interface{}) interface{} } Deadline â€” è¿”å›å½“å‰ context çš„æˆªæ­¢æ—¶é—´ã€‚ Done â€” è¿”å›ä¸€ä¸ªåªè¯»çš„ channelï¼Œå¯ç”¨äºè¯†åˆ«å½“å‰ channel æ˜¯å¦å·²ç»è¢«å…³é—­ï¼Œå…¶åŸå› å¯èƒ½æ˜¯åˆ°æœŸï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«å–æ¶ˆäº†ã€‚å¤šæ¬¡è°ƒç”¨ Done æ–¹æ³•ä¼šè¿”å›åŒä¸€ä¸ª channelã€‚ Err â€” è¿”å›å½“å‰ context è¢«å…³é—­çš„åŸå› ã€‚ å¦‚æœ context è¢«å–æ¶ˆï¼Œä¼šè¿”å› Canceled é”™è¯¯ã€‚ å¦‚æœ context è¶…æ—¶ï¼Œä¼šè¿”å› DeadlineExceeded é”™è¯¯ã€‚ Value â€” è¿”å›å½“å‰ context å¯¹åº”æ‰€å­˜å‚¨çš„ contextä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥ä¼ é€’è¯·æ±‚ç‰¹å®šçš„æ•°æ®ã€‚ åˆ›å»º contextï¼š
Backgroundï¼šåˆ›å»ºä¸€ä¸ªç©ºçš„ contextï¼Œä¸€èˆ¬ç”¨åœ¨ä¸»å‡½æ•°ã€åˆå§‹åŒ–ã€æµ‹è¯•ä»¥åŠåˆ›å»º root context çš„æ—¶å€™ã€‚ TODOï¼šåˆ›å»ºä¸€ä¸ªç©ºçš„ contextï¼Œä¸çŸ¥é“è¦ä¼ é€’ä¸€äº›ä»€ä¹ˆä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±ç”¨è¿™ä¸ªã€‚ WithCancelï¼šåŸºäº parent context åˆ›å»ºä¸€ä¸ªå¯ä»¥å–æ¶ˆçš„æ–° contextã€‚ WithTimeoutï¼šåŸºäº parent context åˆ›å»ºä¸€ä¸ªå…·æœ‰è¶…æ—¶æ—¶é—´çš„æ–° contextã€‚ WithDeadlineï¼šå’Œ WithTimeout ä¸€æ ·ï¼Œåªä¸è¿‡å‚æ•°æ˜¯æˆªæ­¢æ—¶é—´ï¼ˆè¶…æ—¶æ—¶é—´åŠ ä¸Šå½“å‰æ—¶é—´ï¼‰ã€‚ WithValueï¼šåŸºäºæŸä¸ª context åˆ›å»ºå¹¶å­˜å‚¨å¯¹åº”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ æœ€å¸¸ç”¨çš„åœºæ™¯ï¼Œä½¿ç”¨ context æ¥å–æ¶ˆä¸€ä¸ª goroutine çš„è¿è¡Œï¼š"><meta property="og:type" content="article"><meta property="og:url" content="https://shipengqi.github.io/golang-learn/docs/concurrency/07_context/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-11-02T09:03:32+08:00"><title>Context | Go Learning</title><link rel=manifest href=/golang-learn/manifest.json><link rel=icon href=/golang-learn/favicon.png><link rel=stylesheet href=/golang-learn/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/golang-learn/flexsearch.min.js></script>
<script defer src=/golang-learn/en.search.min.be9b99fd8d24644b00dc1ccdf4499458237a0c707fb70c097160e0299b550984.js integrity="sha256-vpuZ/Y0kZEsA3BzN9EmUWCN6DHB/twwJcWDgKZtVCYQ=" crossorigin=anonymous></script>
<script defer src=/golang-learn/sw.min.e9a55528e030e44ecbe1b5a8da7dd8fb40bd282d02dc4574e81b999a6a21bc84.js integrity="sha256-6aVVKOAw5E7L4bWo2n3Y+0C9KC0C3EV06BuZmmohvIQ=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/golang-learn/><span>Go Learning</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://shipengqi.github.io/ target=_blank rel=noopener>Blog</a></li><li><a href=https://github.com/shipengqi/golang-learn target=_blank rel=noopener>Github</a></li></ul><ul><li><span>ğŸš è¯­è¨€åŸºç¡€</span><ul><li><a href=/golang-learn/docs/basic/01_basic_type/>åŸºç¡€æ®ç±»å‹</a></li><li><a href=/golang-learn/docs/basic/02_array/>æ•°ç»„</a></li><li><a href=/golang-learn/docs/basic/03_slice/>åˆ‡ç‰‡</a></li><li><a href=/golang-learn/docs/basic/04_map/>map</a></li><li><a href=/golang-learn/docs/basic/05_function/>å‡½æ•°</a></li><li><a href=/golang-learn/docs/basic/06_interface/>æ¥å£</a></li><li><a href=/golang-learn/docs/basic/07_reflect/>åå°„</a></li><li><a href=/golang-learn/docs/basic/08_generic/>æ³›å‹</a></li><li><a href=/golang-learn/docs/basic/09_pointer/>æŒ‡é’ˆ</a></li><li><a href=/golang-learn/docs/basic/10_range/>range</a></li><li><a href=/golang-learn/docs/basic/11_select/>select</a></li><li><a href=/golang-learn/docs/basic/12_defer/>defer</a></li><li><a href=/golang-learn/docs/basic/13_panic/>panic</a></li><li><a href=/golang-learn/docs/basic/14_make_new/>make å’Œ new</a></li><li><a href=/golang-learn/docs/basic/15_oop/>é¢å‘å¯¹è±¡</a></li></ul></li><li><a href=/golang-learn/docs/concurrency/>âš¡ å¹¶å‘ç¼–ç¨‹</a><ul><li><a href=/golang-learn/docs/concurrency/01_mutex/>äº’æ–¥é”</a></li><li><a href=/golang-learn/docs/concurrency/02_rwmutex/>è¯»å†™é”</a></li><li><a href=/golang-learn/docs/concurrency/03_waitgroup/>WaitGroup</a></li><li><a href=/golang-learn/docs/concurrency/04_cond/>æ¡ä»¶å˜é‡</a></li><li><a href=/golang-learn/docs/concurrency/05_once/>Once</a></li><li><a href=/golang-learn/docs/concurrency/06_pool/>Pool</a></li><li><a href=/golang-learn/docs/concurrency/07_context/ class=active>Context</a></li><li><a href=/golang-learn/docs/concurrency/08_atomic/>åŸå­æ“ä½œ</a></li><li><a href=/golang-learn/docs/concurrency/09_channel/>Channel</a></li><li><a href=/golang-learn/docs/concurrency/10_netpooler/>ç½‘ç»œè½®è¯¢å™¨</a></li></ul></li><li><span>ğŸ› ï¸ å®è·µ</span><ul><li><a href=/golang-learn/docs/practice/01_build/>Go ç¼–è¯‘</a></li><li><a href=/golang-learn/docs/practice/02_go_race/>Go æ•°æ®ç«äº‰æ£€æµ‹å™¨</a></li><li><a href=/golang-learn/docs/practice/03_test/>Go æµ‹è¯•</a></li><li><a href=/golang-learn/docs/practice/04_pprof/>Go æ€§èƒ½åˆ†æ</a></li><li><a href=/golang-learn/docs/practice/05_performance/>Go æ€§èƒ½ä¼˜åŒ–</a></li><li><a href=/golang-learn/docs/practice/06_trace/>Go Trace</a></li><li><a href=/golang-learn/docs/practice/07_coredump/>Go CoreDump è°ƒè¯•</a></li><li><a href=/golang-learn/docs/practice/08_mod/>Go Modules</a></li><li><a href=/golang-learn/docs/practice/09_gin/>Gin é™æ€æœåŠ¡å™¨</a></li><li><a href=/golang-learn/docs/practice/10_remote_dev/>Go è¿œç¨‹å¼€å‘è°ƒè¯•</a></li><li><a href=/golang-learn/docs/practice/11_errors/>Go å¸¸è§é”™è¯¯</a></li></ul></li><li><span>ğŸ” åº•å±‚åŸç†</span><ul><li><a href=/golang-learn/docs/advance/01_mm/>å†…å­˜ç®¡ç†</a></li><li><a href=/golang-learn/docs/advance/02_gc/>åƒåœ¾å›æ”¶</a></li><li><a href=/golang-learn/docs/advance/03_scheduler/>è°ƒåº¦å™¨</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/golang-learn/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Context</strong>
<label for=toc-control><img src=/golang-learn/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#context>Context</a><ul><li><a href=#åŸç†>åŸç†</a><ul><li><a href=#withcancel>WithCancel</a></li><li><a href=#withtimeout-å’Œ-withdeadline>WithTimeout å’Œ WithDeadline</a></li><li><a href=#withvalue>WithValue</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=context>Context
<a class=anchor href=#context>#</a></h1><p>Go 1.7 ç‰ˆæœ¬ä¸­æ­£å¼å¼•å…¥æ–°æ ‡å‡†åº“ <code>context</code>ã€‚ä¸»è¦çš„ä½œç”¨æ˜¯åœ¨åœ¨ä¸€ç»„ goroutine ä¹‹é—´ä¼ é€’å…±äº«çš„å€¼ã€å–æ¶ˆä¿¡å·ã€deadline ç­‰ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Context</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Deadline</span>() (<span style=color:#a6e22e>deadline</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>ok</span> <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Done</span>() <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Err</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>Deadline</code> â€” è¿”å›å½“å‰ context çš„æˆªæ­¢æ—¶é—´ã€‚</li><li><code>Done</code> â€” è¿”å›ä¸€ä¸ªåªè¯»çš„ channelï¼Œå¯ç”¨äºè¯†åˆ«å½“å‰ channel æ˜¯å¦å·²ç»è¢«å…³é—­ï¼Œå…¶åŸå› å¯èƒ½æ˜¯åˆ°æœŸï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«å–æ¶ˆäº†ã€‚å¤šæ¬¡è°ƒç”¨ <code>Done</code> æ–¹æ³•ä¼šè¿”å›åŒä¸€ä¸ª channelã€‚</li><li><code>Err</code> â€” è¿”å›å½“å‰ context è¢«å…³é—­çš„åŸå› ã€‚<ul><li>å¦‚æœ context è¢«å–æ¶ˆï¼Œä¼šè¿”å› <code>Canceled</code> é”™è¯¯ã€‚</li><li>å¦‚æœ context è¶…æ—¶ï¼Œä¼šè¿”å› <code>DeadlineExceeded</code> é”™è¯¯ã€‚</li></ul></li><li><code>Value</code> â€” è¿”å›å½“å‰ context å¯¹åº”æ‰€å­˜å‚¨çš„ contextä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥ä¼ é€’è¯·æ±‚ç‰¹å®šçš„æ•°æ®ã€‚</li></ul><p>åˆ›å»º contextï¼š</p><ul><li><code>Background</code>ï¼šåˆ›å»ºä¸€ä¸ªç©ºçš„ contextï¼Œä¸€èˆ¬ç”¨åœ¨ä¸»å‡½æ•°ã€åˆå§‹åŒ–ã€æµ‹è¯•ä»¥åŠåˆ›å»º root context çš„æ—¶å€™ã€‚</li><li><code>TODO</code>ï¼šåˆ›å»ºä¸€ä¸ªç©ºçš„ contextï¼Œä¸çŸ¥é“è¦ä¼ é€’ä¸€äº›ä»€ä¹ˆä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±ç”¨è¿™ä¸ªã€‚</li><li><code>WithCancel</code>ï¼šåŸºäº parent context åˆ›å»ºä¸€ä¸ªå¯ä»¥å–æ¶ˆçš„æ–° contextã€‚</li><li><code>WithTimeout</code>ï¼šåŸºäº parent context åˆ›å»ºä¸€ä¸ªå…·æœ‰<strong>è¶…æ—¶æ—¶é—´</strong>çš„æ–° contextã€‚</li><li><code>WithDeadline</code>ï¼šå’Œ <code>WithTimeout</code> ä¸€æ ·ï¼Œåªä¸è¿‡å‚æ•°æ˜¯<strong>æˆªæ­¢æ—¶é—´</strong>ï¼ˆè¶…æ—¶æ—¶é—´åŠ ä¸Šå½“å‰æ—¶é—´ï¼‰ã€‚</li><li><code>WithValue</code>ï¼šåŸºäºæŸä¸ª context åˆ›å»ºå¹¶å­˜å‚¨å¯¹åº”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li></ul><p>æœ€å¸¸ç”¨çš„åœºæ™¯ï¼Œä½¿ç”¨ context æ¥å–æ¶ˆä¸€ä¸ª goroutine çš„è¿è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;goroutine exit&#34;</span>)
</span></span><span style=display:flex><span>        }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯ä»¥å¤šä¸ª goroutine åŒæ—¶è®¢é˜… <code>ctx.Done()</code> ç®¡é“ä¸­çš„æ¶ˆæ¯ï¼Œä¸€æ—¦æ¥æ”¶åˆ°å–æ¶ˆä¿¡å·å°±ç«‹åˆ»åœæ­¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„å·¥ä½œã€‚</p><h2 id=åŸç†>åŸç†
<a class=anchor href=#%e5%8e%9f%e7%90%86>#</a></h2><p>context çš„æœ€å¤§ä½œç”¨å°±æ˜¯åœ¨ä¸€ç»„ goroutine æ„æˆçš„æ ‘å½¢ç»“æ„ä¸­å¯¹ä¿¡å·è¿›è¡ŒåŒæ­¥ï¼Œä»¥å‡å°‘è®¡ç®—èµ„æºçš„æµªè´¹ã€‚</p><p>ä¾‹å¦‚ï¼ŒGo çš„ HTTP serverï¼Œå¤„ç†æ¯ä¸€ä¸ªè¯·æ±‚ï¼Œéƒ½æ˜¯å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„ goroutineï¼Œå¤„ç†è¿‡ç¨‹ä¸­è¿˜ä¼šå¯åŠ¨æ–°çš„ goroutine æ¥è®¿é—®æ•°æ®åº“å’Œå…¶ä»–æœåŠ¡ã€‚è€Œ context åœ¨ä¸åŒ Goroutine ä¹‹é—´å¯ä»¥åŒæ­¥è¯·æ±‚ç‰¹å®šæ•°æ®ã€å–æ¶ˆä¿¡å·ä»¥åŠå¤„ç†
è¯·æ±‚çš„æˆªæ­¢æ—¥æœŸã€‚</p><p><img src=https://raw.githubusercontent.com/shipengqi/illustrations/505be84aff62a8b94292bf3468f0d9a1c8c049cf/go/context.png alt=context></p><p>æ¯ä¸€ä¸ª context éƒ½ä¼šä» root goroutine ä¸€å±‚å±‚ä¼ é€’åˆ°åº•å±‚ã€‚context å¯ä»¥åœ¨ä¸Šå±‚ goroutine æ‰§è¡Œå‡ºç°é”™è¯¯æ—¶ï¼Œå°†ä¿¡å·åŠæ—¶åŒæ­¥ç»™ä¸‹å±‚ã€‚</p><h3 id=withcancel>WithCancel
<a class=anchor href=#withcancel>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/context/context.go#L235
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#a6e22e>CancelFunc</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>withCancel</span>(<span style=color:#a6e22e>parent</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Canceled</span>, <span style=color:#66d9ef>nil</span>) }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>withCancel</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>parent</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;cannot create context from nil parent&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cancelCtx</span>{}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ„å»º çˆ¶å­ context ä¹‹é—´çš„å…³è”ï¼Œå½“ çˆ¶ context è¢«å–æ¶ˆæ—¶ï¼Œå­ context ä¹Ÿä¼šè¢«å–æ¶ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>propagateCancel</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>propagateCancel</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>child</span> <span style=color:#a6e22e>canceler</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span> = <span style=color:#a6e22e>parent</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>done</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> { <span style=color:#75715e>// parent context æ˜¯ä¸ªç©º context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#75715e>// parent is never canceled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// parent context å·²ç»è¢«å–æ¶ˆï¼Œchild ä¹Ÿä¼šç«‹åˆ»è¢«å–æ¶ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>Cause</span>(<span style=color:#a6e22e>parent</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‰¾åˆ°å¯ä»¥å–æ¶ˆçš„ parent context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parentCancelCtx</span>(<span style=color:#a6e22e>parent</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// parent context å·²ç»è¢«å–æ¶ˆï¼Œchild ä¹Ÿä¼šç«‹åˆ»è¢«å–æ¶ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>cause</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// å°† child åŠ å…¥åˆ° parent çš„ children åˆ—è¡¨ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// ç­‰å¾… parent é‡Šæ”¾å–æ¶ˆä¿¡å·
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>children</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>canceler</span>]<span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>children</span>[<span style=color:#a6e22e>child</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parent</span>.(<span style=color:#a6e22e>afterFuncer</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// parent implements an AfterFunc method.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>stop</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>AfterFunc</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>Cause</span>(<span style=color:#a6e22e>parent</span>))
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span> = <span style=color:#a6e22e>stopCtx</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Context</span>: <span style=color:#a6e22e>parent</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>stop</span>:    <span style=color:#a6e22e>stop</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>goroutines</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ²¡æœ‰æ‰¾åˆ°å¯å–æ¶ˆçš„ parent context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// è¿è¡Œä¸€ä¸ªæ–°çš„ goroutine åŒæ—¶ç›‘å¬ parent.Done() å’Œ child.Done() ä¸¤ä¸ª channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>			<span style=color:#75715e>// åœ¨ parent.Done() å…³é—­æ—¶è°ƒç”¨ child.cancel å–æ¶ˆ å­ context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>Cause</span>(<span style=color:#a6e22e>parent</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>Done</span>(): <span style=color:#75715e>// è¿™ä¸ªç©ºçš„ case è¡¨ç¤ºå¦‚æœå­èŠ‚ç‚¹è‡ªå·±å–æ¶ˆäº†ï¼Œé‚£å°±é€€å‡ºè¿™ä¸ª selectï¼Œçˆ¶èŠ‚ç‚¹çš„å–æ¶ˆä¿¡å·å°±ä¸ç”¨ç®¡äº†ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		                     <span style=color:#75715e>// å¦‚æœå»æ‰è¿™ä¸ª caseï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½çˆ¶èŠ‚ç‚¹ä¸€ç›´ä¸å–æ¶ˆï¼Œè¿™ä¸ª goroutine å°±æ³„æ¼äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>Done</span>() <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{} {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æœ‰è°ƒç”¨äº† Done() æ–¹æ³•çš„æ—¶å€™æ‰ä¼šè¢«åˆ›å»º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è¿”å›çš„æ˜¯ä¸€ä¸ªåªè¯»çš„ channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// è¿™ä¸ª channel ä¸ä¼šè¢«å†™å…¥æ•°æ®ï¼Œç›´æ¥è°ƒç”¨è¯»è¿™ä¸ª channelï¼Œåç¨‹ä¼šè¢« block ä½ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// ä¸€èˆ¬é€šè¿‡æ­é… select æ¥ä½¿ç”¨ã€‚ä¸€æ—¦å…³é—­ï¼Œå°±ä¼šç«‹å³è¯»å‡ºé›¶å€¼ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>propagateCancel</code> çš„ä½œç”¨å°±æ˜¯å‘ä¸Šå¯»æ‰¾å¯ä»¥â€œæŒ‚é â€çš„â€œå¯å–æ¶ˆâ€çš„ contextï¼Œå¹¶ä¸”â€œæŒ‚é â€ä¸Šå»ã€‚è¿™æ ·ï¼Œè°ƒç”¨ä¸Šå±‚ <code>cancel</code> æ–¹æ³•çš„æ—¶å€™ï¼Œå°±å¯ä»¥å±‚å±‚ä¼ é€’ï¼Œ
å°†é‚£äº›æŒ‚é çš„å­ context åŒæ—¶â€œå–æ¶ˆâ€ã€‚</p><p><code>cancelCtx.cancel</code> ä¼šå…³é—­ context ä¸­çš„ channel å¹¶å‘æ‰€æœ‰çš„ å­ context åŒæ­¥å–æ¶ˆä¿¡å·ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>cancel</span>(<span style=color:#a6e22e>removeFromParent</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>cause</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>closedchan</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		close(<span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// éå†æ‰€æœ‰ å­ contextï¼Œå–æ¶ˆæ‰€æœ‰ å­ context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>child</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>children</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// NOTE: acquiring the child&#39;s lock while holding parent&#39;s lock.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>cause</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°†å­èŠ‚ç‚¹ç½®ç©º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>children</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>removeFromParent</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ä»çˆ¶èŠ‚ç‚¹ä¸­ç§»é™¤è‡ªå·± 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>removeChild</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=withtimeout-å’Œ-withdeadline>WithTimeout å’Œ WithDeadline
<a class=anchor href=#withtimeout-%e5%92%8c-withdeadline>#</a></h3><p><code>WithTimeout</code> å’Œ <code>WithDeadline</code> åˆ›å»ºçš„ context ä¹Ÿéƒ½æ˜¯å¯ä»¥è¢«å–æ¶ˆçš„ã€‚</p><p><code>WithTimeout</code> å’Œ <code>WithDeadline</code> åˆ›å»ºçš„æ˜¯ <code>timeCtx</code>ï¼Œ<code>timerCtx</code> åŸºäº <code>cancelCtx</code>ï¼Œå¤šäº†ä¸€ä¸ª <code>time.Timer</code> å’Œ <code>deadline</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>timerCtx</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cancelCtx</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>timer</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Timer</span> <span style=color:#75715e>// Under cancelCtx.mu.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>deadline</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>timerCtx</span>) <span style=color:#a6e22e>cancel</span>(<span style=color:#a6e22e>removeFromParent</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç›´æ¥è°ƒç”¨ cancelCtx çš„å–æ¶ˆæ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancelCtx</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>removeFromParent</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ä»çˆ¶èŠ‚ç‚¹ä¸­åˆ é™¤å­èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>removeChild</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancelCtx</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timer</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å…³æ‰å®šæ—¶å™¨ï¼Œè¿™æ ·ï¼Œåœ¨deadline åˆ°æ¥æ—¶ï¼Œä¸ä¼šå†æ¬¡å–æ¶ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timer</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>WithTimeout</code> å®é™…å°±æ—¶è°ƒç”¨äº† <code>WithDeadline</code>ï¼Œä¼ å…¥çš„ deadline æ˜¯å½“å‰æ—¶é—´åŠ ä¸Š timeout çš„æ—¶é—´ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) (<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>CancelFunc</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>WithDeadline</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>timeout</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>WithDeadline</code> çš„å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithDeadline</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>d</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>) (<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>CancelFunc</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>WithDeadlineCause</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>d</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithDeadlineCause</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>d</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>cause</span> <span style=color:#66d9ef>error</span>) (<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>CancelFunc</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>parent</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;cannot create context from nil parent&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦‚æœ parent context çš„ deadline æ—©äºæŒ‡å®šæ—¶é—´ã€‚ç›´æ¥æ„å»ºä¸€ä¸ªå¯å–æ¶ˆçš„ context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// åŸå› æ˜¯ä¸€æ—¦ parent context è¶…æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ cancel å‡½æ•°ï¼Œå­èŠ‚ç‚¹ä¹Ÿä¼šéšä¹‹å–æ¶ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// æ‰€ä»¥æ²¡æœ‰å¿…è¦å†å¤„ç† å­ context çš„è®¡æ—¶å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cur</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Deadline</span>(); <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>cur</span>.<span style=color:#a6e22e>Before</span>(<span style=color:#a6e22e>d</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>parent</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>timerCtx</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>deadline</span>: <span style=color:#a6e22e>d</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ„å»ºä¸€ä¸ª cancelCtxï¼ŒæŒ‚é åˆ°ä¸€ä¸ªå¯å–æ¶ˆçš„ parent context ä¸Š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// ä¹Ÿå°±æ˜¯è¯´ä¸€æ—¦ parent context å–æ¶ˆäº†ï¼Œè¿™ä¸ªå­ context éšä¹‹å–æ¶ˆã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancelCtx</span>.<span style=color:#a6e22e>propagateCancel</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dur</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dur</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¶…è¿‡äº†æˆªæ­¢æ—¥æœŸï¼Œç›´æ¥å–æ¶ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>DeadlineExceeded</span>, <span style=color:#a6e22e>cause</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>Canceled</span>, <span style=color:#66d9ef>nil</span>) }
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// åˆ°äº†æˆªæ­¢æ—¶é—´ï¼Œtimer ä¼šè‡ªåŠ¨è°ƒç”¨ cancel å‡½æ•°å–æ¶ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timer</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>AfterFunc</span>(<span style=color:#a6e22e>dur</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ä¼ å…¥é”™è¯¯ DeadlineExceeded
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>DeadlineExceeded</span>, <span style=color:#a6e22e>cause</span>)
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Canceled</span>, <span style=color:#66d9ef>nil</span>) }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>å¦‚æœè¦åˆ›å»ºçš„è¿™ä¸ª å­ context çš„ deadline æ¯” parent context çš„è¦æ™šï¼Œparent context åˆ°æ—¶é—´äº†ä¼šè‡ªåŠ¨å–æ¶ˆï¼Œå­ context ä¹Ÿä¼šå–æ¶ˆï¼Œ
å¯¼è‡´ å­ context çš„ deadline æ—¶é—´è¿˜æ²¡åˆ°å°±ä¼šè¢«å–æ¶ˆ</p></blockquote><h3 id=withvalue>WithValue
<a class=anchor href=#withvalue>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/context/context.go#L713
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithValue</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>val</span> <span style=color:#a6e22e>any</span>) <span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>parent</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;cannot create context from nil parent&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;nil key&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>reflectlite</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#a6e22e>key</span>).<span style=color:#a6e22e>Comparable</span>() {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;key is not comparable&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>valueCtx</span>{<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>val</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>valueCtx</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>valueCtx</span>) <span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>key</span> <span style=color:#a6e22e>any</span>) <span style=color:#a6e22e>any</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>key</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>val</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦‚æœ valueCtx ä¸­å­˜å‚¨çš„é”®å€¼å¯¹ä¸ä¼ å…¥çš„å‚æ•°ä¸åŒ¹é…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å°±ä¼šä» parent context ä¸­æŸ¥æ‰¾è¯¥é”®å¯¹åº”çš„å€¼ç›´åˆ°æŸä¸ª parent context ä¸­è¿”å› nil æˆ–è€…æŸ¥æ‰¾åˆ°å¯¹åº”çš„å€¼ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>value</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/commit/12f2dd0b667e4800da25d9592f7173a9d4ab83c7 title='Last modified by PengQi Shi | November 2, 2023' target=_blank rel=noopener><img src=/golang-learn/svg/calendar.svg class=book-icon alt=Calendar>
<span>November 2, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/edit/master/content/docs/concurrency/07_context.md target=_blank rel=noopener><img src=/golang-learn/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#context>Context</a><ul><li><a href=#åŸç†>åŸç†</a><ul><li><a href=#withcancel>WithCancel</a></li><li><a href=#withtimeout-å’Œ-withdeadline>WithTimeout å’Œ WithDeadline</a></li><li><a href=#withvalue>WithValue</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>