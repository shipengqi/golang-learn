<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Go æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰ # Go æä¾›çš„ pprof å·¥å…·å¯ä»¥ç”¨æ¥åšæ€§èƒ½åˆ†æã€‚pprof å¯ä»¥è¯»å–åˆ†ææ ·æœ¬çš„é›†åˆï¼Œå¹¶ç”ŸæˆæŠ¥å‘Šä»¥å¯è§†åŒ–å¹¶å¸®åŠ©åˆ†ææ•°æ®ã€‚
pprof å¯ä»¥ç”¨äºï¼š
CPU åˆ†æï¼ˆCPU Profilingï¼‰ï¼šæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡é‡‡é›†æ‰€ç›‘å¬çš„åº”ç”¨ç¨‹åº CPUï¼ˆå«å¯„å­˜å™¨ï¼‰çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ç¡®å®šåº”ç”¨ç¨‹åºåœ¨ä¸»åŠ¨æ¶ˆè€— CPU å‘¨æœŸ æ—¶èŠ±è´¹æ—¶é—´çš„ä½ç½®ã€‚ å†…å­˜åˆ†æï¼ˆMemory Profilingï¼‰ï¼šåœ¨åº”ç”¨ç¨‹åºè¿›è¡Œå †åˆ†é…æ—¶è®°å½•å †æ ˆè·Ÿè¸ªï¼Œç”¨äºç›‘è§†å½“å‰å’Œå†å²å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠæ£€æŸ¥å†…å­˜æ³„æ¼ã€‚ é˜»å¡åˆ†æï¼ˆBlock Profilingï¼‰ï¼šè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®ã€‚ äº’æ–¥é”åˆ†æï¼ˆMutex Profilingï¼‰ï¼šæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µã€‚ å¦‚ä½•ç”Ÿæˆåˆ†ææ ·æœ¬ # ç”Ÿæˆåˆ†ææ ·æœ¬çš„ä¸‰ç§æ–¹å¼ï¼š
runtime/pprofï¼šé‡‡é›†ç¨‹åºï¼ˆé Serverï¼‰çš„è¿è¡Œæ•°æ®ã€‚é€šè¿‡è°ƒç”¨å¦‚ runtime.StartCPUProfile, runtime.StopCPUProfile æ–¹æ³•ç”Ÿæˆåˆ†ææ ·æœ¬ã€‚ä¸»è¦ç”¨äºæœ¬åœ°æµ‹è¯•ã€‚ pkg/profile å°è£…äº† runtime/pprofï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ ç®€ä¾¿ã€‚ net/http/pprofï¼šé‡‡é›† HTTP Server çš„è¿è¡Œæ—¶æ•°æ®ï¼Œé€šè¿‡ HTTP æœåŠ¡è·å– Profile åˆ†ææ ·æœ¬ï¼Œåº•å±‚è¿˜æ˜¯è°ƒç”¨çš„ runtime/pprofã€‚ä¸»è¦ç”¨äºæœåŠ¡å™¨ç«¯æµ‹è¯•ã€‚ go test -benchï¼šä½¿ç”¨ go test -bench=. -cpuprofile cpuprofile.out ... è¿è¡ŒåŸºå‡†æµ‹è¯•æ¥ç”Ÿæˆåˆ†ææ ·æœ¬ï¼Œå¯ä»¥æŒ‡å®šæ‰€éœ€æ ‡è¯†æ¥è¿›è¡Œæ•°æ®é‡‡é›†ã€‚ ä»¥ net/http/pprof ä¸ºä¾‹ï¼š
package main import ( &#34;log&#34; &#34;net/http&#34; _ &#34;net/http/pprof&#34; // net/http/pprof æ³¨å†Œçš„æ˜¯é»˜è®¤çš„ mux ) var datas []string func Add(str string) string { data := []byte(str) sData := string(data) datas = append(datas, sData) return sData } func main() { go func() { for { log."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Go æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰"><meta property="og:description" content="Go æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰ # Go æä¾›çš„ pprof å·¥å…·å¯ä»¥ç”¨æ¥åšæ€§èƒ½åˆ†æã€‚pprof å¯ä»¥è¯»å–åˆ†ææ ·æœ¬çš„é›†åˆï¼Œå¹¶ç”ŸæˆæŠ¥å‘Šä»¥å¯è§†åŒ–å¹¶å¸®åŠ©åˆ†ææ•°æ®ã€‚
pprof å¯ä»¥ç”¨äºï¼š
CPU åˆ†æï¼ˆCPU Profilingï¼‰ï¼šæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡é‡‡é›†æ‰€ç›‘å¬çš„åº”ç”¨ç¨‹åº CPUï¼ˆå«å¯„å­˜å™¨ï¼‰çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ç¡®å®šåº”ç”¨ç¨‹åºåœ¨ä¸»åŠ¨æ¶ˆè€— CPU å‘¨æœŸ æ—¶èŠ±è´¹æ—¶é—´çš„ä½ç½®ã€‚ å†…å­˜åˆ†æï¼ˆMemory Profilingï¼‰ï¼šåœ¨åº”ç”¨ç¨‹åºè¿›è¡Œå †åˆ†é…æ—¶è®°å½•å †æ ˆè·Ÿè¸ªï¼Œç”¨äºç›‘è§†å½“å‰å’Œå†å²å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠæ£€æŸ¥å†…å­˜æ³„æ¼ã€‚ é˜»å¡åˆ†æï¼ˆBlock Profilingï¼‰ï¼šè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®ã€‚ äº’æ–¥é”åˆ†æï¼ˆMutex Profilingï¼‰ï¼šæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µã€‚ å¦‚ä½•ç”Ÿæˆåˆ†ææ ·æœ¬ # ç”Ÿæˆåˆ†ææ ·æœ¬çš„ä¸‰ç§æ–¹å¼ï¼š
runtime/pprofï¼šé‡‡é›†ç¨‹åºï¼ˆé Serverï¼‰çš„è¿è¡Œæ•°æ®ã€‚é€šè¿‡è°ƒç”¨å¦‚ runtime.StartCPUProfile, runtime.StopCPUProfile æ–¹æ³•ç”Ÿæˆåˆ†ææ ·æœ¬ã€‚ä¸»è¦ç”¨äºæœ¬åœ°æµ‹è¯•ã€‚ pkg/profile å°è£…äº† runtime/pprofï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ ç®€ä¾¿ã€‚ net/http/pprofï¼šé‡‡é›† HTTP Server çš„è¿è¡Œæ—¶æ•°æ®ï¼Œé€šè¿‡ HTTP æœåŠ¡è·å– Profile åˆ†ææ ·æœ¬ï¼Œåº•å±‚è¿˜æ˜¯è°ƒç”¨çš„ runtime/pprofã€‚ä¸»è¦ç”¨äºæœåŠ¡å™¨ç«¯æµ‹è¯•ã€‚ go test -benchï¼šä½¿ç”¨ go test -bench=. -cpuprofile cpuprofile.out ... è¿è¡ŒåŸºå‡†æµ‹è¯•æ¥ç”Ÿæˆåˆ†ææ ·æœ¬ï¼Œå¯ä»¥æŒ‡å®šæ‰€éœ€æ ‡è¯†æ¥è¿›è¡Œæ•°æ®é‡‡é›†ã€‚ ä»¥ net/http/pprof ä¸ºä¾‹ï¼š
package main import ( &#34;log&#34; &#34;net/http&#34; _ &#34;net/http/pprof&#34; // net/http/pprof æ³¨å†Œçš„æ˜¯é»˜è®¤çš„ mux ) var datas []string func Add(str string) string { data := []byte(str) sData := string(data) datas = append(datas, sData) return sData } func main() { go func() { for { log."><meta property="og:type" content="article"><meta property="og:url" content="https://shipengqi.github.io/golang-learn/docs/practice/04_pprof/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-12-18T13:21:57+08:00"><title>Go æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰ | Go Learning</title><link rel=manifest href=/golang-learn/manifest.json><link rel=icon href=/golang-learn/favicon.png><link rel=stylesheet href=/golang-learn/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/golang-learn/flexsearch.min.js></script>
<script defer src=/golang-learn/en.search.min.fe92e04ba07cc0f41f6a75f1c80d85bf2fac1dc49d6e5098de44895faeebc1f1.js integrity="sha256-/pLgS6B8wPQfanXxyA2Fvy+sHcSdblCY3kSJX67rwfE=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/golang-learn/><span>Go Learning</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://shipengqi.github.io/ target=_blank rel=noopener>Blog</a></li><li><a href=https://github.com/shipengqi/golang-learn target=_blank rel=noopener>Github</a></li></ul><ul><li><span>ğŸš è¯­è¨€åŸºç¡€</span><ul><li><a href=/golang-learn/docs/basic/01_basic_type/>åŸºç¡€æ•°æ®ç±»å‹</a></li><li><a href=/golang-learn/docs/basic/02_array/>æ•°ç»„</a></li><li><a href=/golang-learn/docs/basic/03_slice/>åˆ‡ç‰‡</a></li><li><a href=/golang-learn/docs/basic/04_map/>å“ˆå¸Œè¡¨</a></li><li><a href=/golang-learn/docs/basic/05_function/>å‡½æ•°</a></li><li><a href=/golang-learn/docs/basic/09_pointer/>æŒ‡é’ˆ</a></li></ul></li><li><a href=/golang-learn/docs/concurrency/>âš¡ å¹¶å‘ç¼–ç¨‹</a><ul><li><a href=/golang-learn/docs/concurrency/01_mutex/>äº’æ–¥é”</a></li><li><a href=/golang-learn/docs/concurrency/02_rwmutex/>è¯»å†™é”</a></li><li><a href=/golang-learn/docs/concurrency/03_waitgroup/>WaitGroup</a></li><li><a href=/golang-learn/docs/concurrency/04_cond/>æ¡ä»¶å˜é‡</a></li><li><a href=/golang-learn/docs/concurrency/05_once/>Once</a></li><li><a href=/golang-learn/docs/concurrency/06_pool/>Pool</a></li><li><a href=/golang-learn/docs/concurrency/07_context/>Context</a></li><li><a href=/golang-learn/docs/concurrency/08_atomic/>åŸå­æ“ä½œ</a></li><li><a href=/golang-learn/docs/concurrency/09_channel/>Channel</a></li><li><a href=/golang-learn/docs/concurrency/10_sema/>ä¿¡å·é‡</a></li><li><a href=/golang-learn/docs/concurrency/11_singleflight/>SingleFlight</a></li><li><a href=/golang-learn/docs/concurrency/12_errorgroup/>ErrGroup</a></li></ul></li><li><span>ğŸ› ï¸ å®è·µ</span><ul><li><a href=/golang-learn/docs/practice/01_build/>Go ç¼–è¯‘</a></li><li><a href=/golang-learn/docs/practice/02_go_race/>Go æ•°æ®ç«äº‰æ£€æµ‹å™¨</a></li><li><a href=/golang-learn/docs/practice/04_pprof/ class=active>Go æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰</a></li><li><a href=/golang-learn/docs/practice/05_trace/>Go æ€§èƒ½åˆ†æï¼ˆä¸‹ï¼‰</a></li><li><a href=/golang-learn/docs/practice/06_performance/>Go æ€§èƒ½ä¼˜åŒ–</a></li><li><a href=/golang-learn/docs/practice/07_coredump/>Go Core Dump è°ƒè¯•</a></li><li><a href=/golang-learn/docs/practice/08_mod/>Go Modules</a></li><li><a href=/golang-learn/docs/practice/09_gin/>Gin é™æ€æœåŠ¡å™¨</a></li><li><a href=/golang-learn/docs/practice/10_remote_dev/>Go è¿œç¨‹å¼€å‘è°ƒè¯•</a></li></ul></li><li><span>ğŸ› ï¸ Go å·¥ç¨‹å®è·µ</span><ul><li><a href=/golang-learn/docs/project/01_specs/>é¡¹ç›®è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/02_structure/>é¡¹ç›®çš„ç›®å½•ç»“æ„</a></li><li><a href=/golang-learn/docs/project/03_code/>ä»£ç è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/04_commitizen/>Commit è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/05_version/>ç‰ˆæœ¬è§„èŒƒ</a></li><li><a href=/golang-learn/docs/project/06_api_doc/>API æ–‡æ¡£</a></li><li><a href=/golang-learn/docs/project/07_flow/>Git å·¥ä½œæµç¨‹</a></li><li><a href=/golang-learn/docs/project/08_make/>é¡¹ç›®ç®¡ç†</a></li><li><a href=/golang-learn/docs/project/09_actions/>GitHub Actions</a></li><li><a href=/golang-learn/docs/project/10_dependabot/>GitHub Dependabot</a></li><li><a href=/golang-learn/docs/project/11_templates/>GitHub æ¨¡æ¿</a></li><li><a href=/golang-learn/docs/project/12_goreleaser/>GoReleaser</a></li></ul></li><li><a href=/golang-learn/docs/advance/>ğŸ” åº•å±‚åŸç†</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/golang-learn/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Go æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰</strong>
<label for=toc-control><img src=/golang-learn/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#go-æ€§èƒ½åˆ†æä¸Š>Go æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰</a><ul><li><a href=#å¦‚ä½•ç”Ÿæˆåˆ†ææ ·æœ¬>å¦‚ä½•ç”Ÿæˆåˆ†ææ ·æœ¬</a></li><li><a href=#å¦‚ä½•æŸ¥çœ‹åˆ†ææŠ¥å‘Š>å¦‚ä½•æŸ¥çœ‹åˆ†ææŠ¥å‘Š</a><ul><li><a href=#åœ¨-web-æŸ¥çœ‹åˆ†ææŠ¥å‘Š>åœ¨ Web æŸ¥çœ‹åˆ†ææŠ¥å‘Š</a></li><li><a href=#åœ¨ç»ˆç«¯æŸ¥çœ‹åˆ†ææŠ¥å‘Š>åœ¨ç»ˆç«¯æŸ¥çœ‹åˆ†ææŠ¥å‘Š</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=go-æ€§èƒ½åˆ†æä¸Š>Go æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰
<a class=anchor href=#go-%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e4%b8%8a>#</a></h1><p>Go æä¾›çš„ pprof å·¥å…·å¯ä»¥ç”¨æ¥åšæ€§èƒ½åˆ†æã€‚pprof å¯ä»¥è¯»å–åˆ†ææ ·æœ¬çš„é›†åˆï¼Œå¹¶ç”ŸæˆæŠ¥å‘Šä»¥å¯è§†åŒ–å¹¶å¸®åŠ©åˆ†ææ•°æ®ã€‚</p><p>pprof å¯ä»¥ç”¨äºï¼š</p><ul><li>CPU åˆ†æï¼ˆCPU Profilingï¼‰ï¼šæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡é‡‡é›†æ‰€ç›‘å¬çš„åº”ç”¨ç¨‹åº CPUï¼ˆå«å¯„å­˜å™¨ï¼‰çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ç¡®å®šåº”ç”¨ç¨‹åºåœ¨ä¸»åŠ¨æ¶ˆè€— CPU å‘¨æœŸ
æ—¶èŠ±è´¹æ—¶é—´çš„ä½ç½®ã€‚</li><li>å†…å­˜åˆ†æï¼ˆMemory Profilingï¼‰ï¼šåœ¨åº”ç”¨ç¨‹åºè¿›è¡Œå †åˆ†é…æ—¶è®°å½•å †æ ˆè·Ÿè¸ªï¼Œç”¨äºç›‘è§†å½“å‰å’Œå†å²å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠæ£€æŸ¥å†…å­˜æ³„æ¼ã€‚</li><li>é˜»å¡åˆ†æï¼ˆBlock Profilingï¼‰ï¼šè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®ã€‚</li><li>äº’æ–¥é”åˆ†æï¼ˆMutex Profilingï¼‰ï¼šæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µã€‚</li></ul><h2 id=å¦‚ä½•ç”Ÿæˆåˆ†ææ ·æœ¬>å¦‚ä½•ç”Ÿæˆåˆ†ææ ·æœ¬
<a class=anchor href=#%e5%a6%82%e4%bd%95%e7%94%9f%e6%88%90%e5%88%86%e6%9e%90%e6%a0%b7%e6%9c%ac>#</a></h2><p>ç”Ÿæˆåˆ†ææ ·æœ¬çš„ä¸‰ç§æ–¹å¼ï¼š</p><ul><li><code>runtime/pprof</code>ï¼šé‡‡é›†ç¨‹åºï¼ˆé Serverï¼‰çš„è¿è¡Œæ•°æ®ã€‚é€šè¿‡è°ƒç”¨å¦‚ <code>runtime.StartCPUProfile</code>, <code>runtime.StopCPUProfile</code> æ–¹æ³•ç”Ÿæˆåˆ†ææ ·æœ¬ã€‚ä¸»è¦ç”¨äº<strong>æœ¬åœ°æµ‹è¯•</strong>ã€‚<ul><li><a href=https://github.com/pkg/profile>pkg/profile</a> å°è£…äº† <code>runtime/pprof</code>ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ ç®€ä¾¿ã€‚</li></ul></li><li><code>net/http/pprof</code>ï¼šé‡‡é›† HTTP Server çš„è¿è¡Œæ—¶æ•°æ®ï¼Œé€šè¿‡ HTTP æœåŠ¡è·å– Profile åˆ†ææ ·æœ¬ï¼Œåº•å±‚è¿˜æ˜¯è°ƒç”¨çš„ <code>runtime/pprof</code>ã€‚ä¸»è¦ç”¨äº<strong>æœåŠ¡å™¨ç«¯æµ‹è¯•</strong>ã€‚</li><li><code>go test -bench</code>ï¼šä½¿ç”¨ <code>go test -bench=. -cpuprofile cpuprofile.out ...</code> è¿è¡ŒåŸºå‡†æµ‹è¯•æ¥ç”Ÿæˆåˆ†ææ ·æœ¬ï¼Œå¯ä»¥æŒ‡å®šæ‰€éœ€æ ‡è¯†æ¥è¿›è¡Œæ•°æ®é‡‡é›†ã€‚</li></ul><p>ä»¥ <code>net/http/pprof</code> ä¸ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;net/http/pprof&#34;</span> <span style=color:#75715e>// net/http/pprof æ³¨å†Œçš„æ˜¯é»˜è®¤çš„ mux
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>datas</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>str</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#a6e22e>str</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sData</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>datas</span> = append(<span style=color:#a6e22e>datas</span>, <span style=color:#a6e22e>sData</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sData</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;https://github.com/shipengqi&#34;</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;0.0.0.0:8080&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>_ "net/http/pprof"</code> è¿™è¡Œä»£ç ä¼šè‡ªåŠ¨æ·»åŠ  <code>/debug/pprof</code> çš„è·¯ç”±ã€‚ç¨‹åºè¿è¡Œåï¼Œè®¿é—® http://localhost:8080/debug/pprof å°±å¯ä»¥æŸ¥çœ‹åˆ†ææ ·æœ¬ã€‚</p><h2 id=å¦‚ä½•æŸ¥çœ‹åˆ†ææŠ¥å‘Š>å¦‚ä½•æŸ¥çœ‹åˆ†ææŠ¥å‘Š
<a class=anchor href=#%e5%a6%82%e4%bd%95%e6%9f%a5%e7%9c%8b%e5%88%86%e6%9e%90%e6%8a%a5%e5%91%8a>#</a></h2><p>æ‰“å¼€ http://localhost:8080/debug/pprof åä¼šçœ‹åˆ°ä¸‹é¢é¡µé¢ï¼š</p><p><img src=https://raw.githubusercontent.com/shipengqi/illustrations/810cbdff82baab7279ec4504d20e5b7bd88b6b33/go/pprof-home.png alt=pprof-home></p><p>pprof åŒ…æ‹¬äº†å‡ ä¸ªå­é¡µé¢ï¼š</p><ul><li>alloc: æŸ¥çœ‹æ‰€æœ‰å†…å­˜åˆ†é…çš„æƒ…å†µ</li><li>blockï¼ˆBlock Profilingï¼‰ï¼š<code>&lt;ip:port>/debug/pprof/block</code>ï¼ŒæŸ¥çœ‹å¯¼è‡´é˜»å¡åŒæ­¥çš„å †æ ˆè·Ÿè¸ª</li><li>cmdline : å½“å‰ç¨‹åºçš„å‘½ä»¤è¡Œè°ƒç”¨</li><li>goroutineï¼š<code>&lt;ip:port>/debug/pprof/goroutine</code>ï¼ŒæŸ¥çœ‹å½“å‰æ‰€æœ‰è¿è¡Œçš„ goroutines å †æ ˆè·Ÿè¸ªã€‚</li><li>heapï¼ˆMemory Profilingï¼‰: <code>&lt;ip:port>/debug/pprof/heap</code>ï¼ŒæŸ¥çœ‹æ´»åŠ¨å¯¹è±¡çš„å†…å­˜åˆ†é…æƒ…å†µï¼Œåœ¨è·å–å †æ ·æœ¬ä¹‹å‰ï¼Œå¯ä»¥æŒ‡å®š gc GET å‚æ•°æ¥è¿è¡Œ gcã€‚</li><li>mutexï¼ˆMutex Profilingï¼‰: <code>&lt;ip:port>/debug/pprof/mutex</code>ï¼ŒæŸ¥çœ‹å¯¼è‡´äº’æ–¥é”ç«äº‰çš„æŒæœ‰è€…çš„å †æ ˆè·Ÿè¸ªã€‚</li><li>profileï¼ˆCPU Profilingï¼‰: <code>&lt;ip:port>/debug/pprof/profile</code>ï¼Œ é»˜è®¤è¿›è¡Œ <code>30s</code> çš„ CPU Profilingï¼Œå¯ä»¥è®¾ç½® GET å‚æ•° <code>seconds</code> æ¥æŒ‡å®šæŒç»­æ—¶é—´ã€‚è·å–è·Ÿè¸ªæ–‡ä»¶ä¹‹åï¼Œä½¿ç”¨ <code>go tool trace</code> å‘½ä»¤æ¥åˆ†æã€‚</li><li>threadcreateï¼š<code>&lt;ip:port>/debug/pprof/threadcreate</code>ï¼ŒæŸ¥çœ‹åˆ›å»ºæ–° OS çº¿ç¨‹çš„å †æ ˆè·Ÿè¸ªã€‚</li><li>trace: å½“å‰ç¨‹åºçš„æ‰§è¡Œè½¨è¿¹ã€‚å¯ä»¥è®¾ç½® GET å‚æ•° <code>seconds</code> æ¥æŒ‡å®šæŒç»­æ—¶é—´ã€‚è·å–è·Ÿè¸ªæ–‡ä»¶ä¹‹åï¼Œä½¿ç”¨ <code>go tool trace</code> å‘½ä»¤æ¥åˆ†æã€‚</li></ul><h3 id=åœ¨-web-æŸ¥çœ‹åˆ†ææŠ¥å‘Š>åœ¨ Web æŸ¥çœ‹åˆ†ææŠ¥å‘Š
<a class=anchor href=#%e5%9c%a8-web-%e6%9f%a5%e7%9c%8b%e5%88%86%e6%9e%90%e6%8a%a5%e5%91%8a>#</a></h3><p>ç‚¹å‡» profileï¼Œç­‰å¾… 30s åä¼šä¸‹è½½ CPU profile æ–‡ä»¶ï¼Œæˆ–è€…æ‰§è¡Œå‘½ä»¤ <code>go tool pprof http://localhost:8080/debug/pprof/profile</code> ï¼Œå¾—åˆ°çš„è¾“å‡ºä¸­æœ‰ä¸€è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng.CORPDOM<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.samples.cpu.002.pb.gz<span style=color:#e6db74>`</span>
</span></span></code></pre></div><p>è¡¨ç¤ºç”Ÿæˆçš„ profile æ–‡ä»¶è·¯å¾„ã€‚</p><p>æ‰§è¡Œ <code>go tool pprof -http=&lt;port> &lt;profile æ–‡ä»¶></code> å¯åŠ¨ web serverï¼Œç„¶åå°±å¯ä»¥è®¿é—® <code>http://localhost:8081</code> æ¥æŸ¥çœ‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ go tool pprof -http<span style=color:#f92672>=</span>:8081 profile
</span></span><span style=display:flex><span>Serving web UI on http://localhost:8081
</span></span></code></pre></div><p>æˆ–è€…è¾“å…¥ <code>web</code>ï¼Œä¼šåœ¨æµè§ˆå™¨æ‰“å¼€ä¸€ä¸ª svg å›¾ç‰‡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ go tool pprof profile
</span></span><span style=display:flex><span>$ <span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> web
</span></span></code></pre></div><blockquote><p>å¦‚æœå‡ºç° <code>Could not execute dot; may need to install graphviz.</code>ï¼Œé‚£ä¹ˆéœ€è¦å®‰è£ Graphvizã€‚</p></blockquote><p><img src=https://raw.githubusercontent.com/shipengqi/illustrations/810cbdff82baab7279ec4504d20e5b7bd88b6b33/go/profile-graph.png alt=profile-graph></p><p>å›¾ä¸­æ¡†è¶Šå¤§ï¼Œçº¿è¶Šç²—ä»£è¡¨å®ƒå ç”¨ CPU çš„æ—¶é—´è¶Šé•¿ã€‚</p><p>ç‚¹å‡» <code>View -> Flame Graph</code> å¯ä»¥æŸ¥çœ‹ç«ç„°å›¾ï¼š</p><p><img src=https://raw.githubusercontent.com/shipengqi/illustrations/810cbdff82baab7279ec4504d20e5b7bd88b6b33/go/profile-flame-graph.png alt=profile-flame-graph></p><p>å›¾ä¸­è°ƒç”¨é¡ºåºç”±ä¸Šåˆ°ä¸‹ï¼Œæ¯ä¸€å—ä»£è¡¨ä¸€ä¸ªå‡½æ•°ï¼Œè¶Šå¤§ä»£è¡¨å ç”¨ CPU çš„æ—¶é—´è¶Šé•¿ã€‚</p><p>è¿˜å¯ä»¥æŸ¥çœ‹ Topï¼ŒPeekï¼ŒSource ç­‰ã€‚èƒ½å¤Ÿæ›´æ–¹ä¾¿ã€æ›´ç›´è§‚çš„çœ‹åˆ° Go åº”ç”¨ç¨‹åºçš„è°ƒç”¨é“¾ã€ä½¿ç”¨æƒ…å†µç­‰ã€‚</p><h3 id=åœ¨ç»ˆç«¯æŸ¥çœ‹åˆ†ææŠ¥å‘Š>åœ¨ç»ˆç«¯æŸ¥çœ‹åˆ†ææŠ¥å‘Š
<a class=anchor href=#%e5%9c%a8%e7%bb%88%e7%ab%af%e6%9f%a5%e7%9c%8b%e5%88%86%e6%9e%90%e6%8a%a5%e5%91%8a>#</a></h3><p>ä½¿ç”¨ <code>go tool pprof</code> å‘½ä»¤å¯ä»¥åœ¨äº¤äº’å¼ç»ˆç«¯æŸ¥çœ‹åˆ†ææŠ¥å‘Šã€‚</p><h4 id=cpu-profiling>CPU Profiling
<a class=anchor href=#cpu-profiling>#</a></h4><p>æ‰§è¡Œ 60s çš„ CPU Profilingï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ go tool pprof http://localhost:8080/debug/pprof/profile?seconds<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>Fetching profile over HTTP from http://localhost:6060/debug/pprof/profile?seconds<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng.CORPDOM<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.samples.cpu.001.pb.gz
</span></span><span style=display:flex><span>Type: cpu
</span></span><span style=display:flex><span>Time: Nov 18, <span style=color:#ae81ff>2019</span> at 11:08am <span style=color:#f92672>(</span>CST<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Duration: 10.20s, Total samples <span style=color:#f92672>=</span> 10.03s <span style=color:#f92672>(</span>98.38%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Entering interactive mode <span style=color:#f92672>(</span>type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> commands, <span style=color:#e6db74>&#34;o&#34;</span> <span style=color:#66d9ef>for</span> options<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>è¾“å…¥ <code>top 10</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> top <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Showing nodes accounting <span style=color:#66d9ef>for</span> 9.54s, 95.11% of 10.03s total
</span></span><span style=display:flex><span>Dropped <span style=color:#ae81ff>73</span> nodes <span style=color:#f92672>(</span>cum &lt;<span style=color:#f92672>=</span> 0.05s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Showing top <span style=color:#ae81ff>10</span> nodes out of <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>      flat  flat%   sum%        cum   cum%
</span></span><span style=display:flex><span>     9.42s 93.92% 93.92%      9.46s 94.32%  runtime.cgocall
</span></span><span style=display:flex><span>     0.02s   0.2% 94.12%      9.62s 95.91%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.writeConsole
</span></span><span style=display:flex><span>     0.02s   0.2% 94.32%      9.81s 97.81%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.Output
</span></span><span style=display:flex><span>     0.02s   0.2% 94.52%      0.10s     1%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.formatHeader
</span></span><span style=display:flex><span>     0.02s   0.2% 94.72%      0.06s   0.6%  main.Add
</span></span><span style=display:flex><span>     0.02s   0.2% 94.92%      9.50s 94.72%  syscall.Syscall6
</span></span><span style=display:flex><span>     0.01s   0.1% 95.01%      0.07s   0.7%  runtime.systemstack
</span></span><span style=display:flex><span>     0.01s   0.1% 95.11%      9.51s 94.82%  syscall.WriteConsole
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0% 95.11%      0.07s   0.7%  fmt.Sprintln
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0% 95.11%      9.69s 96.61%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.Write
</span></span></code></pre></div><ul><li><code>flat</code>ï¼šå½“å‰å‡½æ•°ä¸Šçš„è¿è¡Œè€—æ—¶</li><li><code>flat%</code>ï¼šå½“å‰å‡½æ•°ä¸Šçš„ CPU è¿è¡Œè€—æ—¶æ€»æ¯”ä¾‹</li><li><code>sum%</code>ï¼šå½“å‰å‡½æ•°ä¸Šç´¯ç§¯ä½¿ç”¨ CPU æ€»æ¯”ä¾‹</li><li><code>cum</code>ï¼šå½“å‰å‡½æ•°åŠ ä¸Šå®ƒä¹‹ä¸Šçš„è°ƒç”¨è¿è¡Œæ€»è€—æ—¶</li><li><code>cum%</code>ï¼šå½“å‰å‡½æ•°åŠ ä¸Šå®ƒä¹‹ä¸Šçš„è°ƒç”¨çš„ CPU è¿è¡Œè€—æ—¶æ€»æ¯”ä¾‹</li><li>æœ€åä¸€åˆ—ä¸ºå‡½æ•°åç§°</li></ul><h4 id=heap-profiling>Heap Profiling
<a class=anchor href=#heap-profiling>#</a></h4><p>Heap Profiling æ”¯æŒå››ç§å†…å­˜æ¦‚å†µçš„åˆ†æï¼š</p><ul><li><code>inuse_space</code>ï¼šåˆ†æç¨‹åºå¸¸é©»å†…å­˜çš„å ç”¨</li><li><code>alloc_objects</code>ï¼šåˆ†æç¨‹åºä¸´æ—¶åˆ†é…çš„å†…å­˜</li><li><code>inuse_objects</code>ï¼šæŸ¥çœ‹å‡½æ•°å¯¹åº”çš„å¯¹è±¡çš„æ•°é‡</li><li><code>alloc_space</code>ï¼šæŸ¥çœ‹å‡½æ•°åˆ†é…çš„å†…å­˜ç©ºé—´å¤§å°</li></ul><p>é»˜è®¤å°±æ˜¯ <code>inuse_space</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># é»˜è®¤å°±æ˜¯ inuse_spaceï¼Œ-inuse_space å¯ä»¥å¿½ç•¥</span>
</span></span><span style=display:flex><span>$ go tool pprof -inuse_space http://localhost:8080/debug/pprof/heap
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.___go_build_github_com_shipengqi_example_v1_advance_go_pprof.exe.alloc_objects.alloc_space.inuse_objects.inuse_space.002.pb.gz
</span></span><span style=display:flex><span>Type: inuse_space
</span></span><span style=display:flex><span>Time: Dec 6, <span style=color:#ae81ff>2023</span> at 2:05pm <span style=color:#f92672>(</span>CST<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Entering interactive mode <span style=color:#f92672>(</span>type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> commands, <span style=color:#e6db74>&#34;o&#34;</span> <span style=color:#66d9ef>for</span> options<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>è¾“å…¥ <code>top</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> top
</span></span><span style=display:flex><span>Showing nodes accounting <span style=color:#66d9ef>for</span> 42464.20kB, 100% of 42464.20kB total
</span></span><span style=display:flex><span>      flat  flat%   sum%        cum   cum%
</span></span><span style=display:flex><span>41952.16kB 98.79% 98.79% 41952.16kB 98.79%  main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  512.04kB  1.21%   100%   512.04kB  1.21%  unicode/utf16.Encode
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.Write
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.writeConsole
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.output
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  log.Println <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100% 42464.20kB   100%  main.main.func1
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  os.<span style=color:#f92672>(</span>*File<span style=color:#f92672>)</span>.Write
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  os.<span style=color:#f92672>(</span>*File<span style=color:#f92672>)</span>.write <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>è¾“å…¥ <code>traces</code> æŸ¥çœ‹ goroutines å ç”¨å†…å­˜çš„å¤§å°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> traces
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Type: inuse_space
</span></span><span style=display:flex><span>Time: Dec 6, <span style=color:#ae81ff>2023</span> at 2:45pm <span style=color:#f92672>(</span>CST<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>     bytes:  2.25MB
</span></span><span style=display:flex><span>    2.28MB   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>     bytes:  1.80MB
</span></span><span style=display:flex><span>    1.85MB   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>     bytes:  1.43MB
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>     bytes:  1.14MB
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span></code></pre></div><h4 id=goroutine-profiling>Goroutine Profiling
<a class=anchor href=#goroutine-profiling>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ go tool pprof http://localhost:8080/debug/pprof/goroutine
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.___go_build_github_com_shipengqi_example_v1_advance_go_pprof.exe.goroutine.001.pb.gz
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>è¾“å…¥ <code>traces</code> ä¼šè¾“å‡ºæ‰€æœ‰ goroutines çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æŸ¥çœ‹æ•´ä¸ªè°ƒç”¨é“¾ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> traces
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>1</span>   runtime.cgocall
</span></span><span style=display:flex><span>             syscall.SyscallN
</span></span><span style=display:flex><span>             syscall.Syscall6
</span></span><span style=display:flex><span>             syscall.WriteConsole
</span></span><span style=display:flex><span>             internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.writeConsole
</span></span><span style=display:flex><span>             internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.Write
</span></span><span style=display:flex><span>             os.<span style=color:#f92672>(</span>*File<span style=color:#f92672>)</span>.write <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             os.<span style=color:#f92672>(</span>*File<span style=color:#f92672>)</span>.Write
</span></span><span style=display:flex><span>             log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.output
</span></span><span style=display:flex><span>             log.Println <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>1</span>   runtime.goroutineProfileWithLabels
</span></span><span style=display:flex><span>             runtime/pprof.runtime_goroutineProfileWithLabels
</span></span><span style=display:flex><span>             runtime/pprof.writeRuntimeProfile
</span></span><span style=display:flex><span>             runtime/pprof.writeGoroutine
</span></span><span style=display:flex><span>             runtime/pprof.<span style=color:#f92672>(</span>*Profile<span style=color:#f92672>)</span>.WriteTo
</span></span><span style=display:flex><span>             net/http/pprof.handler.ServeHTTP
</span></span><span style=display:flex><span>             net/http/pprof.Index
</span></span><span style=display:flex><span>             net/http.HandlerFunc.ServeHTTP
</span></span><span style=display:flex><span>             net/http.<span style=color:#f92672>(</span>*ServeMux<span style=color:#f92672>)</span>.ServeHTTP
</span></span><span style=display:flex><span>             net/http.serverHandler.ServeHTTP
</span></span><span style=display:flex><span>             net/http.<span style=color:#f92672>(</span>*conn<span style=color:#f92672>)</span>.serve
</span></span></code></pre></div><p>è°ƒç”¨æ ˆçš„é¡ºåºæ˜¯<strong>è‡ªä¸‹è€Œä¸Š</strong>çš„ã€‚</p><h4 id=block-å’Œ-mutex-profiling>Block å’Œ Mutex Profiling
<a class=anchor href=#block-%e5%92%8c-mutex-profiling>#</a></h4><p>Block å’Œ Mutex Profiling éƒ½éœ€è¦åœ¨ä»£ç ä¸­è°ƒç”¨ <code>runtime</code> åŒ…çš„æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;runtime&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Rate å°äº 0ï¼Œåˆ™ä¸é‡‡é›†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>SetBlockProfileRate</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Fraction å°äº 0ï¼Œåˆ™ä¸é‡‡é›†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>SetMutexProfileFraction</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>ç„¶åä½¿ç”¨ <code>go tool pprof</code> åˆ†æï¼Œè¾“å…¥ <code>top</code> æŸ¥çœ‹æ’åï¼Œ<code>list &lt;func></code> å¯ä»¥æŸ¥çœ‹å…·ä½“çš„ä¿¡æ¯ã€‚</p><h4 id=å¯¹æ¯”>å¯¹æ¯”
<a class=anchor href=#%e5%af%b9%e6%af%94>#</a></h4><p>å½“éœ€è¦æŸ¥çœ‹ä¸åŒæ—¶é—´æ®µçš„å·®å¼‚æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>-base</code> å‚æ•°æ¥å¯¹æ¯”ä¸¤ä¸ª profile æ–‡ä»¶ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ go tool pprof -base &lt;profile1&gt; &lt;profile2&gt;
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/commit/ae7d18e833904df1969d337ca73a5243892b2003 title='Last modified by PengQi Shi | December 18, 2023' target=_blank rel=noopener><img src=/golang-learn/svg/calendar.svg class=book-icon alt=Calendar>
<span>December 18, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/edit/master/content/docs/practice/04_pprof.md target=_blank rel=noopener><img src=/golang-learn/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#go-æ€§èƒ½åˆ†æä¸Š>Go æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰</a><ul><li><a href=#å¦‚ä½•ç”Ÿæˆåˆ†ææ ·æœ¬>å¦‚ä½•ç”Ÿæˆåˆ†ææ ·æœ¬</a></li><li><a href=#å¦‚ä½•æŸ¥çœ‹åˆ†ææŠ¥å‘Š>å¦‚ä½•æŸ¥çœ‹åˆ†ææŠ¥å‘Š</a><ul><li><a href=#åœ¨-web-æŸ¥çœ‹åˆ†ææŠ¥å‘Š>åœ¨ Web æŸ¥çœ‹åˆ†ææŠ¥å‘Š</a></li><li><a href=#åœ¨ç»ˆç«¯æŸ¥çœ‹åˆ†ææŠ¥å‘Š>åœ¨ç»ˆç«¯æŸ¥çœ‹åˆ†ææŠ¥å‘Š</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>