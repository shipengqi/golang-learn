<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Go 性能分析（上） # Go 提供的 pprof 工具可以用来做性能分析。pprof 可以读取分析样本的集合，并生成报告以可视化并帮助分析数据。
pprof 可以用于：
CPU 分析（CPU Profiling）：按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期 时花费时间的位置。 内存分析（Memory Profiling）：在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏。 阻塞分析（Block Profiling）：记录 goroutine 阻塞等待同步（包括定时器通道）的位置。 互斥锁分析（Mutex Profiling）：报告互斥锁的竞争情况。 如何生成分析样本 # 生成分析样本的三种方式：
runtime/pprof：采集程序（非 Server）的运行数据。通过调用如 runtime.StartCPUProfile, runtime.StopCPUProfile 方法生成分析样本。主要用于本地测试。 pkg/profile 封装了 runtime/pprof，使用起来更加简便。 net/http/pprof：采集 HTTP Server 的运行时数据，通过 HTTP 服务获取 Profile 分析样本，底层还是调用的 runtime/pprof。主要用于服务器端测试。 go test -bench：使用 go test -bench=. -cpuprofile cpuprofile.out ... 运行基准测试来生成分析样本，可以指定所需标识来进行数据采集。 以 net/http/pprof 为例：
package main import ( &#34;log&#34; &#34;net/http&#34; _ &#34;net/http/pprof&#34; // net/http/pprof 注册的是默认的 mux ) var datas []string func Add(str string) string { data := []byte(str) sData := string(data) datas = append(datas, sData) return sData } func main() { go func() { for { log."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Go 性能分析（上）"><meta property="og:description" content="Go 性能分析（上） # Go 提供的 pprof 工具可以用来做性能分析。pprof 可以读取分析样本的集合，并生成报告以可视化并帮助分析数据。
pprof 可以用于：
CPU 分析（CPU Profiling）：按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期 时花费时间的位置。 内存分析（Memory Profiling）：在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏。 阻塞分析（Block Profiling）：记录 goroutine 阻塞等待同步（包括定时器通道）的位置。 互斥锁分析（Mutex Profiling）：报告互斥锁的竞争情况。 如何生成分析样本 # 生成分析样本的三种方式：
runtime/pprof：采集程序（非 Server）的运行数据。通过调用如 runtime.StartCPUProfile, runtime.StopCPUProfile 方法生成分析样本。主要用于本地测试。 pkg/profile 封装了 runtime/pprof，使用起来更加简便。 net/http/pprof：采集 HTTP Server 的运行时数据，通过 HTTP 服务获取 Profile 分析样本，底层还是调用的 runtime/pprof。主要用于服务器端测试。 go test -bench：使用 go test -bench=. -cpuprofile cpuprofile.out ... 运行基准测试来生成分析样本，可以指定所需标识来进行数据采集。 以 net/http/pprof 为例：
package main import ( &#34;log&#34; &#34;net/http&#34; _ &#34;net/http/pprof&#34; // net/http/pprof 注册的是默认的 mux ) var datas []string func Add(str string) string { data := []byte(str) sData := string(data) datas = append(datas, sData) return sData } func main() { go func() { for { log."><meta property="og:type" content="article"><meta property="og:url" content="https://shipengqi.github.io/golang-learn/docs/practice/04_pprof/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-12-18T13:21:57+08:00"><title>Go 性能分析（上） | Go Learning</title><link rel=manifest href=/golang-learn/manifest.json><link rel=icon href=/golang-learn/favicon.png><link rel=stylesheet href=/golang-learn/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/golang-learn/flexsearch.min.js></script>
<script defer src=/golang-learn/en.search.min.fe92e04ba07cc0f41f6a75f1c80d85bf2fac1dc49d6e5098de44895faeebc1f1.js integrity="sha256-/pLgS6B8wPQfanXxyA2Fvy+sHcSdblCY3kSJX67rwfE=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/golang-learn/><span>Go Learning</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://shipengqi.github.io/ target=_blank rel=noopener>Blog</a></li><li><a href=https://github.com/shipengqi/golang-learn target=_blank rel=noopener>Github</a></li></ul><ul><li><span>🍚 语言基础</span><ul><li><a href=/golang-learn/docs/basic/01_basic_type/>基础数据类型</a></li><li><a href=/golang-learn/docs/basic/02_array/>数组</a></li><li><a href=/golang-learn/docs/basic/03_slice/>切片</a></li><li><a href=/golang-learn/docs/basic/04_map/>哈希表</a></li><li><a href=/golang-learn/docs/basic/05_function/>函数</a></li><li><a href=/golang-learn/docs/basic/09_pointer/>指针</a></li></ul></li><li><a href=/golang-learn/docs/concurrency/>⚡ 并发编程</a><ul><li><a href=/golang-learn/docs/concurrency/01_mutex/>互斥锁</a></li><li><a href=/golang-learn/docs/concurrency/02_rwmutex/>读写锁</a></li><li><a href=/golang-learn/docs/concurrency/03_waitgroup/>WaitGroup</a></li><li><a href=/golang-learn/docs/concurrency/04_cond/>条件变量</a></li><li><a href=/golang-learn/docs/concurrency/05_once/>Once</a></li><li><a href=/golang-learn/docs/concurrency/06_pool/>Pool</a></li><li><a href=/golang-learn/docs/concurrency/07_context/>Context</a></li><li><a href=/golang-learn/docs/concurrency/08_atomic/>原子操作</a></li><li><a href=/golang-learn/docs/concurrency/09_channel/>Channel</a></li><li><a href=/golang-learn/docs/concurrency/10_sema/>信号量</a></li><li><a href=/golang-learn/docs/concurrency/11_singleflight/>SingleFlight</a></li><li><a href=/golang-learn/docs/concurrency/12_errorgroup/>ErrGroup</a></li></ul></li><li><span>🛠️ 实践</span><ul><li><a href=/golang-learn/docs/practice/01_build/>Go 编译</a></li><li><a href=/golang-learn/docs/practice/02_go_race/>Go 数据竞争检测器</a></li><li><a href=/golang-learn/docs/practice/04_pprof/ class=active>Go 性能分析（上）</a></li><li><a href=/golang-learn/docs/practice/05_trace/>Go 性能分析（下）</a></li><li><a href=/golang-learn/docs/practice/06_performance/>Go 性能优化</a></li><li><a href=/golang-learn/docs/practice/07_coredump/>Go Core Dump 调试</a></li><li><a href=/golang-learn/docs/practice/08_mod/>Go Modules</a></li><li><a href=/golang-learn/docs/practice/09_gin/>Gin 静态服务器</a></li><li><a href=/golang-learn/docs/practice/10_remote_dev/>Go 远程开发调试</a></li></ul></li><li><span>🛠️ Go 工程实践</span><ul><li><a href=/golang-learn/docs/project/01_specs/>项目规范</a></li><li><a href=/golang-learn/docs/project/02_structure/>项目的目录结构</a></li><li><a href=/golang-learn/docs/project/03_code/>代码规范</a></li><li><a href=/golang-learn/docs/project/04_commitizen/>Commit 规范</a></li><li><a href=/golang-learn/docs/project/05_version/>版本规范</a></li><li><a href=/golang-learn/docs/project/06_api_doc/>API 文档</a></li><li><a href=/golang-learn/docs/project/07_flow/>Git 工作流程</a></li><li><a href=/golang-learn/docs/project/08_make/>项目管理</a></li><li><a href=/golang-learn/docs/project/09_actions/>GitHub Actions</a></li><li><a href=/golang-learn/docs/project/10_dependabot/>GitHub Dependabot</a></li><li><a href=/golang-learn/docs/project/11_templates/>GitHub 模板</a></li><li><a href=/golang-learn/docs/project/12_goreleaser/>GoReleaser</a></li></ul></li><li><a href=/golang-learn/docs/advance/>🔍 底层原理</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/golang-learn/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Go 性能分析（上）</strong>
<label for=toc-control><img src=/golang-learn/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#go-性能分析上>Go 性能分析（上）</a><ul><li><a href=#如何生成分析样本>如何生成分析样本</a></li><li><a href=#如何查看分析报告>如何查看分析报告</a><ul><li><a href=#在-web-查看分析报告>在 Web 查看分析报告</a></li><li><a href=#在终端查看分析报告>在终端查看分析报告</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=go-性能分析上>Go 性能分析（上）
<a class=anchor href=#go-%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e4%b8%8a>#</a></h1><p>Go 提供的 pprof 工具可以用来做性能分析。pprof 可以读取分析样本的集合，并生成报告以可视化并帮助分析数据。</p><p>pprof 可以用于：</p><ul><li>CPU 分析（CPU Profiling）：按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期
时花费时间的位置。</li><li>内存分析（Memory Profiling）：在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏。</li><li>阻塞分析（Block Profiling）：记录 goroutine 阻塞等待同步（包括定时器通道）的位置。</li><li>互斥锁分析（Mutex Profiling）：报告互斥锁的竞争情况。</li></ul><h2 id=如何生成分析样本>如何生成分析样本
<a class=anchor href=#%e5%a6%82%e4%bd%95%e7%94%9f%e6%88%90%e5%88%86%e6%9e%90%e6%a0%b7%e6%9c%ac>#</a></h2><p>生成分析样本的三种方式：</p><ul><li><code>runtime/pprof</code>：采集程序（非 Server）的运行数据。通过调用如 <code>runtime.StartCPUProfile</code>, <code>runtime.StopCPUProfile</code> 方法生成分析样本。主要用于<strong>本地测试</strong>。<ul><li><a href=https://github.com/pkg/profile>pkg/profile</a> 封装了 <code>runtime/pprof</code>，使用起来更加简便。</li></ul></li><li><code>net/http/pprof</code>：采集 HTTP Server 的运行时数据，通过 HTTP 服务获取 Profile 分析样本，底层还是调用的 <code>runtime/pprof</code>。主要用于<strong>服务器端测试</strong>。</li><li><code>go test -bench</code>：使用 <code>go test -bench=. -cpuprofile cpuprofile.out ...</code> 运行基准测试来生成分析样本，可以指定所需标识来进行数据采集。</li></ul><p>以 <code>net/http/pprof</code> 为例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;net/http/pprof&#34;</span> <span style=color:#75715e>// net/http/pprof 注册的是默认的 mux
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>datas</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>str</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#a6e22e>str</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sData</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>datas</span> = append(<span style=color:#a6e22e>datas</span>, <span style=color:#a6e22e>sData</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sData</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;https://github.com/shipengqi&#34;</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;0.0.0.0:8080&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>_ "net/http/pprof"</code> 这行代码会自动添加 <code>/debug/pprof</code> 的路由。程序运行后，访问 http://localhost:8080/debug/pprof 就可以查看分析样本。</p><h2 id=如何查看分析报告>如何查看分析报告
<a class=anchor href=#%e5%a6%82%e4%bd%95%e6%9f%a5%e7%9c%8b%e5%88%86%e6%9e%90%e6%8a%a5%e5%91%8a>#</a></h2><p>打开 http://localhost:8080/debug/pprof 后会看到下面页面：</p><p><img src=https://raw.githubusercontent.com/shipengqi/illustrations/810cbdff82baab7279ec4504d20e5b7bd88b6b33/go/pprof-home.png alt=pprof-home></p><p>pprof 包括了几个子页面：</p><ul><li>alloc: 查看所有内存分配的情况</li><li>block（Block Profiling）：<code>&lt;ip:port>/debug/pprof/block</code>，查看导致阻塞同步的堆栈跟踪</li><li>cmdline : 当前程序的命令行调用</li><li>goroutine：<code>&lt;ip:port>/debug/pprof/goroutine</code>，查看当前所有运行的 goroutines 堆栈跟踪。</li><li>heap（Memory Profiling）: <code>&lt;ip:port>/debug/pprof/heap</code>，查看活动对象的内存分配情况，在获取堆样本之前，可以指定 gc GET 参数来运行 gc。</li><li>mutex（Mutex Profiling）: <code>&lt;ip:port>/debug/pprof/mutex</code>，查看导致互斥锁竞争的持有者的堆栈跟踪。</li><li>profile（CPU Profiling）: <code>&lt;ip:port>/debug/pprof/profile</code>， 默认进行 <code>30s</code> 的 CPU Profiling，可以设置 GET 参数 <code>seconds</code> 来指定持续时间。获取跟踪文件之后，使用 <code>go tool trace</code> 命令来分析。</li><li>threadcreate：<code>&lt;ip:port>/debug/pprof/threadcreate</code>，查看创建新 OS 线程的堆栈跟踪。</li><li>trace: 当前程序的执行轨迹。可以设置 GET 参数 <code>seconds</code> 来指定持续时间。获取跟踪文件之后，使用 <code>go tool trace</code> 命令来分析。</li></ul><h3 id=在-web-查看分析报告>在 Web 查看分析报告
<a class=anchor href=#%e5%9c%a8-web-%e6%9f%a5%e7%9c%8b%e5%88%86%e6%9e%90%e6%8a%a5%e5%91%8a>#</a></h3><p>点击 profile，等待 30s 后会下载 CPU profile 文件，或者执行命令 <code>go tool pprof http://localhost:8080/debug/pprof/profile</code> ，得到的输出中有一行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng.CORPDOM<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.samples.cpu.002.pb.gz<span style=color:#e6db74>`</span>
</span></span></code></pre></div><p>表示生成的 profile 文件路径。</p><p>执行 <code>go tool pprof -http=&lt;port> &lt;profile 文件></code> 启动 web server，然后就可以访问 <code>http://localhost:8081</code> 来查看：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ go tool pprof -http<span style=color:#f92672>=</span>:8081 profile
</span></span><span style=display:flex><span>Serving web UI on http://localhost:8081
</span></span></code></pre></div><p>或者输入 <code>web</code>，会在浏览器打开一个 svg 图片：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ go tool pprof profile
</span></span><span style=display:flex><span>$ <span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> web
</span></span></code></pre></div><blockquote><p>如果出现 <code>Could not execute dot; may need to install graphviz.</code>，那么需要安裝 Graphviz。</p></blockquote><p><img src=https://raw.githubusercontent.com/shipengqi/illustrations/810cbdff82baab7279ec4504d20e5b7bd88b6b33/go/profile-graph.png alt=profile-graph></p><p>图中框越大，线越粗代表它占用 CPU 的时间越长。</p><p>点击 <code>View -> Flame Graph</code> 可以查看火焰图：</p><p><img src=https://raw.githubusercontent.com/shipengqi/illustrations/810cbdff82baab7279ec4504d20e5b7bd88b6b33/go/profile-flame-graph.png alt=profile-flame-graph></p><p>图中调用顺序由上到下，每一块代表一个函数，越大代表占用 CPU 的时间越长。</p><p>还可以查看 Top，Peek，Source 等。能够更方便、更直观的看到 Go 应用程序的调用链、使用情况等。</p><h3 id=在终端查看分析报告>在终端查看分析报告
<a class=anchor href=#%e5%9c%a8%e7%bb%88%e7%ab%af%e6%9f%a5%e7%9c%8b%e5%88%86%e6%9e%90%e6%8a%a5%e5%91%8a>#</a></h3><p>使用 <code>go tool pprof</code> 命令可以在交互式终端查看分析报告。</p><h4 id=cpu-profiling>CPU Profiling
<a class=anchor href=#cpu-profiling>#</a></h4><p>执行 60s 的 CPU Profiling：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ go tool pprof http://localhost:8080/debug/pprof/profile?seconds<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>Fetching profile over HTTP from http://localhost:6060/debug/pprof/profile?seconds<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng.CORPDOM<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.samples.cpu.001.pb.gz
</span></span><span style=display:flex><span>Type: cpu
</span></span><span style=display:flex><span>Time: Nov 18, <span style=color:#ae81ff>2019</span> at 11:08am <span style=color:#f92672>(</span>CST<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Duration: 10.20s, Total samples <span style=color:#f92672>=</span> 10.03s <span style=color:#f92672>(</span>98.38%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Entering interactive mode <span style=color:#f92672>(</span>type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> commands, <span style=color:#e6db74>&#34;o&#34;</span> <span style=color:#66d9ef>for</span> options<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>输入 <code>top 10</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> top <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Showing nodes accounting <span style=color:#66d9ef>for</span> 9.54s, 95.11% of 10.03s total
</span></span><span style=display:flex><span>Dropped <span style=color:#ae81ff>73</span> nodes <span style=color:#f92672>(</span>cum &lt;<span style=color:#f92672>=</span> 0.05s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Showing top <span style=color:#ae81ff>10</span> nodes out of <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>      flat  flat%   sum%        cum   cum%
</span></span><span style=display:flex><span>     9.42s 93.92% 93.92%      9.46s 94.32%  runtime.cgocall
</span></span><span style=display:flex><span>     0.02s   0.2% 94.12%      9.62s 95.91%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.writeConsole
</span></span><span style=display:flex><span>     0.02s   0.2% 94.32%      9.81s 97.81%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.Output
</span></span><span style=display:flex><span>     0.02s   0.2% 94.52%      0.10s     1%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.formatHeader
</span></span><span style=display:flex><span>     0.02s   0.2% 94.72%      0.06s   0.6%  main.Add
</span></span><span style=display:flex><span>     0.02s   0.2% 94.92%      9.50s 94.72%  syscall.Syscall6
</span></span><span style=display:flex><span>     0.01s   0.1% 95.01%      0.07s   0.7%  runtime.systemstack
</span></span><span style=display:flex><span>     0.01s   0.1% 95.11%      9.51s 94.82%  syscall.WriteConsole
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0% 95.11%      0.07s   0.7%  fmt.Sprintln
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0% 95.11%      9.69s 96.61%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.Write
</span></span></code></pre></div><ul><li><code>flat</code>：当前函数上的运行耗时</li><li><code>flat%</code>：当前函数上的 CPU 运行耗时总比例</li><li><code>sum%</code>：当前函数上累积使用 CPU 总比例</li><li><code>cum</code>：当前函数加上它之上的调用运行总耗时</li><li><code>cum%</code>：当前函数加上它之上的调用的 CPU 运行耗时总比例</li><li>最后一列为函数名称</li></ul><h4 id=heap-profiling>Heap Profiling
<a class=anchor href=#heap-profiling>#</a></h4><p>Heap Profiling 支持四种内存概况的分析：</p><ul><li><code>inuse_space</code>：分析程序常驻内存的占用</li><li><code>alloc_objects</code>：分析程序临时分配的内存</li><li><code>inuse_objects</code>：查看函数对应的对象的数量</li><li><code>alloc_space</code>：查看函数分配的内存空间大小</li></ul><p>默认就是 <code>inuse_space</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 默认就是 inuse_space，-inuse_space 可以忽略</span>
</span></span><span style=display:flex><span>$ go tool pprof -inuse_space http://localhost:8080/debug/pprof/heap
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.___go_build_github_com_shipengqi_example_v1_advance_go_pprof.exe.alloc_objects.alloc_space.inuse_objects.inuse_space.002.pb.gz
</span></span><span style=display:flex><span>Type: inuse_space
</span></span><span style=display:flex><span>Time: Dec 6, <span style=color:#ae81ff>2023</span> at 2:05pm <span style=color:#f92672>(</span>CST<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Entering interactive mode <span style=color:#f92672>(</span>type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> commands, <span style=color:#e6db74>&#34;o&#34;</span> <span style=color:#66d9ef>for</span> options<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>输入 <code>top</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> top
</span></span><span style=display:flex><span>Showing nodes accounting <span style=color:#66d9ef>for</span> 42464.20kB, 100% of 42464.20kB total
</span></span><span style=display:flex><span>      flat  flat%   sum%        cum   cum%
</span></span><span style=display:flex><span>41952.16kB 98.79% 98.79% 41952.16kB 98.79%  main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  512.04kB  1.21%   100%   512.04kB  1.21%  unicode/utf16.Encode
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.Write
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.writeConsole
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.output
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  log.Println <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100% 42464.20kB   100%  main.main.func1
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  os.<span style=color:#f92672>(</span>*File<span style=color:#f92672>)</span>.Write
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>     0%   100%   512.04kB  1.21%  os.<span style=color:#f92672>(</span>*File<span style=color:#f92672>)</span>.write <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>输入 <code>traces</code> 查看 goroutines 占用内存的大小：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> traces
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Type: inuse_space
</span></span><span style=display:flex><span>Time: Dec 6, <span style=color:#ae81ff>2023</span> at 2:45pm <span style=color:#f92672>(</span>CST<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>     bytes:  2.25MB
</span></span><span style=display:flex><span>    2.28MB   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>     bytes:  1.80MB
</span></span><span style=display:flex><span>    1.85MB   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>     bytes:  1.43MB
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>     bytes:  1.14MB
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>0</span>   main.Add <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span></code></pre></div><h4 id=goroutine-profiling>Goroutine Profiling
<a class=anchor href=#goroutine-profiling>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ go tool pprof http://localhost:8080/debug/pprof/goroutine
</span></span><span style=display:flex><span>Saved profile in C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\s</span>hipeng<span style=color:#ae81ff>\p</span>prof<span style=color:#ae81ff>\p</span>prof.___go_build_github_com_shipengqi_example_v1_advance_go_pprof.exe.goroutine.001.pb.gz
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>输入 <code>traces</code> 会输出所有 goroutines 的调用栈信息，可以很方便的查看整个调用链。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>pprof<span style=color:#f92672>)</span> traces
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>1</span>   runtime.cgocall
</span></span><span style=display:flex><span>             syscall.SyscallN
</span></span><span style=display:flex><span>             syscall.Syscall6
</span></span><span style=display:flex><span>             syscall.WriteConsole
</span></span><span style=display:flex><span>             internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.writeConsole
</span></span><span style=display:flex><span>             internal/poll.<span style=color:#f92672>(</span>*FD<span style=color:#f92672>)</span>.Write
</span></span><span style=display:flex><span>             os.<span style=color:#f92672>(</span>*File<span style=color:#f92672>)</span>.write <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             os.<span style=color:#f92672>(</span>*File<span style=color:#f92672>)</span>.Write
</span></span><span style=display:flex><span>             log.<span style=color:#f92672>(</span>*Logger<span style=color:#f92672>)</span>.output
</span></span><span style=display:flex><span>             log.Println <span style=color:#f92672>(</span>inline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             main.main.func1
</span></span><span style=display:flex><span>-----------+-------------------------------------------------------
</span></span><span style=display:flex><span>         <span style=color:#ae81ff>1</span>   runtime.goroutineProfileWithLabels
</span></span><span style=display:flex><span>             runtime/pprof.runtime_goroutineProfileWithLabels
</span></span><span style=display:flex><span>             runtime/pprof.writeRuntimeProfile
</span></span><span style=display:flex><span>             runtime/pprof.writeGoroutine
</span></span><span style=display:flex><span>             runtime/pprof.<span style=color:#f92672>(</span>*Profile<span style=color:#f92672>)</span>.WriteTo
</span></span><span style=display:flex><span>             net/http/pprof.handler.ServeHTTP
</span></span><span style=display:flex><span>             net/http/pprof.Index
</span></span><span style=display:flex><span>             net/http.HandlerFunc.ServeHTTP
</span></span><span style=display:flex><span>             net/http.<span style=color:#f92672>(</span>*ServeMux<span style=color:#f92672>)</span>.ServeHTTP
</span></span><span style=display:flex><span>             net/http.serverHandler.ServeHTTP
</span></span><span style=display:flex><span>             net/http.<span style=color:#f92672>(</span>*conn<span style=color:#f92672>)</span>.serve
</span></span></code></pre></div><p>调用栈的顺序是<strong>自下而上</strong>的。</p><h4 id=block-和-mutex-profiling>Block 和 Mutex Profiling
<a class=anchor href=#block-%e5%92%8c-mutex-profiling>#</a></h4><p>Block 和 Mutex Profiling 都需要在代码中调用 <code>runtime</code> 包的方法进行设置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;runtime&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Rate 小于 0，则不采集
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>SetBlockProfileRate</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Fraction 小于 0，则不采集
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>SetMutexProfileFraction</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>然后使用 <code>go tool pprof</code> 分析，输入 <code>top</code> 查看排名，<code>list &lt;func></code> 可以查看具体的信息。</p><h4 id=对比>对比
<a class=anchor href=#%e5%af%b9%e6%af%94>#</a></h4><p>当需要查看不同时间段的差异时，可以使用 <code>-base</code> 参数来对比两个 profile 文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ go tool pprof -base &lt;profile1&gt; &lt;profile2&gt;
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/commit/ae7d18e833904df1969d337ca73a5243892b2003 title='Last modified by PengQi Shi | December 18, 2023' target=_blank rel=noopener><img src=/golang-learn/svg/calendar.svg class=book-icon alt=Calendar>
<span>December 18, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/edit/master/content/docs/practice/04_pprof.md target=_blank rel=noopener><img src=/golang-learn/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#go-性能分析上>Go 性能分析（上）</a><ul><li><a href=#如何生成分析样本>如何生成分析样本</a></li><li><a href=#如何查看分析报告>如何查看分析报告</a><ul><li><a href=#在-web-查看分析报告>在 Web 查看分析报告</a></li><li><a href=#在终端查看分析报告>在终端查看分析报告</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>