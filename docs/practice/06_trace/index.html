<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Go Trace # Go PProf å¾ˆéš¾å®Œæˆ Goroutine çš„åˆ†æã€‚è¿™å°±éœ€è¦ä½¿ç”¨ go tool trace å‘½ä»¤ã€‚
go tool pprof å¯ä»¥è·Ÿè¸ªè¿è¡Œç¼“æ…¢çš„å‡½æ•°ï¼Œæˆ–è€…æ‰¾åˆ°å¤§éƒ¨åˆ† CPU æ—¶é—´èŠ±è´¹åœ¨å“ªé‡Œã€‚ go tool trace æ›´é€‚åˆäºæ‰¾å‡ºç¨‹åºåœ¨ä¸€æ®µæ—¶é—´å†…æ­£åœ¨åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯æ€»ä½“ä¸Šçš„å¼€é”€ã€‚
package main import ( &#34;os&#34; &#34;runtime/trace&#34; ) func main() { f, err := os.Create(&#34;trace.out&#34;) if err != nil { panic(err) } defer f.Close() err = trace.Start(f) if err != nil { panic(err) } defer trace.Stop() ch := make(chan string) go func() { ch <- &#34;hello&#34; }() // read from channel <-ch } ç”Ÿæˆè·Ÿè¸ªæ–‡ä»¶ï¼š"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Go Trace"><meta property="og:description" content="Go Trace # Go PProf å¾ˆéš¾å®Œæˆ Goroutine çš„åˆ†æã€‚è¿™å°±éœ€è¦ä½¿ç”¨ go tool trace å‘½ä»¤ã€‚
go tool pprof å¯ä»¥è·Ÿè¸ªè¿è¡Œç¼“æ…¢çš„å‡½æ•°ï¼Œæˆ–è€…æ‰¾åˆ°å¤§éƒ¨åˆ† CPU æ—¶é—´èŠ±è´¹åœ¨å“ªé‡Œã€‚ go tool trace æ›´é€‚åˆäºæ‰¾å‡ºç¨‹åºåœ¨ä¸€æ®µæ—¶é—´å†…æ­£åœ¨åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯æ€»ä½“ä¸Šçš„å¼€é”€ã€‚
package main import ( &#34;os&#34; &#34;runtime/trace&#34; ) func main() { f, err := os.Create(&#34;trace.out&#34;) if err != nil { panic(err) } defer f.Close() err = trace.Start(f) if err != nil { panic(err) } defer trace.Stop() ch := make(chan string) go func() { ch <- &#34;hello&#34; }() // read from channel <-ch } ç”Ÿæˆè·Ÿè¸ªæ–‡ä»¶ï¼š"><meta property="og:type" content="article"><meta property="og:url" content="https://shipengqi.github.io/golang-learn/docs/practice/06_trace/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-10-11T15:38:35+08:00"><title>Go Trace | Go Learning</title><link rel=manifest href=/golang-learn/manifest.json><link rel=icon href=/golang-learn/favicon.png><link rel=stylesheet href=/golang-learn/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/golang-learn/flexsearch.min.js></script>
<script defer src=/golang-learn/en.search.min.a9a0c7ebf102ff8cc5b852bb51cebc2548b7397c4262df29bb65cf30db23157f.js integrity="sha256-qaDH6/EC/4zFuFK7Uc68JUi3OXxCYt8pu2XPMNsjFX8=" crossorigin=anonymous></script>
<script defer src=/golang-learn/sw.min.e9a55528e030e44ecbe1b5a8da7dd8fb40bd282d02dc4574e81b999a6a21bc84.js integrity="sha256-6aVVKOAw5E7L4bWo2n3Y+0C9KC0C3EV06BuZmmohvIQ=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/golang-learn/><span>Go Learning</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://shipengqi.github.io/ target=_blank rel=noopener>Blog</a></li><li><a href=https://github.com/shipengqi/golang-learn target=_blank rel=noopener>Github</a></li></ul><ul><li><span>ğŸš è¯­è¨€åŸºç¡€</span><ul><li><a href=/golang-learn/docs/basic/01_basic_type/>åŸºç¡€æ®ç±»å‹</a></li><li><a href=/golang-learn/docs/basic/02_array/>æ•°ç»„</a></li><li><a href=/golang-learn/docs/basic/03_slice/>åˆ‡ç‰‡</a></li><li><a href=/golang-learn/docs/basic/04_map/>map</a></li><li><a href=/golang-learn/docs/basic/05_function/>å‡½æ•°</a></li><li><a href=/golang-learn/docs/basic/06_interface/>æ¥å£</a></li><li><a href=/golang-learn/docs/basic/07_reflect/>åå°„</a></li><li><a href=/golang-learn/docs/basic/08_generic/>æ³›å‹</a></li><li><a href=/golang-learn/docs/basic/09_pointer/>æŒ‡é’ˆ</a></li><li><a href=/golang-learn/docs/basic/10_range/>range</a></li><li><a href=/golang-learn/docs/basic/11_select/>select</a></li><li><a href=/golang-learn/docs/basic/12_defer/>defer</a></li><li><a href=/golang-learn/docs/basic/13_panic/>panic</a></li><li><a href=/golang-learn/docs/basic/14_make_new/>make å’Œ new</a></li><li><a href=/golang-learn/docs/basic/15_oop/>é¢å‘å¯¹è±¡</a></li></ul></li><li><a href=/golang-learn/docs/concurrency/>âš¡ å¹¶å‘ç¼–ç¨‹</a><ul><li><a href=/golang-learn/docs/concurrency/01_mutex/>äº’æ–¥é”</a></li><li><a href=/golang-learn/docs/concurrency/02_rwmutex/>è¯»å†™é”</a></li><li><a href=/golang-learn/docs/concurrency/03_waitgroup/>WaitGroup</a></li><li><a href=/golang-learn/docs/concurrency/04_cond/>æ¡ä»¶å˜é‡</a></li><li><a href=/golang-learn/docs/concurrency/05_once/>Once</a></li><li><a href=/golang-learn/docs/concurrency/06_pool/>Pool</a></li><li><a href=/golang-learn/docs/concurrency/07_context/>Context</a></li><li><a href=/golang-learn/docs/concurrency/08_atomic/>åŸå­æ“ä½œ</a></li><li><a href=/golang-learn/docs/concurrency/09_channel/>Channel</a></li><li><a href=/golang-learn/docs/concurrency/10_sema/>ä¿¡å·é‡</a></li></ul></li><li><span>ğŸ› ï¸ å®è·µ</span><ul><li><a href=/golang-learn/docs/practice/01_build/>Go ç¼–è¯‘</a></li><li><a href=/golang-learn/docs/practice/02_go_race/>Go æ•°æ®ç«äº‰æ£€æµ‹å™¨</a></li><li><a href=/golang-learn/docs/practice/03_test/>Go æµ‹è¯•</a></li><li><a href=/golang-learn/docs/practice/04_pprof/>Go æ€§èƒ½åˆ†æ</a></li><li><a href=/golang-learn/docs/practice/05_performance/>Go æ€§èƒ½ä¼˜åŒ–</a></li><li><a href=/golang-learn/docs/practice/06_trace/ class=active>Go Trace</a></li><li><a href=/golang-learn/docs/practice/07_coredump/>Go CoreDump è°ƒè¯•</a></li><li><a href=/golang-learn/docs/practice/08_mod/>Go Modules</a></li><li><a href=/golang-learn/docs/practice/09_gin/>Gin é™æ€æœåŠ¡å™¨</a></li><li><a href=/golang-learn/docs/practice/10_remote_dev/>Go è¿œç¨‹å¼€å‘è°ƒè¯•</a></li><li><a href=/golang-learn/docs/practice/11_errors/>Go å¸¸è§é”™è¯¯</a></li></ul></li><li><span>ğŸ” åº•å±‚åŸç†</span><ul><li><a href=/golang-learn/docs/advance/01_mm/>å†…å­˜ç®¡ç†</a></li><li><a href=/golang-learn/docs/advance/02_gc/>åƒåœ¾å›æ”¶</a></li><li><a href=/golang-learn/docs/advance/03_scheduler/>è°ƒåº¦å™¨</a></li><li><a href=/golang-learn/docs/advance/04_netpooler/>ç½‘ç»œè½®è¯¢å™¨</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/golang-learn/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Go Trace</strong>
<label for=toc-control><img src=/golang-learn/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#go-trace>Go Trace</a><ul><li><a href=#scheduler-latency-profile>Scheduler latency profile</a></li><li><a href=#goroutine-analysis>Goroutine analysis</a></li><li><a href=#view-trace>View trace</a></li><li><a href=#view-events>View Events</a></li><li><a href=#æ”¶é›†-trace>æ”¶é›† trace</a><ul><li><a href=#è·Ÿè¸ªä¸€ä¸ª-web-åº”ç”¨>è·Ÿè¸ªä¸€ä¸ª web åº”ç”¨</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=go-trace>Go Trace
<a class=anchor href=#go-trace>#</a></h1><p>Go PProf å¾ˆéš¾å®Œæˆ Goroutine çš„åˆ†æã€‚è¿™å°±éœ€è¦ä½¿ç”¨ <code>go tool trace</code> å‘½ä»¤ã€‚</p><p><code>go tool pprof</code> å¯ä»¥è·Ÿè¸ªè¿è¡Œç¼“æ…¢çš„å‡½æ•°ï¼Œæˆ–è€…æ‰¾åˆ°å¤§éƒ¨åˆ† CPU æ—¶é—´èŠ±è´¹åœ¨å“ªé‡Œã€‚
<code>go tool trace</code> æ›´é€‚åˆäºæ‰¾å‡ºç¨‹åºåœ¨ä¸€æ®µæ—¶é—´å†…æ­£åœ¨åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯æ€»ä½“ä¸Šçš„å¼€é”€ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;runtime/trace&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#e6db74>&#34;trace.out&#34;</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// read from channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç”Ÿæˆè·Ÿè¸ªæ–‡ä»¶ï¼š</p><pre tabindex=0><code>go run main.go
</code></pre><p>å¯åŠ¨å¯è§†åŒ–ç•Œé¢ï¼š</p><pre tabindex=0><code>$ go tool trace trace.out
2019/11/18 15:17:28 Parsing trace...
2019/11/18 15:17:28 Splitting trace...
2019/11/18 15:17:28 Opening browser. Trace viewer is listening on http://127.0.0.1:59181
</code></pre><p>æŸ¥çœ‹å¯è§†åŒ–ç•Œé¢ï¼š</p><pre tabindex=0><code>View trace
Goroutine analysis
Network blocking profile (â¬‡)
Synchronization blocking profile (â¬‡)
Syscall blocking profile (â¬‡)
Scheduler latency profile (â¬‡)
User-defined tasks
User-defined regions
Minimum mutator utilization
</code></pre><ul><li>View traceï¼šæœ€å¤æ‚ã€æœ€å¼ºå¤§å’Œäº¤äº’å¼çš„å¯è§†åŒ–æ˜¾ç¤ºäº†æ•´ä¸ªç¨‹åºæ‰§è¡Œçš„æ—¶é—´è½´ã€‚è¿™ä¸ªè§†å›¾æ˜¾ç¤ºäº†åœ¨æ¯ä¸ªè™šæ‹Ÿå¤„ç†å™¨ä¸Šè¿è¡Œç€ä»€ä¹ˆï¼Œ
ä»¥åŠä»€ä¹ˆæ˜¯è¢«é˜»å¡ç­‰å¾…è¿è¡Œçš„ã€‚</li><li>Goroutine analysisï¼šæ˜¾ç¤ºäº†åœ¨æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯ç§ç±»å‹çš„ goroutines æ˜¯å¦‚ä½•åˆ›å»ºçš„ã€‚åœ¨é€‰æ‹©ä¸€ç§ç±»å‹ä¹‹åå°±å¯ä»¥çœ‹åˆ°å…³äºè¿™ç§
ç±»å‹çš„ goroutine çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œåœ¨è¯•å›¾ä» mutex è·å–é”ã€ä»ç½‘ç»œè¯»å–ã€è¿è¡Œç­‰ç­‰æ¯ä¸ª goroutine è¢«é˜»å¡çš„æ—¶é—´ã€‚</li><li>Network blocking profileï¼šç½‘ç»œé˜»å¡æ¦‚å†µ</li><li>Synchronization blocking profileï¼šåŒæ­¥é˜»å¡æ¦‚å†µ</li><li>Syscall blocking profileï¼šç³»ç»Ÿè°ƒç”¨é˜»å¡æ¦‚å†µ</li><li>Scheduler latency profileï¼šä¸ºè°ƒåº¦å™¨çº§åˆ«çš„ä¿¡æ¯æä¾›è®¡æ—¶åŠŸèƒ½ï¼Œæ˜¾ç¤ºè°ƒåº¦åœ¨å“ªé‡Œæœ€è€—è´¹æ—¶é—´ã€‚</li><li>User defined tasksï¼šç”¨æˆ·è‡ªå®šä¹‰ä»»åŠ¡</li><li>User defined regionsï¼šç”¨æˆ·è‡ªå®šä¹‰åŒºåŸŸ</li><li>Minimum mutator utilizationï¼šæœ€ä½ Mutator åˆ©ç”¨ç‡</li></ul><p>Network/Sync/Syscall blocking profile æ˜¯åˆ†æé”ç«äº‰çš„æœ€ä½³é€‰æ‹©ã€‚</p><h2 id=scheduler-latency-profile>Scheduler latency profile
<a class=anchor href=#scheduler-latency-profile>#</a></h2><p>æŸ¥çœ‹é—®é¢˜æ—¶ï¼Œé™¤éæ˜¯å¾ˆæ˜æ˜¾çš„ç°è±¡ï¼Œå¦åˆ™å…ˆæŸ¥çœ‹ â€œScheduler latency profileâ€ï¼Œèƒ½é€šè¿‡ Graph çœ‹åˆ°æ•´ä½“çš„è°ƒç”¨å¼€é”€æƒ…å†µï¼Œå¦‚ä¸‹ï¼š</p><p><img src=../imgs/trace1.png alt=image></p><p>è¿™é‡Œåªæœ‰ä¸¤å—ï¼Œä¸€ä¸ªæ˜¯ <code>trace</code> æœ¬èº«ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ <code>channel</code> çš„æ”¶å‘ã€‚</p><h2 id=goroutine-analysis>Goroutine analysis
<a class=anchor href=#goroutine-analysis>#</a></h2><p>é€šè¿‡ â€œGoroutine analysisâ€ è¿™ä¸ªåŠŸèƒ½çœ‹åˆ°æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªå‡½æ•°å—æœ‰å¤šå°‘ä¸ªæœ‰ Goroutine åœ¨è·‘ï¼Œå¹¶ä¸”è§‚å¯Ÿæ¯ä¸ªçš„ Goroutine çš„è¿è¡Œ
å¼€é”€éƒ½èŠ±è´¹åœ¨å“ªä¸ªé˜¶æ®µã€‚å¦‚ä¸‹ï¼š</p><p><img src=../imgs/trace2.png alt=image></p><p>ä¸Šå›¾æœ‰ 3 ä¸ª goroutineï¼Œåˆ†åˆ«æ˜¯ <code>runtime.main</code>ã€<code>runtime/trace.Start.func1</code>ã€<code>main.main.func1</code>ï¼š</p><p><img src=../imgs/trace3.jpg alt=image></p><p>åŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°å½“å‰ Goroutine åœ¨æ•´ä¸ªè°ƒç”¨è€—æ—¶ä¸­çš„å æ¯”ï¼Œä»¥åŠ GC æ¸…æ‰«å’Œ GC æš‚åœç­‰å¾…çš„ä¸€äº›å¼€é”€ã€‚å¯ä»¥æŠŠå›¾è¡¨ä¸‹è½½ä¸‹æ¥åˆ†æï¼Œç›¸å½“äºæŠŠ
æ•´ä¸ª Goroutine è¿è¡Œæ—¶æ°å¼€æ¥çœ‹äº†ï¼Œè¿™å—èƒ½å¤Ÿå¾ˆå¥½çš„å¸®åŠ©<strong>å¯¹ Goroutine è¿è¡Œé˜¶æ®µåšä¸€ä¸ªçš„å‰–æï¼Œå¯ä»¥å¾—çŸ¥åˆ°åº•æ…¢å“ªï¼Œç„¶åå†å†³å®š
ä¸‹ä¸€æ­¥çš„æ’æŸ¥æ–¹å‘</strong>ã€‚å¦‚ä¸‹ï¼š</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th><th>è€—æ—¶</th></tr></thead><tbody><tr><td>Execution Time</td><td>æ‰§è¡Œæ—¶é—´</td><td>3140ns</td></tr><tr><td>Network Wait Time</td><td>ç½‘ç»œç­‰å¾…æ—¶é—´</td><td>0ns</td></tr><tr><td>Sync Block Time</td><td>åŒæ­¥é˜»å¡æ—¶é—´</td><td>0ns</td></tr><tr><td>Blocking Syscall Time</td><td>è°ƒç”¨é˜»å¡æ—¶é—´</td><td>0ns</td></tr><tr><td>Scheduler Wait Time</td><td>è°ƒåº¦ç­‰å¾…æ—¶é—´</td><td>14ns</td></tr><tr><td>GC Sweeping</td><td>GC æ¸…æ‰«</td><td>0ns</td></tr><tr><td>GC Pause</td><td>GC æš‚åœ</td><td>0ns</td></tr></tbody></table><h2 id=view-trace>View trace
<a class=anchor href=#view-trace>#</a></h2><p><img src=../imgs/trace4.png alt=image></p><ol><li>æ—¶é—´çº¿ï¼šæ˜¾ç¤ºæ‰§è¡Œçš„æ—¶é—´å•å…ƒï¼Œæ ¹æ®æ—¶é—´ç»´åº¦çš„ä¸åŒå¯ä»¥è°ƒæ•´åŒºé—´ï¼Œå…·ä½“å¯æ‰§è¡Œ <code>shift</code> + <code>?</code> æŸ¥çœ‹å¸®åŠ©æ‰‹å†Œã€‚</li><li>å †ï¼šæ˜¾ç¤ºæ‰§è¡ŒæœŸé—´çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾æƒ…å†µã€‚</li><li>åç¨‹ï¼šæ˜¾ç¤ºåœ¨æ‰§è¡ŒæœŸé—´çš„æ¯ä¸ª Goroutine è¿è¡Œé˜¶æ®µæœ‰å¤šå°‘ä¸ªåç¨‹åœ¨è¿è¡Œï¼Œå…¶åŒ…å« GC ç­‰å¾…ï¼ˆGCWaitingï¼‰ã€å¯è¿è¡Œï¼ˆRunnableï¼‰ã€
è¿è¡Œä¸­ï¼ˆRunningï¼‰è¿™ä¸‰ç§çŠ¶æ€ã€‚</li><li>OS çº¿ç¨‹ï¼šæ˜¾ç¤ºåœ¨æ‰§è¡ŒæœŸé—´æœ‰å¤šå°‘ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œå…¶åŒ…å«æ­£åœ¨è°ƒç”¨ Syscallï¼ˆInSyscallï¼‰ã€è¿è¡Œä¸­ï¼ˆRunningï¼‰è¿™ä¸¤ç§çŠ¶æ€ã€‚</li><li>è™šæ‹Ÿå¤„ç†å™¨ï¼šæ¯ä¸ªè™šæ‹Ÿå¤„ç†å™¨æ˜¾ç¤ºä¸€è¡Œï¼Œè™šæ‹Ÿå¤„ç†å™¨çš„æ•°é‡ä¸€èˆ¬é»˜è®¤ä¸ºç³»ç»Ÿå†…æ ¸æ•°ã€‚</li><li>åç¨‹å’Œäº‹ä»¶ï¼šæ˜¾ç¤ºåœ¨æ¯ä¸ªè™šæ‹Ÿå¤„ç†å™¨ä¸Šæœ‰ä»€ä¹ˆ Goroutine æ­£åœ¨è¿è¡Œï¼Œè€Œè¿çº¿è¡Œä¸ºä»£è¡¨äº‹ä»¶å…³è”ã€‚</li></ol><p><img src=../imgs/trace5.jpg alt=image></p><p>ç‚¹å‡»å…·ä½“çš„ Goroutine è¡Œä¸ºåå¯ä»¥çœ‹åˆ°å…¶ç›¸å…³è”çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿™å—å¾ˆç®€å•ï¼Œå¤§å®¶å®é™…æ“ä½œä¸€ä¸‹å°±æ‡‚äº†ã€‚æ–‡å­—è§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li>Startï¼šå¼€å§‹æ—¶é—´</li><li>Wall Durationï¼šæŒç»­æ—¶é—´</li><li>Self Timeï¼šæ‰§è¡Œæ—¶é—´</li><li>Start Stack Traceï¼šå¼€å§‹æ—¶çš„å †æ ˆä¿¡æ¯</li><li>End Stack Traceï¼šç»“æŸæ—¶çš„å †æ ˆä¿¡æ¯</li><li>Incoming flowï¼šè¾“å…¥æµ</li><li>Outgoing flowï¼šè¾“å‡ºæµ</li><li>Preceding eventsï¼šä¹‹å‰çš„äº‹ä»¶</li><li>Following eventsï¼šä¹‹åçš„äº‹ä»¶</li><li>All connectedï¼šæ‰€æœ‰è¿æ¥çš„äº‹ä»¶</li></ul><h2 id=view-events>View Events
<a class=anchor href=#view-events>#</a></h2><p>å¯ä»¥é€šè¿‡ç‚¹å‡» View Options-Flow eventsã€Following events ç­‰æ–¹å¼ï¼ŒæŸ¥çœ‹åº”ç”¨è¿è¡Œä¸­çš„äº‹ä»¶æµæƒ…å†µã€‚å¦‚ä¸‹ï¼š</p><p><img src=../imgs/trace6.png alt=image></p><p>é€šè¿‡åˆ†æå›¾ä¸Šçš„äº‹ä»¶æµï¼Œå¯å¾—çŸ¥è¿™ç¨‹åºä» <code>G1 runtime.main</code> å¼€å§‹è¿è¡Œï¼Œåœ¨è¿è¡Œæ—¶åˆ›å»ºäº† 2 ä¸ª Goroutineï¼Œ
å…ˆæ˜¯åˆ›å»º <code>G18 runtime/trace.Start.func1</code>ï¼Œç„¶åå†æ˜¯ <code>G19 main.main.func1</code> ã€‚è€ŒåŒæ—¶å¯ä»¥é€šè¿‡å…¶ Goroutine Name å»äº†è§£
å®ƒçš„è°ƒç”¨ç±»å‹ï¼Œå¦‚ï¼š<code>runtime/trace.Start.func1</code> å°±æ˜¯ç¨‹åºä¸­åœ¨ <code>main.main</code> è°ƒç”¨äº† <code>runtime/trace.Start</code> æ–¹æ³•ï¼Œç„¶åè¯¥æ–¹æ³•åˆåˆ©ç”¨
åç¨‹åˆ›å»ºäº†ä¸€ä¸ªé—­åŒ… <code>func1</code> å»è¿›è¡Œè°ƒç”¨ã€‚</p><p><img src=../imgs/trace7.png alt=image></p><p>ç»“åˆå¼€å¤´çš„ä»£ç å»çœ‹çš„è¯ï¼Œå¾ˆæ˜æ˜¾å°±æ˜¯ <code>ch</code> çš„è¾“å…¥è¾“å‡ºçš„è¿‡ç¨‹äº†ã€‚</p><h2 id=æ”¶é›†-trace>æ”¶é›† trace
<a class=anchor href=#%e6%94%b6%e9%9b%86-trace>#</a></h2><ol><li>ä½¿ç”¨ <code>runtime/trace</code> åŒ…</li></ol><p>è°ƒç”¨ <code>trace.Start</code> å’Œ <code>trace.Stop</code>ã€‚</p><ol start=2><li>ä½¿ç”¨ <code>-trace=&lt;file></code> æµ‹è¯•æ ‡å¿—</li></ol><p>ç”¨æ¥æ”¶é›†å…³äºè¢«æµ‹è¯•ä»£ç çš„ trace æ—¶æ¯”è¾ƒæœ‰ç”¨ã€‚</p><ol start=3><li>ä½¿ç”¨ <code>debug/pprof/trace</code> handler</li></ol><p>ç”¨æ¥æ”¶é›†è¿è¡Œä¸­çš„ web åº”ç”¨çš„ traceã€‚</p><h3 id=è·Ÿè¸ªä¸€ä¸ª-web-åº”ç”¨>è·Ÿè¸ªä¸€ä¸ª web åº”ç”¨
<a class=anchor href=#%e8%b7%9f%e8%b8%aa%e4%b8%80%e4%b8%aa-web-%e5%ba%94%e7%94%a8>#</a></h3><p>å¦‚æœæ—©å·²åŸ‹å¥½ <code>_ "net/http/pprof"</code> è¿™ä¸ªå·¥å…·ï¼Œå°±å¯ä»¥æ‰§è¡Œï¼š</p><ul><li><code>curl http://127.0.0.1:6060/debug/pprof/trace\?seconds\=20 > trace.out</code></li><li><code>go tool trace trace.out</code></li></ul><h4 id=view-trace-1>View trace
<a class=anchor href=#view-trace-1>#</a></h4><p>ç‚¹å¼€äº† View trace ç•Œé¢ï¼š</p><p><img src=../imgs/trace8.jpg alt=image></p><p>åœ¨åˆé€‚çš„åŒºåŸŸæ‰§è¡Œå¿«æ·é”® <code>W</code> ä¸æ–­åœ°æ”¾å¤§æ—¶é—´çº¿ï¼Œå¦‚ä¸‹ï¼š</p><p><img src=../imgs/trace9.jpg alt=image></p><p>åˆæ­¥æ’æŸ¥ï¼Œç»å¤§éƒ¨åˆ†çš„ G éƒ½å’Œ <code>google.golang.org/grpc.(*Server).Serve.func</code> æœ‰å…³ï¼Œå…³è”çš„ä¸€å¤§ä¸²ä¹Ÿæ˜¯ <code>Serve</code> æ‰€è§¦å‘çš„ç›¸å…³åŠ¨ä½œã€‚</p><p><img src=../imgs/trace10.jpg alt=image></p><p>ç»§ç»­è¿½è¸ª View trace æ·±å…¥è¿›å»ï¼Œâ€œNetwork blocking profileâ€ å’Œ â€œSyscall blocking profileâ€ æ‰€æä¾›çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š</p><h4 id=network-blocking-profile>Network blocking profile
<a class=anchor href=#network-blocking-profile>#</a></h4><p><img src=../imgs/trace11.jpg alt=image></p><h4 id=syscall-blocking-profile>Syscall blocking profile
<a class=anchor href=#syscall-blocking-profile>#</a></h4><p><img src=../imgs/trace12.jpg alt=image></p><p>é€šè¿‡å¯¹ä»¥ä¸Šä¸‰é¡¹çš„è·Ÿè¸ªåˆ†æï¼ŒåŠ ä¸Šè¿™ä¸ªæ³„éœ²ï¼Œè¿™ä¸ªé˜»å¡çš„è€—æ—¶ï¼Œè¿™ä¸ªæ¶‰åŠçš„å†…éƒ¨æ–¹æ³•åï¼Œå¾ˆæ˜æ˜¾å°±æ˜¯å¿˜è®°å…³é—­å®¢æˆ·ç«¯è¿æ¥äº†ã€‚</p><p>ä¸å»ºè®®å°† pprof handlers æš´éœ²ç»™ Internetï¼Œå‚è€ƒ <a href=https://mmcloughlin.com/posts/your-pprof-is-showing>https://mmcloughlin.com/posts/your-pprof-is-showing</a>ã€‚</p><p><strong>å†…å®¹æ¥è‡ª</strong> <a href=https://github.com/EDDYCJY/blog/blob/7b021d0dee/tools/go-tool-trace.md>Go å¤§æ€å™¨ä¹‹è·Ÿè¸ªå‰–æ trace</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/commit/dedeb749b420ef5a794bb6cd78a203c768c176c7 title='Last modified by shipengqi | October 11, 2023' target=_blank rel=noopener><img src=/golang-learn/svg/calendar.svg class=book-icon alt=Calendar>
<span>October 11, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/shipengqi/golang-learn/edit/master/content/docs/practice/06_trace.md target=_blank rel=noopener><img src=/golang-learn/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#go-trace>Go Trace</a><ul><li><a href=#scheduler-latency-profile>Scheduler latency profile</a></li><li><a href=#goroutine-analysis>Goroutine analysis</a></li><li><a href=#view-trace>View trace</a></li><li><a href=#view-events>View Events</a></li><li><a href=#æ”¶é›†-trace>æ”¶é›† trace</a><ul><li><a href=#è·Ÿè¸ªä¸€ä¸ª-web-åº”ç”¨>è·Ÿè¸ªä¸€ä¸ª web åº”ç”¨</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>